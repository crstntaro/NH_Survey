<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kazu Café Survey — Nippon Hasha</title>

  <!-- Montserrat -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --font:"Montserrat",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;

      /* Kazu Café brand — FRESH GREEN */
      --accent:#2f9e6e;
      --accent-dk:#247a56;

      /* Shared tokens */
      --ink:#101010; --muted:#6b7280;
      --line:#e5e7eb; --bg:#faf6ef; --surface:#ffffff;
      --header-h:72px;

      /* animated seigaiha strengths */
      --sea1:.12; --sea2:.05;

      /* Optional décor (swap assets if you have them) */
      --hero-decor-right:url('kazu-chirasi.png');
      --hero-decor-left:url('kazu-salmon.png');
      --stage-decor:url('kazu-stage.png');

      --ease:cubic-bezier(.22,.61,.36,1);
      --dur:.26s;
    }

    *{ box-sizing:border-box }
    html,body{ min-height:100% }
    body{
      margin:0; font-family:var(--font); color:var(--ink); background:var(--bg);
      line-height:1.6; overflow-x:hidden; opacity:0; transform:translateY(8px); animation:fadeIn .45s ease forwards;
    }
    @keyframes fadeIn{ to{ opacity:1; transform:none} }

    /* ===== Animated background (same recipe) ===== */
    .bg{ position:fixed; inset:0; z-index:-3;
      background: radial-gradient(1200px 360px at 50% -120px, rgba(47,158,110,.14), transparent 65%), var(--bg);
    }
    .bg::before, .bg::after{
      content:""; position:absolute; inset:0; pointer-events:none;
      background-repeat:repeat; background-size:400px 200px; animation: float 34s linear infinite;
    }
    .bg::before{
      opacity:var(--sea1);
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="150" viewBox="0 0 300 150"><defs><pattern id="s" width="50" height="25" patternUnits="userSpaceOnUse"><path d="M0 25a25 25 0 0 1 50 0" fill="none" stroke="%232f9e6e" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23s)"/></svg>');
    }
    .bg::after{
      opacity:var(--sea2); animation-duration:48s; animation-direction:reverse; transform:translateY(10px);
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="150" viewBox="0 0 300 150"><defs><pattern id="s" width="50" height="25" patternUnits="userSpaceOnUse"><path d="M0 25a25 25 0 0 1 50 0" fill="none" stroke="%23101010" stroke-width=".9" opacity=".25"/><path d="M12.5 25a12.5 12.5 0 0 1 25 0" fill="none" stroke="%23101010" stroke-width=".6" opacity=".18"/></pattern></defs><rect width="100%" height="100%" fill="url(%23s)"/></svg>');
    }
    @keyframes float{ from{ background-position:0 0 } to{ background-position:400px 0 } }

    /* ===== Header (1:1) ===== */
    .site-header{
      position:sticky; top:0; height:var(--header-h);
      display:flex; align-items:center; z-index:10;
      backdrop-filter:saturate(180%) blur(6px);
      background:color-mix(in oklab, var(--surface) 88%, transparent);
      border-bottom:1px solid var(--line);
    }
    .nav{ max-width:1200px; margin:0 auto; padding:0 16px; width:100%;
      display:flex; justify-content:space-between; align-items:center; height:100% }
    .brand-left{ display:flex; align-items:center; gap:10px }
    .brand-img{ height:34px; width:auto; display:block }
    .brand-right{ display:flex; flex-direction:column; align-items:flex-end; line-height:1.1; text-align:right }
    .brand-name{ font:800 16px/1 var(--font) }
    .brand-sub{ font:700 11px/1 var(--font); color:var(--muted); letter-spacing:.06em; text-transform:uppercase }

    /* ===== HERO ===== */
    .hero{
      position:relative;
      min-height:calc(100dvh - var(--header-h));
      display:grid; place-items:center; padding:28px; text-align:center; overflow:hidden;
    }
    .wrap{ max-width:960px; margin:0 auto }

    .hero::before,
    .hero::after{
      content:""; position:fixed; bottom:-60px; width:min(520px,70vw); aspect-ratio:1;
      filter:blur(1px) drop-shadow(0 18px 36px rgba(0,0,0,.12));
      opacity:.22; pointer-events:none; z-index:-1;
      background-position:center; background-repeat:no-repeat; background-size:contain;
      transform:translateZ(0);
    }
    .hero::before{
      left:-80px;
      background-image:var(--hero-decor-left);
      transform:rotate(6deg) translateZ(0);
    }
    .hero::after{
      right:-60px; width:min(520px,70vw);
      background-image:var(--hero-decor-right);
      transform:rotate(-6deg) translateZ(0);
    }

    .hero-logo{
      display:inline-block; margin:0 auto 10px;
      transform:translateY(8px) scale(.98); opacity:0;
      animation: logoIn .6s var(--ease) .05s forwards;
    }
    .hero-logo img{ width:min(540px,78vw); height:auto; display:block; filter:drop-shadow(0 14px 24px rgba(0,0,0,.12)) }
    @keyframes logoIn{ to{ transform:none; opacity:1 } }

    h1{ margin:8px 0 4px; font:800 clamp(28px,5vw,44px)/1.1 var(--font); letter-spacing:-.2px; opacity:0; transform:translateY(8px); animation: rise .5s ease .12s forwards }
    .subtitle{ font:700 clamp(13px,2.6vw,16px)/1.2 var(--font); color:var(--muted); opacity:0; transform:translateY(8px); animation: rise .5s ease .18s forwards }
    .accent-underline{
      width:0; height:3px; margin:10px auto 0;
      background:linear-gradient(90deg, transparent 0%, var(--accent) 15%, var(--accent-dk) 85%, transparent 100%);
      border-radius:999px; opacity:.9; animation: underline .7s ease .18s forwards;
    }
    @keyframes underline{ to{ width:180px } }
    @keyframes rise{ to{ opacity:1; transform:none } }
    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.9; }
      100% { transform: scale(1); opacity: 1; }
    }

    .strap-hero{
      display:inline-flex; gap:10px; align-items:center; margin:14px 0 22px; color:var(--accent);
      font-weight:800; font-size:12px; letter-spacing:.12em; text-transform:uppercase; padding:8px 16px;
      border:1px solid color-mix(in srgb, var(--accent) 35%, transparent);
      border-radius:999px; background:color-mix(in srgb, var(--accent) 8%, transparent);
    }
    .lead{ color:#4b5563; font-size:clamp(15px,2.4vw,18px); max-width:650px; margin:0 auto 22px }
    .cta{
      display:inline-flex; align-items:center; gap:12px; padding:14px 28px; border-radius:16px;
      font:800 16px/1 var(--font); color:#fff; text-decoration:none; letter-spacing:.2px;
      background: var(--accent); border:1px solid rgba(0,0,0,.08);
      box-shadow:0 16px 32px color-mix(in srgb,var(--accent) 28%, transparent);
      transition:transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .cta:hover{ transform:translateY(-2px); box-shadow:0 20px 40px color-mix(in srgb, var(--accent) 36%, transparent) }

    /* ===== SURVEY VIEWPORT ===== */
    .viewport{
      position:relative;
      min-height:calc(100dvh - var(--header-h));
      display:none; align-items:center; justify-content:center;
      padding:20px 16px; overflow:hidden;
    }

    /* Subtle stage décor */
    .viewport::before,
    .viewport::after{
      content:""; position:absolute; pointer-events:none; z-index:-1;
      background: var(--stage-decor) center/contain no-repeat;
      opacity:.10; filter:blur(.5px) saturate(1.02);
      transform: translateZ(0);
    }
    .viewport::before{ left:-40px; top:-20px; width:min(320px, 38vw); aspect-ratio:1; transform: rotate(-12deg) }
    .viewport::after { right:-24px; bottom:-10px; width:min(260px, 30vw); aspect-ratio:1; transform: rotate(10deg) }

    @media (prefers-reduced-motion: reduce){
      .bg::before, .bg::after{ animation:none }
    }

    .card{
      width:min(760px,100%);
      background:var(--surface); border:1px solid var(--line); border-radius:20px;
      box-shadow:0 16px 48px rgba(0,0,0,.08); padding:14px; position:relative; overflow:hidden;
    }

    .progress{ display:none }

    .step-meta{
      display:flex; align-items:center; gap:8px 12px; justify-content:center; margin-bottom:12px; flex-wrap:wrap;
    }
    .step-chip{font:800 12px var(--font); color:#0f4b49; padding:6px 12px; border-radius:999px; background:#e8fffb; border:1px solid #b8f3e8; letter-spacing:.08em; text-transform:uppercase}
    .step-mini{flex:1; max-width:200px; height:8px; background:#dffcf7; border-radius:999px; overflow:hidden}
    .step-mini div{height:100%; width:0; background:linear-gradient(90deg,var(--accent),var(--accent-dk)); transition:width .25s var(--ease)}
    .step-hdr{ display:flex; align-items:center; justify-content:center; margin-bottom:8px; text-align:center; min-height: 90px; }
    .step-title{ font:800 clamp(18px,2.8vw,22px)/1.25 var(--font); max-width:680px }

    .branch-chip{
      display:inline-flex; align-items:center; gap:6px; justify-content:center;
      padding:6px 12px; border-radius:999px; margin:0;
      font:700 12px/1.1 var(--font); color:#0f5132;
      background:color-mix(in srgb,var(--accent) 12%, #fff8e6);
      border:1px solid color-mix(in srgb,var(--accent) 28%, transparent);
      box-shadow:0 6px 14px rgba(0,0,0,.04);
      width:fit-content; min-height:32px;
    }
    .branch-chip.warn{ color:#92400e; background:#fff7ed; border-color:#fdba74; box-shadow:none }

    /* Stage auto-sizes; allow overflow only when dropdown open */
    .stage{
      position:relative; overflow:hidden; background:var(--surface);
      height:auto; transition:height var(--dur) var(--ease);
    }
    .stage.dropdown-open{ overflow:visible; }

    .step{
      position:absolute; inset:0; padding:10px 0 0;
      opacity:0; pointer-events:none;
      transform:translateX(12px);
      overflow:auto; -webkit-overflow-scrolling: touch;
    }
    /* ✅ Let Q16’s dropdown overflow so the full list is visible */
    .step[data-qid="16"]{ overflow:visible; }

    .step.active{
      opacity:1; transform:none; pointer-events:auto; z-index:2;
      transition:opacity var(--dur) var(--ease), transform var(--dur) var(--ease);
      position:relative; /* active participates in height */
    }
    .step.exiting-left, .step.exiting-right{
      opacity:0; pointer-events:none; z-index:3;
      transition:opacity var(--dur) var(--ease), transform var(--dur) var(--ease);
    }
    .step.exiting-left{ transform:translateX(-12px) }
    .step.exiting-right{ transform:translateX(12px) }
    .step.entering-left{ transform:translateX(-12px) }
    .step.entering-right{ transform:translateX(12px) }
    .step.entering-left.active, .step.entering-right.active{ opacity:1; transform:none }

    /* Equal-size pill buttons */
    .row{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap:10px;
      justify-items:stretch;
      margin-top:8px;
      width:min(100%, 680px);
      margin-inline:auto;
    }
    .pill{
      appearance:none; border:1px solid var(--line); background:var(--surface); color:var(--ink);
      padding:0 14px; border-radius:12px; font:800 14px var(--font); cursor:pointer;
      min-height:64px; display:grid; place-items:center; text-align:center;
      transition:transform .12s var(--ease), box-shadow .12s var(--ease), background .12s var(--ease), border-color .12s var(--ease);
    }
    .pill:hover{ transform:translateY(-1px) }
    .pill[aria-pressed="true"]{ background:var(--accent); border-color:var(--accent); color:#fff; box-shadow:0 10px 18px color-mix(in srgb,var(--accent) 38%, transparent) }
    .pill-clear{appearance:none;border:none;background:transparent;color:var(--accent);font:800 14px/1 var(--font);padding:0;margin:6px auto 0;display:inline-flex;justify-content:flex-start;width:min(100%,680px);text-decoration:underline;cursor:pointer}
    .pill-clear:hover{color:var(--accent-dk)}
    .pill-clear:focus-visible{outline:2px solid color-mix(in srgb,var(--accent) 40%, transparent);outline-offset:2px}

    textarea,input[type="text"]{
      width:min(100%, 680px); padding:12px 14px; border:1px solid var(--line); border-radius:12px; background:var(--surface); color:var(--ink); font:600 14px var(--font); margin:6px auto 0; display:block;
    }
    textarea{ min-height:90px; resize:vertical }

    /* Typeahead */
    .typeahead{ position:relative; width:min(100%,680px); margin:0 auto }
    .ta-list{
      position:absolute; left:0; right:0; top:calc(100% + 4px);
      background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.08);
      max-height:320px; overflow:auto; z-index:1200; display:none;
    }
    .ta-item{ padding:10px 12px; cursor:pointer; font-size:14px }
    .ta-item:hover, .ta-item.active{ background:color-mix(in srgb, var(--accent) 16%, #e8fbf2); color:#0d4d35 }

    .slider-shell{
      width:100%; max-width:640px; border-radius:28px; background:#fff;
      box-shadow:0 24px 60px color-mix(in srgb, var(--accent) 18%, transparent);
      border:1px solid color-mix(in srgb, var(--accent) 16%, transparent);
      padding:28px 24px 32px; display:grid; gap:18px; justify-items:center; margin:8px auto 0;
    }
    .slider-shell-rating .slider-score{font:800 clamp(44px,9vw,56px)/1 var(--font); color:var(--accent)}
    .slider-shell-rating .slider-score-label{display:none;font:700 12px/1.2 var(--font);color:var(--muted);margin-top:6px;text-transform:uppercase;letter-spacing:.05em}
    .slider-shell-nps .slider-score{font:800 clamp(44px,9vw,56px)/1 var(--font); color:#0f172a}
    .slider-track{position:relative;width:100%;max-width:840px;margin:0 auto;padding:0 6px 14px;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none}
    .slider-lane{position:relative;width:100%;height:14px;border-radius:999px;background:linear-gradient(90deg,color-mix(in srgb,var(--accent) 20%, #fff) 0%,color-mix(in srgb,var(--accent) 6%, #fff) 100%);box-shadow:inset 0 1px 0 rgba(255,255,255,.55),0 6px 18px color-mix(in srgb,var(--accent) 14%, transparent)}
    .slider-fill{position:absolute;left:0;top:0;bottom:0;width:0;border-radius:inherit;background:linear-gradient(90deg,var(--accent) 0%,color-mix(in srgb,var(--accent) 45%, #fff) 100%);transition:width .22s var(--ease)}
    .slider-thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:var(--thumb-size,clamp(56px,14vw,78px));height:var(--thumb-size,clamp(56px,14vw,78px));display:grid;place-items:center;pointer-events:none}
    .slider-thumb img{width:100%;height:100%;object-fit:contain;filter:drop-shadow(0 18px 36px color-mix(in srgb,var(--accent) 40%, transparent));pointer-events:none;-webkit-tap-highlight-color:transparent;-webkit-user-select:none;user-select:none;-webkit-user-drag:none}
    .slider-track input[type="range"]{position:absolute;top:-28px;bottom:-24px;left:0;right:0;width:100%;height:auto;opacity:0;cursor:pointer;touch-action:pan-y;-webkit-appearance:none;appearance:none;outline:none;-webkit-tap-highlight-color:transparent}
    .slider-ticks{width:100%;display:flex;justify-content:space-between;gap:6px;padding:0 26px;font:700 11px/1.2 var(--font);color:#6b7b8f;text-transform:none;letter-spacing:.08em;max-width:800px;margin:0 auto}
    .slider-ticks span{position:relative;display:grid;justify-items:center;gap:4px;padding-top:10px;white-space:nowrap;text-align:center;transition:color .18s var(--ease)}
    .slider-ticks span::before{content:"";position:absolute;top:0;left:50%;transform:translateX(-50%);width:2px;height:8px;border-radius:999px;background:#d8eef0;transition:background .18s var(--ease),height .18s var(--ease)}
    .slider-ticks span.active{color:var(--accent)}
    .slider-ticks span.active::before{background:var(--accent);height:12px}
    .slider-followup{display:none;width:100%;max-width:640px;margin:12px auto 0;text-align:left}
    .slider-followup label{display:block;font:700 13px/1.4 var(--font);margin-bottom:6px;color:#102739;letter-spacing:.04em;text-transform:uppercase}
    .slider-followup textarea{width:100%;min-height:96px;resize:vertical;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;font:500 14px/1.5 var(--font);color:var(--ink);box-shadow:0 12px 32px rgba(16,39,57,.08)}



    .actions{ display:flex; gap:10px; align-items:center; margin-top:10px; padding-top:10px; border-top:1px dashed var(--line); justify-content:center }
    .btn{ display:inline-block; padding:12px 18px; border-radius:12px; font:800 14px/1 var(--font); color:#fff; background:var(--accent); border:1px solid rgba(0,0,0,.08); cursor:pointer; box-shadow:0 10px 18px color-mix(in srgb,var(--accent) 38%, transparent) }
    .btn.alt{ background:color-mix(in srgb, var(--accent) 12%, #e8fbf2); color:#0d4d35; box-shadow:none }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; box-shadow:none; filter:grayscale(.35) }

    .state{ color:#0b5d3f; font-size:12px; text-align:center; margin-top:6px; min-height:1em }

    .restaurant-list{display:grid;gap:12px;width:min(100%,680px);margin:8px auto 0}
    .restaurant-item{display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:16px;border:1px solid var(--line);background:color-mix(in srgb,var(--accent) 6%, #fff);box-shadow:0 12px 24px color-mix(in srgb,var(--accent) 12%, transparent);transition:border-color .18s var(--ease), box-shadow .18s var(--ease)}
    .restaurant-item span{flex:0 0 32px;height:32px;border-radius:999px;background:color-mix(in srgb,var(--accent) 14%, #fff);color:var(--accent);display:grid;place-items:center;font:700 14px/1 var(--font)}
    .restaurant-item input{flex:1;border:none;background:transparent;font:600 14px var(--font);color:var(--ink);padding:0}
    .restaurant-item input::placeholder{color:var(--muted)}
    .restaurant-item input:focus{outline:none}
    @media (max-width:640px){
      .slider-shell{padding-inline:4px}
      .slider-track{padding:0 0 18px}
      .slider-thumb{--thumb-size:clamp(68px,18vw,86px)}
      .slider-ticks{gap:2px;font-size:10px}
      .slider-ticks span{padding-top:6px}
      .slider-shell-rating .slider-score-label{display:block}
    }

    .restaurant-item:focus-within{border-color:var(--accent);box-shadow:0 0 0 2px color-mix(in srgb,var(--accent) 28%, transparent),0 12px 24px color-mix(in srgb,var(--accent) 12%, transparent)}
  </style>
</head>
<body>
  <!-- ambient pattern -->
  <div class="bg" aria-hidden="true"></div>

  <!-- Header -->
  <header class="site-header">
    <nav class="nav">
      <div class="brand-left">
        <img class="brand-img" src="kazunorilogo.png" alt="Kazu Café">
      </div>
      <div class="brand-right">
        <div class="brand-name">KAZUNORI</div>
        <div class="brand-sub">Customer Survey</div>
      </div>
    </nav>
  </header>

  <!-- HERO -->
  <section class="hero" id="hero">
    <div class="wrap">
      <div class="hero-logo">
        <img src="kazunorilogo.png" alt="Kazu Café">
      </div>

      <div class="subtitle">A Nippon Hasha Brand</div>
      <div class="accent-underline" aria-hidden="true"></div>

      <div class="strap-hero">Customer Survey</div>
      <p class="lead">We’d love to hear about your café experience. Share your thoughts and receive a little thank-you on your next visit.</p>

      <a href="#start" id="startBtn" class="cta">Start Survey →</a>
    </div>
  </section>

  <!-- SURVEY -->
  <main class="viewport" id="viewport">
    <div class="card" role="region" aria-label="Survey">
      <div class="progress" aria-hidden="true"><div id="bar" class="bar"></div></div>
      <div class="step-meta" aria-live="polite">
        <span id="stepChip" class="step-chip">Question 1 of 1</span>
        <div class="step-mini"><div id="stepMiniBar"></div></div>
      </div>
      <div class="step-hdr"><div id="stepTitle" class="step-title">1) Was this your first time at this restaurant's branch?</div></div>

      <form id="surveyForm" novalidate>
        <input type="hidden" name="q1" id="branchField">
        <div class="stage" id="stage">
          <section class="step active" data-qid="2" data-required="true" data-title="2) Was this your first time at this restaurant's branch?">
            <div class="row">
              <button type="button" class="pill" data-name="q2" data-value="Yes">Yes</button>
              <button type="button" class="pill" data-name="q2" data-value="No">No</button>
              <input type="hidden" name="q2" required>
            </div>
          </section>

          <section class="step" data-qid="3" data-required="true" data-title="3) How often do you visit us?">
            <div class="row">
              <button type="button" class="pill" data-name="q4" data-value="More than a week">More than a week</button>
              <button type="button" class="pill" data-name="q4" data-value="Once a week">Once a week</button>
              <button type="button" class="pill" data-name="q4" data-value="Twice a month">Twice a month</button>
              <button type="button" class="pill" data-name="q4" data-value="Once a month">Once a month</button>
              <button type="button" class="pill" data-name="q4" data-value="Not regularly">Not regularly</button>
              <button type="button" class="pill" data-name="q4" data-value="Not applicable">Not applicable</button>
              <input type="hidden" name="q4" required>
            </div>
          </section>

          <section class="step" data-qid="4" data-required="true" data-title="4) Did you Dine-in or Take-out during your visit?">
            <div class="row">
              <button type="button" class="pill" data-name="q3" data-value="Dine-in">Dine-in</button>
              <button type="button" class="pill" data-name="q3" data-value="Take-out">Take-out</button>
              <input type="hidden" name="q3" required>
            </div>
          </section>

          <section class="step" data-qid="5" data-title="5) Do you have any dietary restrictions or preferences we should be aware of? (Select all that apply)">
            <div class="row" id="q13Row">
              <button type="button" class="pill" data-name="q13" data-value="No Meat">No Meat</button>
              <button type="button" class="pill" data-name="q13" data-value="No Nuts">No Nuts</button>
              <button type="button" class="pill" data-name="q13" data-value="No Pork">No Pork</button>
              <button type="button" class="pill" data-name="q13" data-value="No Chicken">No Chicken</button>
              <button type="button" class="pill" data-name="q13" data-value="No Shrimp">No Shrimp</button>
              <button type="button" class="pill" data-name="q13" data-value="Not applicable">Not applicable</button>
              <button type="button" class="pill" data-name="q13" data-value="__other" id="q13OtherBtn">Other</button>
              <input type="hidden" name="q13">
            </div>
            <button type="button" class="pill-clear" id="q13Clear">Clear selections</button>
            <input id="q13OtherTxt" type="text" placeholder="Please specify…" style="display:none;margin-top:8px">
            <div class="hint" style="text-align:center;margin-top:6px">We’ll use this to improve menu options and suggestions.</div>
          </section>

          <section class="step" data-qid="6" data-title="6) What were the last five restaurants you've visited?">
            <div class="restaurant-list">
              <label class="restaurant-item">
                <span>1</span>
                <input name="q17_1" placeholder="Restaurant 1" aria-label="Restaurant 1">
              </label>
              <label class="restaurant-item">
                <span>2</span>
                <input name="q17_2" placeholder="Restaurant 2" aria-label="Restaurant 2">
              </label>
              <label class="restaurant-item">
                <span>3</span>
                <input name="q17_3" placeholder="Restaurant 3" aria-label="Restaurant 3">
              </label>
              <label class="restaurant-item">
                <span>4</span>
                <input name="q17_4" placeholder="Restaurant 4" aria-label="Restaurant 4">
              </label>
              <label class="restaurant-item">
                <span>5</span>
                <input name="q17_5" placeholder="Restaurant 5" aria-label="Restaurant 5">
              </label>
            </div>
          </section>

          <section class="step" data-qid="7" data-title="7) What did you like most about your visit to any of these restaurants?">
            <textarea name="q18" placeholder="Tell us about the food, service, ambiance, presentation, or staff…"></textarea>
          </section>

          <section class="step" data-qid="8" data-required="true" data-title="8) How would you describe your overall customer experience?">
            <div class="slider-shell slider-shell-rating" data-slider-type="rating" data-slider-input="q5" data-slider-labels="Low,Low,Low,Low,Decent,Decent,Decent,Decent,Awesome,Awesome" data-slider-default="1">
              <div class="slider-score" id="q5Score">1</div>
              <div class="slider-score-label" id="q5ScoreLabel">Low</div>
              <div class="slider-track">
                <div class="slider-lane">
                  <div class="slider-fill"></div>
                  <div class="slider-thumb"><img src="ramenbowl.png" alt="Ramen bowl"></div>
                </div>
                <input id="q5Scale" class="ramen-range" type="range" min="1" max="10" step="1" value="1" aria-label="Overall experience rating">
              </div>
              <div class="slider-ticks"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span></div>
            </div>
            <div class="slider-followup" id="q5Follow" data-low-max="6" data-high-min="9" data-low-label="What could we improve to enhance your overall experience?" data-low-placeholder="Share any issues we should address…" data-high-label="Amazing! What made your visit special?" data-high-placeholder="Tell us the highlights of your visit…" data-neutral-display="show" data-neutral-label="Got it. Anything else we should know about your visit?" data-neutral-placeholder="Add any quick notes or shoutouts you want to share…">
              <label for="q5FollowText" id="q5FollowLabel">Tell us more about your experience</label>
              <textarea id="q5FollowText" name="q5_follow" placeholder=""></textarea>
            </div>
            <input type="hidden" name="q5" required>
          </section>

          <section class="step" data-qid="9" data-required="true" data-title="9) How would you rate the value you received for your money?">
            <div class="slider-shell slider-shell-rating" data-slider-type="rating" data-slider-input="q6" data-slider-labels="Needs work,Needs work,Needs work,Needs work,Fair,Fair,Fair,Fair,Excellent,Excellent" data-slider-default="1">
              <div class="slider-score" id="q6Score">1</div>
              <div class="slider-score-label" id="q6ScoreLabel">Needs work</div>
              <div class="slider-track">
                <div class="slider-lane">
                  <div class="slider-fill"></div>
                  <div class="slider-thumb"><img src="ramenbowl.png" alt="Ramen bowl"></div>
                </div>
                <input id="q6Range" class="ramen-range" type="range" min="1" max="10" step="1" value="1" aria-label="Value for money rating">
              </div>
              <div class="slider-ticks"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span></div>
            </div>
            <div class="slider-followup" id="q6Follow" data-low-max="6" data-high-min="9" data-low-label="What made the visit feel like it wasn’t worth the price?" data-low-placeholder="Tell us what felt overpriced or lacking…" data-high-label="Awesome! What made the visit worth every peso?" data-high-placeholder="Share the details that made it a great value…" data-neutral-display="show" data-neutral-label="Any ideas to help us deliver even better value?" data-neutral-placeholder="Tell us what would make the price feel perfect…">
              <label for="q6FollowText" id="q6FollowLabel">Tell us more about the value you received</label>
              <textarea id="q6FollowText" name="q6_follow" placeholder=""></textarea>
            </div>
            <input type="hidden" name="q6" required>
          </section>

          <section class="step" data-qid="10" data-required="true" data-title="10) How would you rate the overall quality of the food served? (tastes, freshness, appearance)">
            <div class="slider-shell slider-shell-rating" data-slider-type="rating" data-slider-input="q7" data-slider-labels="Low,Low,Low,Low,Decent,Decent,Decent,Decent,Awesome,Awesome" data-slider-default="1">
              <div class="slider-score" id="q7Score">1</div>
              <div class="slider-score-label" id="q7ScoreLabel">Low</div>
              <div class="slider-track">
                <div class="slider-lane">
                  <div class="slider-fill"></div>
                  <div class="slider-thumb"><img src="ramenbowl.png" alt="Ramen bowl"></div>
                </div>
                <input id="q7Range" class="ramen-range" type="range" min="1" max="10" step="1" value="1" aria-label="Food quality rating">
              </div>
              <div class="slider-ticks"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span></div>
            </div>
            <div class="slider-followup" id="q7Follow" data-low-max="6" data-high-min="9" data-low-label="What was wrong with the food?" data-low-placeholder="Tell us what didn’t work for you…" data-high-label="Awesome! What did you love most about the food?" data-high-placeholder="Share the highlights of your meal…" data-neutral-display="show" data-neutral-label="How could the food be better next time?" data-neutral-placeholder="Share any tips or tweaks…">
              <label for="q7FollowText" id="q7FollowLabel">Tell us more about your rating</label>
              <textarea id="q7FollowText" name="q7_follow" placeholder=""></textarea>
            </div>
            <input type="hidden" name="q7" required>
          </section>

          <section class="step" data-qid="11" data-required="true" data-title="11) How would you rate the friendliness of the staff you interacted with?">
            <div class="slider-shell slider-shell-rating" data-slider-type="rating" data-slider-input="q8" data-slider-labels="Low,Low,Low,Low,Decent,Decent,Decent,Decent,Awesome,Awesome" data-slider-default="1">
              <div class="slider-score" id="q8Score">1</div>
              <div class="slider-score-label" id="q8ScoreLabel">Low</div>
              <div class="slider-track">
                <div class="slider-lane">
                  <div class="slider-fill"></div>
                  <div class="slider-thumb"><img src="ramenbowl.png" alt="Ramen bowl"></div>
                </div>
                <input id="q8Range" class="ramen-range" type="range" min="1" max="10" step="1" value="1" aria-label="Staff friendliness rating">
              </div>
              <div class="slider-ticks"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span></div>
            </div>
            <div class="slider-followup" id="q8Follow" data-low-max="6" data-high-min="9" data-low-label="What was wrong with the service?" data-low-placeholder="Let us know what didn’t feel welcoming…" data-high-label="Awesome! Who made your visit great?" data-high-placeholder="We’d love to celebrate your experience…" data-neutral-display="show" data-neutral-label="How could the service be better next time?" data-neutral-placeholder="Share any tips or tweaks…">
              <label for="q8FollowText" id="q8FollowLabel">Tell us more about your rating</label>
              <textarea id="q8FollowText" name="q8_follow" placeholder=""></textarea>
            </div>
            <input type="hidden" name="q8" required>
          </section>

          <section class="step" data-qid="12" data-required="true" data-title="12) How would you rate the promptness of the service in this branch?">
            <div class="slider-shell slider-shell-rating" data-slider-type="rating" data-slider-input="q10" data-slider-labels="Low,Low,Low,Low,Decent,Decent,Decent,Decent,Awesome,Awesome" data-slider-default="1">
              <div class="slider-score" id="q10Score">1</div>
              <div class="slider-score-label" id="q10ScoreLabel">Low</div>
              <div class="slider-track">
                <div class="slider-lane">
                  <div class="slider-fill"></div>
                  <div class="slider-thumb"><img src="ramenbowl.png" alt="Ramen bowl"></div>
                </div>
                <input id="q10Range" class="ramen-range" type="range" min="1" max="10" step="1" value="1" aria-label="Service promptness rating">
              </div>
              <div class="slider-ticks"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span></div>
            </div>
            <div class="slider-followup" id="q10Follow" data-low-max="6" data-high-min="9" data-low-label="What made you feel the service was too slow?" data-low-placeholder="Tell us what slowed things down…" data-high-label="We're thrilled! Anything in particular stood out for you?" data-high-placeholder="Let us know what stood out…" data-neutral-display="show" data-neutral-label="What could have made it better?" data-neutral-placeholder="Share any ideas to help us move faster…">
              <label for="q10FollowText" id="q10FollowLabel">Tell us more about your rating</label>
              <textarea id="q10FollowText" name="q10_follow" placeholder=""></textarea>
            </div>
            <input type="hidden" name="q10" required>
          </section>

          <section class="step" data-qid="13" data-required="true" data-title="13) How would you rate the overall cleanliness and orderliness of the restaurant, including the restroom, if applicable?">
            <div class="slider-shell slider-shell-rating" data-slider-type="rating" data-slider-input="q11" data-slider-labels="Low,Low,Low,Low,Decent,Decent,Decent,Decent,Awesome,Awesome" data-slider-default="1">
              <div class="slider-score" id="q11Score">1</div>
              <div class="slider-score-label" id="q11ScoreLabel">Low</div>
              <div class="slider-track">
                <div class="slider-lane">
                  <div class="slider-fill"></div>
                  <div class="slider-thumb"><img src="ramenbowl.png" alt="Ramen bowl"></div>
                </div>
                <input id="q11Range" class="ramen-range" type="range" min="1" max="10" step="1" value="1" aria-label="Cleanliness rating">
              </div>
              <div class="slider-ticks"><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span></div>
            </div>
            <div class="slider-followup" id="q11Follow" data-low-max="6" data-high-min="9" data-low-label="What specific area did you find unclean or poorly maintained?" data-low-placeholder="Let us know what needs more attention…" data-high-label="What stood out to you about the orderliness today?" data-high-placeholder="Share what impressed you…" data-neutral-display="show" data-neutral-label="What improvement could have made the space feel more tidy?" data-neutral-placeholder="Share any suggestions for tidier spaces…">
              <label for="q11FollowText" id="q11FollowLabel">Tell us more about your rating</label>
              <textarea id="q11FollowText" name="q11_follow" placeholder=""></textarea>
            </div>
            <input type="hidden" name="q11" required>
          </section>

          <section class="step" data-qid="14" data-required="true" data-title="14) How likely is it that you would recommend this branch to others based on your overall experience?">
            <div class="slider-shell slider-shell-nps" data-slider-type="nps">
              <div class="slider-score" id="npsVal">1</div>
              <div class="slider-track">
                <div class="slider-lane">
                  <div class="slider-fill"></div>
                  <div class="slider-thumb"><img src="ramenbowl.png" alt="Ramen bowl"></div>
                </div>
                <input id="nps" class="ramen-range" type="range" name="q12" min="0" max="10" step="1" value="1">
              </div>
              <div class="slider-ticks"><span>0</span><span>1</span><span>2</span><span>3</span><span>4</span><span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span></div>
            </div>
            <div id="npsFollowups" style="margin-top:16px">
              <div id="npsPromoter" style="display:none">
                <label for="q12a">What made your experience worth recommending to others?</label>
                <textarea name="q12a" id="q12a" placeholder="Share what stood out about your visit…"></textarea>
              </div>
              <div id="npsPassive" style="display:none">
                <label for="q12b">What could we improve to make your experience truly recommendable?</label>
                <textarea name="q12b" id="q12b" placeholder="Tell us what would make it truly recommendable…"></textarea>
              </div>
              <div id="npsDetractor" style="display:none">
                <label for="q12c">What held you back from wanting to recommend us?</label>
                <textarea name="q12c" id="q12c" placeholder="Let us know what held you back…"></textarea>
              </div>
            </div>
          </section>

          <section class="step" data-qid="15" data-title="15) Do you have any ideas for new dishes, experiences, or improvements you'd like us to explore?">
            <textarea id="q14Text" name="q14" placeholder="Your ideas…" aria-label="Share your ideas for new dishes, experiences, or improvements"></textarea>
          </section>

          <section class="step" data-qid="16" data-required="true" data-title="16) Where would you like us to open next? (City / Mall / Area)">
            <div class="row">
              <button type="button" class="pill" data-name="q16_type" data-value="City">City</button>
              <button type="button" class="pill" data-name="q16_type" data-value="Mall">Mall</button>
              <button type="button" class="pill" data-name="q16_type" data-value="Other">Other</button>
              <input type="hidden" name="q16_type">
            </div>
            <div class="typeahead" id="q16Typeahead" style="display:none">
              <input id="q16" name="q16" type="text" placeholder="City / Mall / Area" autocomplete="off" aria-label="Preferred city, mall, or area for our next location">
              <div class="ta-list" id="q16List"></div>
            </div>
          </section>

          <section class="step" data-qid="17" data-title="17) Any other suggestions, shout-outs, or concerns we should know about?">
            <textarea id="q15Text" name="q15" placeholder="Your suggestions…" aria-label="Share additional suggestions, shout-outs, or concerns"></textarea>
          </section>
        </div>
        <div class="actions">
          <button type="button" id="backBtn" class="btn alt">← Back to start</button>
          <button type="button" id="nextBtn" class="btn" disabled>Next →</button>
          <button type="submit" id="submitBtn" class="btn" style="display:none">Submit Survey →</button>
        </div>
        <div id="stateMsg" class="state" aria-live="polite">Select an answer to continue.</div>
      </form>
    </div>
  </main>

  <div id="submittingOverlay" style="display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 1000; align-items: center; justify-content: center; flex-direction: column; text-align: center;">
    <img src="kazunorilogo.png" alt="Submitting..." style="width: 150px; height: auto; animation: pulse 1.5s infinite ease-in-out;">
    <p style="margin-top: 16px; font-weight: 700; color: var(--ink);">Submitting your answers...</p>
  </div>

  <!-- Supabase JS — UMD (not used for submit here) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <script>
    /* Hero → Survey (smooth) */
    const hero = document.getElementById('hero');
    const viewport = document.getElementById('viewport');
    document.getElementById('startBtn').addEventListener('click',(e)=>{
      e.preventDefault();
      hero.style.transition='opacity .26s var(--ease), transform .26s var(--ease)';
      hero.style.opacity='0'; hero.style.transform='translateY(-6px)';
      
      setTimeout(()=>{
        hero.style.display='none';
        viewport.style.display='flex';
        viewport.style.transition='opacity .26s var(--ease), transform .26s var(--ease)';
        requestAnimationFrame(()=>{
          viewport.style.opacity='1';
          viewport.style.transform='none';
          refreshStageHeight(true);
          updateUI();
        });
      }, 260);
    });

    const $  = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));

    const SUPABASE_URL = 'https://hxkrwxwrbffjkmepqlbh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4a3J3eHdyYmZmamttZXBxbGJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjQ0MzYsImV4cCI6MjA3MTM0MDQzNn0.clmhrWPkZp9lD1zcUJRDF-2BPlpmt6x2ojNkKwjJBFw';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = $('#surveyForm');
    const urlParams = new URLSearchParams(window.location.search);
    const receiptParam = urlParams.get("receipt") || "";
    const branchParam = urlParams.get("branch") || "";
    const responseId = urlParams.get("response_id") || "";
    const branchField = document.getElementById('branchField');
    const RECEIPT_BRANCHES = {
      MDKA:'Molito (Alabang)',
      MDKB:'Bonifacio Global City',
      MDKC:'Cebu',
      MDKK:'Katipunan',
      MDKM:'Salcedo Village (Makati)',
      MDKP:'Pasay',
      YSKA:'Molito (Alabang)',
      YSKC:'Cebu',
      YSKO:'Ortigas',
      YSKP:'Pasay',
      MRDR:'Rockwell',
      MRDV:'Vertis North',
      KZCF:'Kazu Café (Makati)',
      KZNM:'Kazunori (Makati)'
    };
    function detectBranch(receipt, hinted){
      if(hinted) return hinted;
      const prefix = (receipt.match(/^[A-Za-z]{4}/)?.[0] || '').toUpperCase();
      return RECEIPT_BRANCHES[prefix] || '';
    }
    const detectedBranch = detectBranch(receiptParam, branchParam);
    if(branchField){
      branchField.value = detectedBranch || '';
    }
    const steps = $$('.step');
    steps.forEach(step=>{
      const rawTitle = step.dataset.title || '';
      const match = rawTitle.match(/^\s*\d+\)\s*(.*)$/);
      const baseTitle = match ? match[1] : rawTitle;
      step.dataset.baseTitle = baseTitle;
    });
    const stage = $('#stage');
    const stepTitleEl = $('#stepTitle');
    const stepChipEl = $('#stepChip');
    const stepMiniBarEl = $('#stepMiniBar');
    const bar = $('#bar');
    const backBtn = $('#backBtn');
    const nextBtn = $('#nextBtn');
    const submitBtn = $('#submitBtn');
    const state = $('#stateMsg');
    const q2Hidden = form.querySelector('input[name="q2"]');
    const q4Hidden = form.querySelector('input[name="q4"]');
    const q4Step = q4Hidden ? q4Hidden.closest('.step') : null;
    let idx = 0;

    const q13Buttons = Array.from(document.querySelectorAll('.row .pill[data-name="q13"]'));
    const q13Hidden = form.querySelector('input[name="q13"]');
    const q13OtherTxt = $('#q13OtherTxt');
    const q13ClearBtn = $('#q13Clear');

    function setPillPressed(btn, state){
      if(!btn) return;
      btn.setAttribute('aria-pressed', state ? 'true' : 'false');
    }

    function updateQ13Hidden(){
      if(!q13Hidden) return;
      const selections = [];
      q13Buttons.forEach(b=>{
        if(b.getAttribute('aria-pressed') === 'true'){
          const val = b.dataset.value;
          if(val === '__other'){
            const otherVal = q13OtherTxt?.value.trim();
            if(otherVal){ selections.push(otherVal); }
          }else{
            selections.push(val);
          }
        }
      });
      q13Hidden.value = selections.join(', ');
    }

    function handleQ13Selection(btn){
      if(!btn) return;
      const value = btn.dataset.value;
      const nextState = btn.getAttribute('aria-pressed') !== 'true';

      if(value === 'Not applicable' && nextState){
        q13Buttons.forEach(p=>{ if(p!==btn){ setPillPressed(p,false); } });
        if(q13OtherTxt){
          q13OtherTxt.style.display='none';
          q13OtherTxt.value='';
        }
      }else if(value !== 'Not applicable'){
        const naBtn = q13Buttons.find(p=>p.dataset.value === 'Not applicable');
        setPillPressed(naBtn,false);
      }

      setPillPressed(btn,nextState);

      if(value === '__other' && q13OtherTxt){
        if(nextState){
          q13OtherTxt.style.display='block';
          q13OtherTxt.focus();
        }else{
          q13OtherTxt.style.display='none';
          q13OtherTxt.value='';
        }
      }

      updateQ13Hidden();
      refreshStageHeight();
      updateUI();
    }

    if(q13OtherTxt){
      q13OtherTxt.addEventListener('input', ()=>{
        updateQ13Hidden();
        updateUI();
      });
    }

    if(q13ClearBtn){
      q13ClearBtn.addEventListener('click', ()=>{
        q13Buttons.forEach(btn=>setPillPressed(btn,false));
        if(q13OtherTxt){
          q13OtherTxt.value='';
          q13OtherTxt.style.display='none';
        }
        if(q13Hidden){ q13Hidden.value=''; }
        updateUI();
        refreshStageHeight();
      });
    }


    function visibleSteps(){
      return steps.filter(step => step.dataset.skip !== 'true');
    }
    function resolveTargetIndex(target, dir){
      let next = target;
      while(next >= 0 && next < steps.length && steps[next].dataset.skip === 'true'){
        next += dir;
      }
      return next;
    }
    function resetSurveyState() {
      form.reset();
      idx = 0;

      // Reset pills
      $$('.row .pill[aria-pressed="true"]').forEach(btn => btn.setAttribute('aria-pressed', 'false'));
      q13Hidden.value = '';
      if (q13OtherTxt) {
        q13OtherTxt.value = '';
        q13OtherTxt.style.display = 'none';
      }


      // Reset sliders
      ratingSliderInstances.forEach(inst => {
          inst.touched = false;
          const defaultVal = inst.shell.dataset.sliderDefault ?? inst.min;
          inst.range.value = defaultVal;
          inst.update(defaultVal);
          const applyFollowup = configureSliderFollowup(inst);
          if (applyFollowup) {
              applyFollowup(defaultVal, false);
          }
      });

      if (npsSliderInst) {
          npsSliderInst.touched = false;
          const defaultVal = npsSliderInst.shell.dataset.sliderDefault ?? npsSliderInst.min;
          npsRange.value = defaultVal;
          updateNPSUI(Number(defaultVal));
      }

      // Reset steps
      steps.forEach((step, i) => {
          step.classList.remove('exiting-left', 'exiting-right', 'entering-left', 'entering-right', 'active');
          step.classList.toggle('active', i === 0);
          step.style.display = i === 0 ? 'block' : 'none';
      });

      // Reset other UI elements
      syncVisitFrequencyStep();
      updateUI();
      refreshStageHeight(true);
    }

    function syncVisitFrequencyStep(){
      if(!q4Step || !q4Hidden) return;
      const answer = (q2Hidden?.value || '').toLowerCase();
      if(answer === 'no'){
        delete q4Step.dataset.skip;
        if(q4Hidden.dataset.autofill === 'first-time'){
          q4Hidden.value = '';
          delete q4Hidden.dataset.autofill;
        }
      }else{
        q4Step.dataset.skip = 'true';
        $$('.row .pill[data-name="q4"]').forEach(b=>b.setAttribute('aria-pressed','false'));
        if(answer === 'yes'){
          q4Hidden.value = 'Not applicable';
          q4Hidden.dataset.autofill = 'first-time';
        }else{
          if(q4Hidden.dataset.autofill === 'first-time'){
            delete q4Hidden.dataset.autofill;
          }
          q4Hidden.value = '';
        }
      }
      refreshStageHeight();
      updateUI();
    }

    /* ====== Typeahead data (PH Cities + Malls) ====== */
    const PH_CITIES = [
      /* NCR */
      "Caloocan","Las Piñas","Makati","Malabon","Mandaluyong","Manila","Marikina","Muntinlupa","Navotas","Parañaque","Pasay","Pasig","Quezon City","San Juan","Taguig","Valenzuela","Pateros",
      /* Luzon */
      "Alaminos","Angeles","Antipolo","Bacoor","Balanga","Batac","Batangas City","Baguio","Cabanatuan","Cabuyao","Candon","Cauayan","Cavite City","Dagupan","Dasmariñas","Gapan","General Trias","Iriga","Laoag","Legazpi","Ligao","Lipa","Lucena","Malolos","Meycauayan","Naga","Olongapo","Palayan","Puerto Princesa","San Carlos (Pangasinan)","San Fernando (La Union)","San Fernando (Pampanga)","San Jose (Nueva Ecija)","San Jose del Monte","San Pablo","Santa Rosa","Santiago","Sorsogon City","Tabuk","Tacurong","Tarlac City","Tayabas","Trece Martires","Vigan",
      /* Visayas */
      "Bacolod","Bago","Bais","Bayawan","Baybay","Borongan","Calbayog","Catbalogan","Cebu City","Danao","Dumaguete","Guihulngan","Iloilo City","Kabankalan","Kananga","Lapu-Lapu","Maasin","Mandaue","Ormoc","Passi","Roxas City","Silay","Sipalay","Tagbilaran","Tacloban","Talisay (Cebu)","Talisay (Negros Occidental)","Toledo","Victorias",
      /* Mindanao */
      "Butuan","Cabadbaran","Cagayan de Oro","Cotabato City","Davao City","Digos","Dipolog","Dapitan","El Salvador","Gingoog","General Santos","Iligan","Isabela City","Kidapawan","Koronadal","Mati","Malaybalay","Marawi","Oroquieta","Ozamiz","Pagadian","Panabo","Samal","San Carlos (Negros Occidental)","Surigao City","Tagum","Tangub","Tandag","Valencia","Zamboanga City"
    ];

    const PH_MALLS = [
      "SM Mall of Asia",
      "SM Megamall",
      "SM North EDSA",
      "SM Aura Premier",
      "SM Southmall",
      "SM Fairview",
      "SM Manila",
      "SM San Lazaro",
      "SM Marikina",
      "SM BF Parañaque",
      "SM Bicutan",
      "SM Sucat",
      "SM Sta. Mesa",
      "SM East Ortigas",
      "SM City Taytay",
      "SM City Sta. Rosa",
      "SM City Calamba",
      "SM Seaside City Cebu",
      "SM City Cebu",
      "SM Lanang Premier",
      "SM City Davao",
      "SM City Clark",
      "SM City Baguio",
      "SM City Pampanga",
      "SM City Iloilo",
      "SM City Bacolod",
      "SM City Cagayan de Oro",
      "SM City Consolacion",
      "SM City Dasmariñas",
      "SM City Tarlac",
      "SM City Naga",
      "SM City Legazpi",
      "SM City Laoag",
      "SM City Tuguegarao",
      "Ayala Malls Glorietta",
      "Greenbelt",
      "Ayala Malls Manila Bay",
      "Ayala Malls Trinoma",
      "UP Town Center",
      "Market! Market!",
      "Bonifacio High Street",
      "One Bonifacio/High Street South",
      "Ayala Malls Vertis North",
      "Ayala Malls Circuit",
      "Ayala Malls Feliz",
      "Ayala Malls Cloverleaf",
      "Ayala Malls Serin",
      "Ayala Malls Solenad",
      "Ayala Center Cebu",
      "Power Plant Mall",
      "Shangri-La Plaza",
      "The Podium",
      "Estancia at Capitol Commons",
      "Venice Grand Canal Mall",
      "Newport Mall",
      "Eastwood Mall",
      "Uptown Mall",
      "Gateway Mall",
      "Festival Mall",
      "Alabang Town Center",
      "Greenhills Shopping Center",
      "Lucky Chinatown Mall",
      "Fisher Mall",
      "Robinsons Galleria",
      "Robinsons Place Manila",
      "Robinsons Magnolia",
      "Robinsons Galleria South",
      "Robinsons Metro East",
      "Robinsons Galleria Cebu",
      "Robinsons Ilocos Norte",
      "Robinsons Place Bacolod",
      "Robinsons Place Iloilo",
      "Robinsons Place Dumaguete",
      "Robinsons Place Malolos",
      "Robinsons Place Dasmariñas",
      "Il Corso Lifemalls",
      "Island Central Mactan",
      "Centrio Mall CDO",
      "SM CDO Downtown Premier",
      "Limketkai Center"
    ];

    /* ===== Typeahead helper (food-truck style) ===== */
        function attachTypeahead(input, listOrFn, onPick){
      const wrap = input.closest('.typeahead') || input.parentElement;
      const ul = wrap.querySelector('.ta-list') || (()=>{ const d=document.createElement('div'); d.className='ta-list'; wrap.appendChild(d); return d; })();
      let active = -1;
      const getList = (typeof listOrFn === 'function') ? listOrFn : ()=>listOrFn;
      function filterItems(q){
        const src = (getList() || []).slice();
        const qv = (q || '').trim().toLowerCase();
        const base = src.sort((a,b)=>a.localeCompare(b));
        if(!qv) return base.slice(0,50);
        const matches = base.filter(x=>x.toLowerCase().includes(qv));
        return matches.slice(0,50);
      }
      function openDropdown(){ ul.style.display='block'; stage.classList.add('dropdown-open') }
      function closeDropdown(){ ul.style.display='none'; stage.classList.remove('dropdown-open') }
      function render(q){
        const items = filterItems(q);
        ul.innerHTML=''; active = -1;
        if(items.length===0){ closeDropdown(); return }
        items.forEach((txt)=>{
          const it=document.createElement('div'); it.className='ta-item'; it.textContent=txt;
          it.addEventListener('mousedown', e=>{ e.preventDefault(); pick(txt) });
          ul.appendChild(it);
        });
        openDropdown();
      }
      function highlight(){
        [...ul.children].forEach((c,i)=> c.classList.toggle('active', i===active));
        if(active>-1){
          const el = ul.children[active];
          const top = el.offsetTop, bottom = top + el.offsetHeight;
          if(ul.scrollTop > top) ul.scrollTop = top;
          else if(ul.scrollTop + ul.clientHeight < bottom) ul.scrollTop = bottom - ul.clientHeight;
        }
      }
      function pick(val){ input.value = val; closeDropdown(); onPick?.(val) }
      input.addEventListener('input', ()=> render(input.value));
      input.addEventListener('focus', ()=> render(input.value));
      input.addEventListener('blur', ()=> setTimeout(()=>closeDropdown(), 120));
      input.addEventListener('keydown', e=>{
        const n = ul.children.length; if(!n) return;
        if(e.key==='ArrowDown'){ active = (active+1)%n; highlight(); e.preventDefault() }
        else if(e.key==='ArrowUp'){ active = (active-1+n)%n; highlight(); e.preventDefault() }
        else if(e.key==='Enter' && active>-1){ e.preventDefault(); pick(ul.children[active].textContent) }
      });
    }
    
    function setupSingleChoicePills(name) {
      const pills = $$(`.row .pill[data-name="${name}"]`);
      const hidden = form.querySelector(`input[type="hidden"][name="${name}"]`);
      if (!pills.length || !hidden) return;

      pills.forEach(pill => {
        pill.addEventListener('click', (e) => {
          e.stopPropagation();
          const value = pill.dataset.value;
          pills.forEach(p => p.setAttribute('aria-pressed', 'false'));
          pill.setAttribute('aria-pressed', 'true');
          hidden.value = value;
          
          if (name === 'q2') {
            syncVisitFrequencyStep();
          }
          updateUI();
        });
      });
    }

    setupSingleChoicePills('q2');
    setupSingleChoicePills('q3');
    setupSingleChoicePills('q4');

    q13Buttons.forEach(btn => {
      btn.addEventListener('click', () => handleQ13Selection(btn));
    });

    function createSliderInstance(shell){
  if(!shell) return null;
  const range = shell.querySelector('input[type="range"]');
  if(!range) return null;
  const inst = {
    shell,
    range,
    fill: shell.querySelector('.slider-fill'),
    thumb: shell.querySelector('.slider-thumb'),
    ticks: Array.from(shell.querySelectorAll('.slider-ticks span')),
    score: shell.querySelector('.slider-score'),
    labelEl: shell.querySelector('.slider-score-label'),
    min: Number(range.min || 0),
    max: Number(range.max || 0),
    step: Number(range.step || 1),
    scoreFormatter: val => String(Math.round(val)),
    labelFormatter: null,
    commitFormatter: val => String(Math.round(val)),
    hidden: null,
    numberInput: null
  };

  const hiddenAttr = shell.dataset.sliderInput || '';
  if(hiddenAttr){
    inst.hidden = form.querySelector(`input[name="${hiddenAttr}"]`);
  }else{
    const next = shell.nextElementSibling;
    if(next && next.tagName === 'INPUT' && next.type === 'hidden'){ inst.hidden = next; }
  }

  inst.numberInput = shell.querySelector('[data-slider-number]');
  if(inst.numberInput){
    if(!inst.numberInput.hasAttribute('min')) inst.numberInput.setAttribute('min', String(inst.min));
    if(!inst.numberInput.hasAttribute('max')) inst.numberInput.setAttribute('max', String(inst.max));
    if(!inst.numberInput.hasAttribute('step')) inst.numberInput.setAttribute('step', String(inst.step > 0 ? inst.step : 1));
    inst.numberInput.setAttribute('inputmode', inst.numberInput.getAttribute('inputmode') || 'numeric');
  }

  const type = shell.dataset.sliderType || '';
  const labelData = (shell.dataset.sliderLabels || '').split(',').map(l=>l.trim()).filter(Boolean);
  inst.touched = false;

  if(type === 'rating' && labelData.length){
    inst.labelFormatter = val => {
      const idx = Math.min(labelData.length - 1, Math.max(0, Math.round(val) - 1));
      return labelData[idx] || '';
    };
  }

  const defaultVal = Number(shell.dataset.sliderDefault ?? range.value ?? inst.min);
  if(Number.isFinite(defaultVal)) range.value = defaultVal;

  const stepSize = inst.step > 0 ? inst.step : 1;
  const rangeSpan = inst.max - inst.min;

  inst.update = value=>{
    const val = value !== undefined ? Number(value) : Number(inst.range.value);
    const ratioRaw = rangeSpan>0 ? (val - inst.min)/rangeSpan : 0;
    const pct = Math.max(0, Math.min(1, ratioRaw));
    if(inst.fill) inst.fill.style.width = `${pct*100}%`;
    if(inst.thumb) inst.thumb.style.left = `${pct*100}%`;

    if(inst.ticks.length){
      const idx = Math.min(inst.ticks.length - 1, Math.max(0, Math.round((val - inst.min)/stepSize)));
      inst.ticks.forEach((tick,i)=> tick.classList.toggle('active', i===idx));
    }

    const displayVal = inst.scoreFormatter ? inst.scoreFormatter(val) : String(Math.round(val));
    if(inst.score){ inst.score.textContent = displayVal; }
    if(inst.numberInput && document.activeElement !== inst.numberInput){
      inst.numberInput.value = displayVal;
    }
    if(inst.labelEl){
      const displayRaw = inst.labelFormatter ? inst.labelFormatter(val) : '';
      const display = displayRaw || '';
      inst.labelEl.textContent = display;
      inst.labelEl.classList.toggle('is-empty', !display);
    }
    if(inst.hidden){
      if(inst.touched){
        inst.hidden.value = inst.commitFormatter ? inst.commitFormatter(val) : String(val);
      }else{
        inst.hidden.value = '';
      }
    }
  };

  return inst;
}
    const ratingSliderInstances = Array.from(document.querySelectorAll('[data-slider-type="rating"]'))
      .map(createSliderInstance)
      .filter(Boolean);

    function configureSliderFollowup(inst){
      const hiddenName = inst.hidden?.name;
      if(!hiddenName) return null;
      const followEl = document.getElementById(`${hiddenName}Follow`);
      if(!followEl) return null;
      const textarea = followEl.querySelector('textarea');
      const labelEl = followEl.querySelector('label');
      if(!textarea || !labelEl) return null;
      const lowMax = Number(followEl.dataset.lowMax ?? 4);
      const highMin = Number(followEl.dataset.highMin ?? 8);
      const lowLabel = followEl.dataset.lowLabel || 'What could we improve to earn a higher score?';
      const lowPlaceholder = followEl.dataset.lowPlaceholder || 'Share any issues you encountered…';
      const highLabel = followEl.dataset.highLabel || 'Amazing! What made your experience stand out?';
      const highPlaceholder = followEl.dataset.highPlaceholder || 'Tell us what you loved…';
      const neutralLabel = followEl.dataset.neutralLabel || '';
      const neutralPlaceholder = followEl.dataset.neutralPlaceholder || '';
      const showNeutral = (followEl.dataset.neutralDisplay || '').toLowerCase() === 'show';
      return (value, touched)=>{
        if(!touched){
          followEl.style.display = 'none';
          textarea.value = '';
          setRequired(textarea, false);
          refreshStageHeight();
          return;
        }
        const score = Number(value);
        if(score <= lowMax){
          followEl.style.display = 'block';
          labelEl.textContent = lowLabel;
          textarea.placeholder = lowPlaceholder;
          setRequired(textarea, false);
        }else if(score >= highMin){
          followEl.style.display = 'block';
          labelEl.textContent = highLabel;
          textarea.placeholder = highPlaceholder;
          setRequired(textarea, false);
        }else if(showNeutral){
          followEl.style.display = 'block';
          labelEl.textContent = neutralLabel;
          textarea.placeholder = neutralPlaceholder;
          setRequired(textarea, false);
        }else{
          followEl.style.display = 'none';
          textarea.value = '';
          setRequired(textarea, false);
        }
        refreshStageHeight();
      };
    }

    ratingSliderInstances.forEach(inst=>{
      inst.update(inst.range.value);
      const applyFollowup = configureSliderFollowup(inst);
      if(applyFollowup){
        applyFollowup(inst.range.value, inst.touched);
      }
      const handleRangeInput = ()=>{
        inst.touched = true;
        inst.update(inst.range.value);
        if(applyFollowup){ applyFollowup(inst.range.value, inst.touched); }
        updateUI();
      };
      inst.range.addEventListener('input', handleRangeInput);
      if(inst.numberInput){
        const stepSize = inst.step > 0 ? inst.step : 1;
        inst.numberInput.addEventListener('input', ()=>{
          const raw = inst.numberInput.value.trim();
          if(raw === ''){
            inst.touched = false;
            if(inst.hidden){ inst.hidden.value = ''; }
            inst.update(inst.range.value);
            if(applyFollowup){ applyFollowup(inst.range.value, inst.touched); }
            updateUI();
            return;
          }
          const parsed = Number(raw);
          if(!Number.isFinite(parsed)) return;
          let val = Math.max(inst.min, Math.min(inst.max, parsed));
          val = inst.min + Math.round((val - inst.min) / stepSize) * stepSize;
          val = Number(val.toFixed(4));
          val = Math.max(inst.min, Math.min(inst.max, val));
          inst.range.value = String(val);
          inst.touched = true;
          inst.update(val);
          if(applyFollowup){ applyFollowup(val, inst.touched); }
          updateUI();
        });
        inst.numberInput.addEventListener('blur', ()=>{
          const raw = inst.numberInput.value.trim();
          if(raw === ''){
            inst.touched = false;
            if(inst.hidden){ inst.hidden.value = ''; }
            inst.update(inst.range.value);
            if(applyFollowup){ applyFollowup(inst.range.value, inst.touched); }
            updateUI();
            return;
          }
          let val = Number(raw);
          if(!Number.isFinite(val)){ val = Number(inst.range.value); }
          val = Math.max(inst.min, Math.min(inst.max, val));
          val = inst.min + Math.round((val - inst.min) / stepSize) * stepSize;
          val = Number(val.toFixed(4));
          inst.range.value = String(val);
          inst.update(val);
          if(applyFollowup){ applyFollowup(val, inst.touched); }
        });
      }
    });

    const npsShell = document.querySelector('[data-slider-type="nps"]');
    const npsSliderInst = createSliderInstance(npsShell);
    const npsRange = npsSliderInst ? npsSliderInst.range : $('#nps');
    const npsPromoter = $('#npsPromoter');
    const npsPassive = $('#npsPassive');
    const npsDetractor = $('#npsDetractor');
    const q12a = $('#q12a'), q12b = $('#q12b'), q12c = $('#q12c');
    function setRequired(el, on){ if(!el) return; if(on){ el.setAttribute('required','required') } else{ el.removeAttribute('required') } }
    function updateNPSUI(val){
      if(npsSliderInst){ npsSliderInst.update(val); }
      if(npsPromoter){ npsPromoter.style.display = 'none'; }
      if(npsPassive){ npsPassive.style.display = 'none'; }
      if(npsDetractor){ npsDetractor.style.display = 'none'; }
      setRequired(q12a,false); setRequired(q12b,false); setRequired(q12c,false);
      if(npsSliderInst && !npsSliderInst.touched){
        refreshStageHeight();
        return;
      }
      if(val >= 9){ if(npsPromoter){ npsPromoter.style.display = 'block'; } setRequired(q12a,false); }
      else if(val >= 7){ if(npsPassive){ npsPassive.style.display = 'block'; } setRequired(q12b,false); }
      else{ if(npsDetractor){ npsDetractor.style.display = 'block'; } setRequired(q12c,false); }
      refreshStageHeight();
    }
    if(npsRange){ npsRange.addEventListener('input', ()=>{ if(npsSliderInst){ npsSliderInst.touched = true; } updateNPSUI(Number(npsRange.value)); updateUI(); }); }
    syncVisitFrequencyStep();

    /* ===== Auto-height per step (no empty space) ===== */
    function measureStepHeight(i){
      const step = steps[i];
      if(!step) return 0;
      const wasActive = step.classList.contains('active');
      const prevPos = step.style.position;
      step.style.position = 'relative';
      step.style.visibility = 'hidden';
      step.style.display = 'block';
      const h = step.scrollHeight + 10;
      step.style.display = wasActive ? 'block' : 'none';
      step.style.position = prevPos || '';
      step.style.visibility = wasActive ? '' : 'hidden';
      return h;
    }
    function refreshStageHeight(initial=false){
      const targetH = measureStepHeight(idx);
      if(initial){ stage.style.height = targetH+'px'; return; }
      stage.style.height = targetH+'px';
    }

    function setProgress(i){
      const visible = visibleSteps();
      const current = steps[i];
      const total = visible.length || 1;
      const position = current ? visible.indexOf(current) : -1;
      const at = position === -1 ? total : position + 1;
      bar.style.width = ((at / total) * 100) + '%';
      if(stepMiniBarEl){
        stepMiniBarEl.style.width = `${(at/total)*100}%`;
      }
      if(stepChipEl){
        stepChipEl.textContent = `Question ${at} of ${total}`;
      }
      return { at, total, current };
    }
    function stepValid(stepEl){
      if(stepEl.dataset.required === 'false') return true;
      const hidden = stepEl.querySelector('input[type="hidden"][name]');
      const text = stepEl.querySelector('input[type="text"][required], textarea[required]');
      if(hidden){
        const otherBtn = stepEl.querySelector('#q13OtherBtn');
        const otherTxt = stepEl.querySelector('#q13OtherTxt');
        if(otherBtn && otherTxt && otherTxt.style.display === 'block'){ return !!hidden.value && hidden.value.trim().length>0 }
        if(text){ return !!hidden.value && !!text.value.trim(); }
        return !!hidden.value;
      }
      if(text) return !!text.value.trim();
      const range = stepEl.querySelector('input[type="range"]');
      if(range) return range.value !== '';
      return true;
    }
    function updateUI(){
      const valid = stepValid(steps[idx]);
      if(nextBtn.style.display!=='none') nextBtn.disabled = !valid;
      state.textContent = valid ? '' : 'Select an answer to continue.';
      const progress = setProgress(idx);
      if(stepTitleEl){
        const titleSource = progress.current ? (progress.current.dataset.baseTitle || progress.current.dataset.title || '') : '';
        const trimmed = titleSource.trim();
        stepTitleEl.textContent = trimmed && progress.current ? `${progress.at}) ${trimmed}` : trimmed;
      }
      backBtn.textContent = (idx===0) ? '← Back to start' : '← Back';
      nextBtn.style.display = (idx < steps.length-1) ? 'inline-block' : 'none';
      submitBtn.style.display = (idx === steps.length-1) ? 'inline-block' : 'none';
      refreshStageHeight();
    }

    /* Smooth crossfade/slide with no ghosting */
    let animating = false;
    function show(target, dir=1){
      if(animating) return;
      const resolved = resolveTargetIndex(target, dir);
      if(resolved<0 || resolved>=steps.length || resolved===idx) return;
      animating = true;

      const cur = steps[idx];
      const nxt = steps[resolved];

      nxt.style.display='block';
      nxt.classList.remove('exiting-left','exiting-right','entering-left','entering-right','active');
      nxt.classList.add(dir>0 ? 'entering-right' : 'entering-left');
      nxt.getBoundingClientRect();

      stage.style.height = (nxt.scrollHeight + 10) + 'px';

      cur.classList.remove('active');
      cur.classList.add(dir>0 ? 'exiting-left' : 'exiting-right');
      nxt.classList.remove('entering-right','entering-left');
      nxt.classList.add('active');

      setTimeout(()=>{
        cur.classList.remove('exiting-left','exiting-right');
        cur.style.display='none';
        idx = resolved;
        updateUI();
        animating = false;
      }, 260);
    }

        const heroEl = document.getElementById('hero');

        backBtn.addEventListener('click', ()=>{

          if(idx===0){

            viewport.style.transition='opacity .22s var(--ease), transform .22s var(--ease)';

            viewport.style.opacity='0'; viewport.style.transform='translateY(6px)';

            setTimeout(()=>{

              viewport.style.display='none';

              viewport.style.opacity='';

              viewport.style.transform='';

              heroEl.style.display='grid';

              resetSurveyState();

              requestAnimationFrame(()=>{

                heroEl.style.opacity='1';

                heroEl.style.transform='none';

              });

            }, 220);

            return;

          }

          show(idx-1,-1);

        });

    nextBtn.addEventListener('click', ()=>{ if(!nextBtn.disabled) show(idx+1,+1) });
    form.addEventListener('input',updateUI);
    form.addEventListener('change',updateUI);

    document.addEventListener('keydown',(e)=>{
      const el=document.activeElement;
      const typing = el && (el.tagName==='TEXTAREA' || (el.tagName==='INPUT' && (el.type==='text' || el.type==='range')));
      if(e.key==='Enter' && !typing){
        e.preventDefault();
        if(nextBtn.style.display!=='none' && !nextBtn.disabled) nextBtn.click();
      }
    });

    /* Attach typeahead to Q16 using combined list */
    function setupLocationQuestion(){
      const typeButtons = $$('.row .pill[data-name="q16_type"]');
      const typeHidden = form.querySelector('input[name="q16_type"]');
      const input = $('#q16');
      const shell = document.getElementById('q16Typeahead');
      if(!input || !shell || !typeButtons.length || !typeHidden) return;

      const cities = [...PH_CITIES].sort((a,b)=>a.localeCompare(b));
      const malls = [...PH_MALLS].sort((a,b)=>a.localeCompare(b));
      let activeList = [];

      const getList = ()=>activeList;
      attachTypeahead(input, getList, ()=>{ updateUI(); });

      function choose(type){
        typeButtons.forEach(btn=> btn.setAttribute('aria-pressed', btn.dataset.value===type ? 'true' : 'false'));
        typeHidden.value = type || '';
        input.value = '';

        if(type){
          shell.style.display='block';
          const placeholder = type === 'City' ? 'Type a city' : (type === 'Mall' ? 'Type a mall' : 'Tell us where to open next');
          input.placeholder = placeholder;
          setRequired(input, true);
          activeList = (type === 'City') ? cities : (type === 'Mall' ? malls : []);
        }else{
          shell.style.display='none';
          activeList = [];
          setRequired(input, false);
        }
        refreshStageHeight();
        updateUI();
      }

      typeButtons.forEach(btn=>{
        btn.addEventListener('click', (e)=> {
          e.stopPropagation();
          choose(btn.dataset.value)
        });
      });
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      
      const overlay = document.getElementById('submittingOverlay');
      if (overlay) {
        overlay.style.display = 'flex';
      }

      state.textContent = 'Submitting…';
      submitBtn.disabled = true; nextBtn.disabled = true; backBtn.disabled = true;

      try {
        const formData = new FormData(form);
        const payload = {};
        for (const [key, value] of formData.entries()) {
          payload[key] = value;
        }

        // Map q1 to branch and get brand from URL
        payload.branch = payload.q1;
        payload.brand = urlParams.get("brand");
        delete payload.q1;

        const q17_restaurants = [];
        for (let i = 1; i <= 5; i++) {
          const restaurant = payload['q17_' + i];
          if (restaurant) {
            q17_restaurants.push(restaurant);
          }
          delete payload['q17_' + i];
        }
        if (q17_restaurants.length > 0) {
          payload.q17 = q17_restaurants;
        }

        payload.q12_follow = payload.q12a || payload.q12b || payload.q12c;
        delete payload.q12a;
        delete payload.q12b;
        delete payload.q12c;

        if (payload.q16_type && payload.q16) {
          payload.q16 = `${payload.q16_type}: ${payload.q16}`;
        } else if (payload.q16_type) {
          payload.q16 = payload.q16_type;
        }
        delete payload.q16_type;


        const { data, error } = await supabase.functions.invoke('submit-survey', {
          body: { response_id: responseId, payload },
        });

        if (error) throw error;
        if (data.error) throw new Error(data.error);

        setTimeout(()=>{
          if (overlay) {
            overlay.style.display = 'none';
          }
          const params = new URLSearchParams();
          if(receiptParam) params.set('receipt', receiptParam);
          if(responseId) params.set('response_id', responseId);
          if(data.reward_code) params.set('reward_code', data.reward_code);
          const dest = params.toString() ? 'kzreward.html?'+params.toString() : 'kzreward.html';
          window.location.href = dest;
        }, 500);

      } catch (error) {
        console.error('Error submitting survey:', error);
        state.textContent = 'An error occurred. Please try again.';
        if (overlay) {
          overlay.style.display = 'none';
        }
        submitBtn.disabled = false; nextBtn.disabled = false; backBtn.disabled = false;
      }
    });

    window.addEventListener('load',()=>{
      steps.forEach((s,i)=>{ s.style.display = (i===0) ? 'block' : 'none'; s.classList.toggle('active', i===0); });
      refreshStageHeight(true);
      updateUI();
      setupLocationQuestion();

      // initialize NPS UI once DOM is ready
      if(npsRange){
        updateNPSUI(Number(npsRange.value));
      }
    });
    window.addEventListener('resize',()=>refreshStageHeight());
  </script>
</body>
</html>
