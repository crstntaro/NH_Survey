<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nippon Hasha — Customer Satisfaction Survey</title>

  <!-- Montserrat -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --font:"Montserrat",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;
      --ink:#101010; --muted:#6b7280; --gold:#85754E; --gold-dk:#6f6242;
      --line:#e5e7eb; --bg:#faf6ef; --surface:#ffffff;
      --header-h:72px; --sea1:.12; --sea2:.05;
    }

    *{ box-sizing:border-box; margin:0; padding:0 }
    html,body{ min-height:100% }
    body{
      font-family:var(--font); color:var(--ink); background:var(--bg);
      line-height:1.6; overflow-x:hidden;
      opacity:0; transform:translateY(8px); animation:fadeIn .45s ease forwards;
    }
    @keyframes fadeIn{ to{ opacity:1; transform:none } }

    /* Animated background (matches your other pages) */
    .bg{ position:fixed; inset:0; z-index:0;  /* ⬅ was -2; bring it above page background */
      background: radial-gradient(1200px 360px at 50% -120px, rgba(196,30,58,.09), transparent 65%), var(--bg);
    }
    .bg::before, .bg::after{
      content:""; position:absolute; inset:0; pointer-events:none;
      background-repeat:repeat; background-size:400px 200px; animation: float 34s linear infinite;
    }
    .bg::before{
      opacity:var(--sea1);
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="150" viewBox="0 0 300 150"><defs><pattern id="s" width="50" height="25" patternUnits="userSpaceOnUse"><path d="M0 25a25 25 0 0 1 50 0" fill="none" stroke="%23C41E3A" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23s)"/></svg>');
    }
    .bg::after{
      opacity:var(--sea2); animation-duration:48s; animation-direction:reverse; transform:translateY(10px);
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="150" viewBox="0 0 300 150"><defs><pattern id="s" width="50" height="25" patternUnits="userSpaceOnUse"><path d="M0 25a25 25 0 0 1 50 0" fill="none" stroke="%23101010" stroke-width=".9" opacity=".25"/><path d="M12.5 25a12.5 12.5 0 0 1 25 0" fill="none" stroke="%23101010" stroke-width=".6" opacity=".18"/></pattern></defs><rect width="100%" height="100%" fill="url(%23s)"/></svg>');
    }
    @keyframes float{ from{ background-position:0 0 } to{ background-position:400px 0 } }

    /* Header */
    .site-header{
      position:sticky; top:0; height:var(--header-h);
      display:flex; align-items:center;
      backdrop-filter:saturate(180%) blur(6px);
      background:color-mix(in oklab, var(--surface) 88%, transparent);
      border-bottom:1px solid var(--line); z-index:2; /* ⬅ above .bg */
    }
    .nav{ max-width:1200px; margin:0 auto; padding:0 16px; width:100%;
      display:flex; justify-content:space-between; align-items:center; height:100%;
    }
    .brand img{ height:40px; width:auto; display:block; }

    /* Layout */
    .stage{ min-height:calc(100dvh - var(--header-h)); display:grid; place-items:center; padding:24px 16px; position:relative; z-index:1; } /* ⬅ above .bg */
    .card{
      width:min(720px, 100%);
      background:var(--surface);
      border:1px solid var(--line);
      border-radius:20px;
      box-shadow:0 20px 60px rgba(0,0,0,.10);
      padding:22px;
    }
    .sub{ color:var(--muted); font-size:13px; margin-bottom:14px }

    label{ display:block; font:800 14px/1 var(--font); margin:16px 0 6px }
    .req{ color:#C41E3A; margin-left:4px }

    input[type="text"], input[type="email"], input[type="tel"]{
      width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px; font-size:15px;
      background:var(--surface); color:var(--ink); outline:none;
    }
    input::placeholder{ color:#9aa2ae }
    input[type="text"]:focus, input[type="email"]:focus, input[type="tel"]:focus{ border-color:#C41E3A; box-shadow:0 0 0 3px rgba(196,30,58,.15) }

    .row{ display:flex; gap:12px; flex-wrap:wrap }
    .row .col{ flex:1 1 240px }

    .checks{ margin-top:10px; display:grid; gap:10px }
    .check{ display:flex; gap:10px; align-items:flex-start }
    .check input{ accent-color:#C41E3A; width:16px; height:16px; margin-top:2px }
    .check div{ font-size:13px; line-height:1.45; color:var(--ink) }
    .check small{ color:#C41E3A; display:block; margin-top:2px; font-size:11.5px }

    /* CTA with fill sweep */
    .actions{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:18px }
    .cta{
      position:relative; isolation:isolate;
      display:inline-block; padding:14px 24px; border-radius:14px; font:800 15px/1 var(--font);
      color:#fff; background:var(--gold); text-decoration:none; border:1px solid rgba(0,0,0,.08);
      box-shadow:0 12px 26px rgba(133,117,78,.25); overflow:hidden; cursor:pointer;
    }
    .cta[disabled]{ opacity:.55; cursor:not-allowed; box-shadow:none }
    .cta::after{
      content:""; position:absolute; inset:0; z-index:-1; background:var(--gold-dk);
      transform:scaleX(0); transform-origin:left center; transition:transform .35s ease;
    }
    .cta:hover:not([disabled])::after{ transform:scaleX(1) }
    .hint{ color:var(--muted); font-size:12px }

    .foot{ margin-top:14px; color:var(--muted); font-size:12px }

    /* overlay */
    .overlay{
      position:fixed; inset:0; display:grid; place-items:center;
      background:rgba(0,0,0,.14); backdrop-filter:blur(8px) saturate(120%);
      opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:50;
    }
    .overlay.show{ opacity:1; pointer-events:auto; }
    .window{
      background:var(--surface); border:2px solid var(--gold); border-radius:16px;
      padding:22px 26px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,.35);
    }
    .err{ color:#b91c1c; font-size:12px; margin-top:8px; display:none }
    .err.show{ display:block }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    #overlayLogo {
      animation: pulse 1.5s infinite ease-in-out;
    }
  </style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>

  <!-- Header -->
  <header class="site-header">
    <nav class="nav">
      <a class="brand" href="index.html" aria-label="Home">
        <img src="assets/logos/nhlogo.png" alt="Nippon Hasha Inc.">
      </a>
    </nav>
  </header>

  <!-- Form -->
  <main class="stage">
    <section class="card" role="form">
      <div class="form-header" style="display: flex; align-items: center; gap: 12px; font:800 clamp(20px,3.6vw,26px)/1.18 var(--font); margin-bottom:2px">
        <span>Customer Satisfaction Survey</span>
        <img id="branchLogo" src="" alt="Branch logo" style="height: 32px; width: auto; display: none;">
      </div>
      <p class="sub">Enter your details to proceed.</p>

      <form id="gateForm" novalidate>
        <label for="receipt">Receipt Number<span class="req" aria-hidden="true">*</span></label>
        <input id="receipt" name="receipt" type="text" inputmode="text" maxlength="18"
               placeholder="e.g., MDKB-123456-789101" required aria-describedby="receiptHelp receiptErr">
        <div id="receiptHelp" class="hint">
          Branch is auto-detected from your receipt:
          MDKA/B/C/K/M/P, YSKA/C/O/P, MRDR/V, KZCF, KZNM.
        </div>
        <div id="receiptErr" class="err">Unrecognized receipt code. Try MDKA / MDKB / MDKC / MDKK / MDKM / MDKP / YSKA / YSKC / YSKO / YSKP / MRDR / MRDV / KZCF / KZNM.</div>

        <div class="row">
          <div class="col">
            <label for="email">Email<span class="req" aria-hidden="true">*</span></label>
            <input id="email" name="email" type="email" placeholder="you@example.com" required>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label for="name">Name <span class="hint">(optional)</span></label>
            <input id="name" name="name" type="text" placeholder="Juan Dela Cruz">
          </div>
          <div class="col">
            <label for="phone">Contact Number <span class="hint">(optional)</span></label>
            <input id="phone" name="phone" type="tel" inputmode="tel" pattern="^09[0-9]{9}$" placeholder="09XXXXXXXXX">
          </div>
        </div>

        <div class="checks" aria-label="Consent options">
          <label class="check">
            <input  id="dpa" name="dpa" type="checkbox" required>
            <div>
              I agree to the Philippine Data Privacy Act and consent to the processing of my responses for service improvement.
              <small>Required to proceed.</small>
            </div>
          </label>
 
          <label class="check">
            <input id="promo" name="promo" type="checkbox">
            <div>
              I’d like to receive emails about promotions and updates.
              <small>Optional.</small>
            </div>
          </label>
        </div>

        <div class="actions">
          <button id="continueBtn" class="cta" type="submit" disabled>Continue →</button>
          <span id="stateMsg" class="hint" aria-live="polite">Fill the required fields to continue.</span>
        </div>

        <p class="foot">By continuing, you acknowledge Nippon Hasha’s policies and terms of service.</p>
      </form>
    </section>
  </main>

  <!-- loading overlay -->
  <div class="overlay" id="overlay">
    <div class="window">
      <img id="overlayLogo" src="" alt="loading..." style="width: 100px; height: auto; display: none; margin: 0 auto 16px;">
      Submitting…
    </div>
  </div>

  <!-- Supabase JS — UMD build -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <script>
    // ---------- Supabase client ----------
    const SUPABASE_URL = 'https://hxkrwxwrbffjkmepqlbh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4a3J3eHdyYmZmamttZXBxbGJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjQ0MzYsImV4cCI6MjA3MTM0MDQzNn0.clmhrWPkZp9lD1zcUJRDF-2BPlpmt6x2ojNkKwjJBFw';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Receipt → brand/branch routing (front-end only; can be reused server-side later)
    const RECEIPT_META = {
      MDKA:{ brand:'Mendokoro', branch:'Molito (Alabang)', target:'mdsurvey.html' },
      MDKB:{ brand:'Mendokoro', branch:'Bonifacio Global City', target:'mdsurvey.html' },
      MDKC:{ brand:'Mendokoro', branch:'Cebu', target:'mdsurvey.html' },
      MDKK:{ brand:'Mendokoro', branch:'Katipunan', target:'mdsurvey.html' },
      MDKM:{ brand:'Mendokoro', branch:'Salcedo Village (Makati)', target:'mdsurvey.html' },
      MDKP:{ brand:'Mendokoro', branch:'Pasay', target:'mdsurvey.html' },
      YSKA:{ brand:'Yushoken', branch:'Molito (Alabang)', target:'yksurvey.html' },
      YSKC:{ brand:'Yushoken', branch:'Cebu', target:'yksurvey.html' },
      YSKO:{ brand:'Yushoken', branch:'Ortigas', target:'yksurvey.html' },
      YSKP:{ brand:'Yushoken', branch:'Pasay', target:'yksurvey.html' },
      MRDR:{ brand:'Marudori', branch:'Rockwell', target:'mrsurvey.html' },
      MRDV:{ brand:'Marudori', branch:'Vertis North', target:'mrsurvey.html' },
      KZCF:{ brand:'Kazu Café', branch:'Makati', target:'kzcsurvey.html' },
      KZNM:{ brand:'Kazunori', branch:'Makati', target:'kzsurvey.html' },
    };
    const RECEIPT_FALLBACK = {
      MD:{ brand:'Mendokoro', target:'mdsurvey.html' },
      YS:{ brand:'Yushoken', target:'yksurvey.html' },
      MR:{ brand:'Marudori', target:'mrsurvey.html' },
      KZ:{ brand:'Kazunori', target:'kzsurvey.html' },
    };
    function getReceiptMeta(raw){
      const prefix = (raw.match(/^[A-Za-z]{4}/)?.[0] || '').toUpperCase();
      if(prefix && RECEIPT_META[prefix]) return { prefix, ...RECEIPT_META[prefix] };
      const code2 = prefix.slice(0,2);
      if(code2 && RECEIPT_FALLBACK[code2]) return { prefix, ...RECEIPT_FALLBACK[code2] };
      return null;
    }
    function renderBranchPreview(raw){
      const branchLogo = document.getElementById('branchLogo');
      if(!branchLogo) return;

      const meta = getReceiptMeta(raw);
      const brandLogos = {
          'Mendokoro': 'assets/logos/mendokorologo.png',
          'Yushoken': 'assets/logos/yushokenlogo.png',
          'Marudori': 'assets/logos/marudorilogo.png',
          'Kazu Café': 'assets/logos/kzclogo.png',
          'Kazunori': 'assets/logos/kazunorilogo.png'
      };

      if(meta && meta.brand && brandLogos[meta.brand]){
        branchLogo.src = brandLogos[meta.brand];
        branchLogo.alt = `${meta.brand} logo`;
        branchLogo.style.display = 'inline';
      }else{
        branchLogo.style.display = 'none';
      }
    }

    // -------- Receipt formatter + validation ----------
    (function(){
      const receipt = document.getElementById('receipt');
      const pattern = /^[A-Z]{4}-\d{6}-\d{6}$/;
      function formatReceipt(raw){
        const clean = raw.replace(/[^a-zA-Z0-9]/g,'').toUpperCase();
        const brand = clean.replace(/[^A-Z]/g,'').slice(0,4);
        const nums  = clean.replace(/[^0-9]/g,'').slice(0,12);
        const part1 = brand, part2 = nums.slice(0,6), part3 = nums.slice(6,12);
        let out = part1;
        if(part1.length===4 && part2.length>0) out += '-' + part2;
        if(part1.length===4 && part2.length===6 && part3.length>0) out += '-' + part3;
        return out;
      }
      function validateReceipt(){
        const ok = pattern.test(receipt.value.trim());
        receipt.setCustomValidity(ok ? '' : 'Format must be AAAA-000000-000000');
        return ok;
      }
      receipt.addEventListener('input', ()=>{
        const before=receipt.value, caret=receipt.selectionStart;
        receipt.value = formatReceipt(receipt.value);
        if(receipt.value.length>before.length && receipt.value[caret]==='-'){
          receipt.setSelectionRange(caret+1, caret+1);
        }
        validateReceipt(); renderBranchPreview(receipt.value.trim()); window.dispatchEvent(new Event('nh-validate'));
      });
      receipt.addEventListener('blur', ()=>{
        validateReceipt();
        renderBranchPreview(receipt.value.trim());
      });
      renderBranchPreview(receipt.value.trim());
    })();

    // Email message
    (function(){
      const email = document.getElementById('email');
      email.addEventListener('input', ()=> email.setCustomValidity(''));
      email.addEventListener('invalid', ()=>{
        if(email.validity.typeMismatch || email.validity.valueMissing){
          email.setCustomValidity('Please enter a valid email (e.g., you@example.com).');
        }
      });
    })();

    // Contact number (optional, PH mobile format)
    (function(){
      const phone = document.getElementById('phone');
      if(!phone) return;
      const pattern = /^09\d{9}$/;
      function format(value){
        return value.replace(/\D/g,'').slice(0,11);
      }
      function validate(){
        const val = phone.value.trim();
        if(!val){
          phone.setCustomValidity('');
          return true;
        }
        const ok = pattern.test(val);
        phone.setCustomValidity(ok ? '' : 'Enter an 11-digit Philippine mobile number starting with 09.');
        return ok;
      }
      phone.addEventListener('input', ()=>{
        const caret = phone.selectionStart || 0;
        const formatted = format(phone.value);
        phone.value = formatted;
        const pos = Math.min(formatted.length, caret);
        try{ phone.setSelectionRange(pos, pos); }catch(_){}
        validate();
      });
      phone.addEventListener('blur', validate);
    })();

    // Insert + redirect to brand page with KZCF/KZNM handling
    (function(){
      const $ = (s)=>document.querySelector(s);
      const form = $('#gateForm');
      const receipt = $('#receipt');
      const email = $('#email');
      const name = $('#name');
      const phone = $('#phone');
      const dpa = $('#dpa');
      const promo = $('#promo');
      const btn = $('#continueBtn');
      const state = $('#stateMsg');
      const overlay = $('#overlay');
      const errEl = $('#receiptErr');

      const rOK = ()=> /^[A-Z]{4}-\d{6}-\d{6}$/.test(receipt.value.trim());
      const eOK = ()=> email.validity.valid;
      const pOK = ()=> !phone || phone.checkValidity();
      const dOK = ()=> dpa.checked;

      function setState(msg){ state.textContent = msg; }
      function validate(){
        const ok = rOK() && eOK() && dOK() && pOK();
        btn.disabled = !ok;
        setState(ok ? 'All set — press Continue.' : 'Fill the required fields to continue.');
      }
      ['input','change','blur'].forEach(evt => form.addEventListener(evt, validate));
      window.addEventListener('nh-validate', validate);
      document.addEventListener('DOMContentLoaded', validate);

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        validate();
        if(btn.disabled) return;
        if(phone && !phone.checkValidity()){
          phone.reportValidity();
          return;
        }

        const meta = getReceiptMeta(receipt.value.trim());
        if(!meta || !meta.target){
          errEl.classList.add('show');
          setState('Please check your receipt code.');
          receipt.focus();
          return;
        }
        errEl.classList.remove('show');

        const logoEl = document.getElementById('overlayLogo');
        if (logoEl) {
            const brandLogos = {
                'Mendokoro': 'assets/logos/mendokorologo.png',
                'Yushoken': 'assets/logos/yushokenlogo.png',
                'Marudori': 'assets/logos/marudorilogo.png',
                'Kazu Café': 'assets/logos/kzclogo.png',
                'Kazunori': 'assets/logos/kazunorilogo.png'
            };
            if (meta.brand && brandLogos[meta.brand]) {
                logoEl.src = brandLogos[meta.brand];
                logoEl.style.display = 'block';
            }
        }

        overlay.classList.add('show');
        setState('Submitting…');

        const payload = {
          receipt: receipt.value.trim(),
          email: email.value.trim().toLowerCase(),
          name: name.value.trim() || null,
          dpa: true,
          promo: !!promo.checked
        };

        try{
          let record = null;
          const { data, error } = await supabase
            .from('survey_responses')
            .insert([payload])
            .select()
            .single();

          if(error){
            if(error.code === '23505'){
              setState('Receipt found — resuming your survey…');
              const { data: existing, error: updateErr } = await supabase
                .from('survey_responses')
                .update({
                  email: payload.email,
                  name: payload.name,
                  promo: payload.promo,
                  dpa: payload.dpa
                })
                .eq('receipt', payload.receipt)
                .select()
                .maybeSingle();
              if(updateErr){ throw updateErr; }
              record = existing;
              if(!record){
                const { data: fetched, error: fetchErr } = await supabase
                  .from('survey_responses')
                  .select()
                  .eq('receipt', payload.receipt)
                  .maybeSingle();
                if(fetchErr){ throw fetchErr; }
                record = fetched;
              }
            }else{
              throw error;
            }
          }else{
            record = data;
          }

          if(!record){
            throw new Error('We were unable to save your details. Please try again.');
          }

          const params = new URLSearchParams({
            response_id: record.id,
            receipt: record.receipt
          });
          if(meta.brand){ params.set('brand', meta.brand); }
          if(meta.branch){ params.set('branch', meta.branch); }
          const paramsStr = params.toString();

          overlay.querySelector('.window').textContent = 'Loading brand survey…';
          window.location.href = paramsStr ? `${meta.target}?${paramsStr}` : meta.target;
        }catch(err){
          console.error(err);
          setState(err?.message || 'Network error. Please try again.');
          overlay.classList.remove('show');
        }
      });
    })();
  </script>
</body>
</html>
