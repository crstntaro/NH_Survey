<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nippon Hasha ‚Äî Admin Dashboard</title>

  <!-- SECURITY: Security headers via meta tags -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets/logos/nglogocircle.png">
  <link rel="apple-touch-icon" href="assets/logos/nglogocircle.png">

  <!-- Montserrat -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- SheetJS for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <style>
    :root{
      --font:"Montserrat",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;

      --ink:#101010; --muted:#6b7280;
      --gold:#85754E; --gold-dk:#6f6242;
      --navy:#002A3A; --black:#231f20;

      --line:#e7e6e2; --bg:#faf6ef; --surface:#ffffff;
      --bad:#c41e3a; --warn:#ff9d00; --ok:#0e9a5a; --info:#1f6feb;

      --header-h:64px;
      --radius:16px;
      --sea1:.12; --sea2:.05;

      --elev-1: 0 2px 10px rgba(0,0,0,.06);
      --elev-2: 0 12px 26px rgba(0,0,0,.12);
      --dur-fast: .20s;
      --dur-med: .28s;
      --ease: cubic-bezier(.22,.61,.36,1);

      /* Brand colors */
      --brand-yushoken: #f4b400;
      --brand-mendokoro: #c41e3a;
      --brand-kazunori: #2f9e6e;
      --brand-kazucafe: #2f9e6e;
      --brand-marudori: #0e9a5a;
    }

    /* Animated seigaiha background */
    .bg{ position:fixed; inset:0; z-index:-2;
      background: radial-gradient(1200px 360px at 50% -120px, rgba(196,30,58,.09), transparent 65%), var(--bg);
    }
    .bg::before, .bg::after{
      content:""; position:absolute; inset:0; pointer-events:none;
      background-repeat:repeat; background-size:400px 200px; animation: float 34s linear infinite;
    }
    .bg::before{
      opacity:var(--sea1);
      background-image:url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMTUwIiB2aWV3Qm94PSIwIDAgMzAwIDE1MCI+PGRlZnM+PHBhdHRlcm4gaWQ9InMiIHdpZHRoPSI1MCIgaGVpZ2h0PSIyNSIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTTAgMjVhMjUgMjUgMCAwMSA1MCAwIiBmaWxsPSJub25lIiBzdHJva2U9IiNDNDFFM0EiIHN0cm9rZS13aWR0aD0iMSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNzKSIvPjwvc3ZnPg==');
    }
    .bg::after{
      opacity:var(--sea2); animation-duration:48s; animation-direction:reverse; transform:translateY(10px);
      background-image:url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMTUwIiB2aWV3Qm94PSIwIDAgMzAwIDE1MCI+PGRlZnM+PHBhdHRlcm4gaWQ9InMiIHdpZHRoPSI1MCIgaGVpZ2h0PSIyNSIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTTAgMjVhMjUgMjUgMCAwMSA1MCAwIiBmaWxsPSJub25lIiBzdHJva2U9IiMxMDEwMTAiIHN0cm9rZS13aWR0aD0iLjkiIG9wYWNpdHk9Ii4yNSIvPjxwYXRoIGQ9Ik0xMi41IDI1QTEyLjUgMTIuNSAwIDAxMzcgMjUiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzEwMTAxMCIgc3Ryb2tlLXdpZHRoPSIuNiIgb3BhY2l0eT0iLjE4Ii8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI3MpIi8+PC9zdmc+');
    }
    @keyframes float{ from{ background-position:0 0 } to{ background-position:400px 0 } }

    *{ box-sizing:border-box; margin:0; padding:0 }
    html{
      height:100%;
      overflow:hidden;
      background:var(--bg);
      overscroll-behavior:none;
    }
    body{
      height:100%;
      overflow-y:auto;
      overflow-x:hidden;
      overscroll-behavior:none;
      -webkit-overflow-scrolling:touch;
      font-family:var(--font); color:var(--ink); background:var(--bg);
      line-height:1.55;
      opacity:0; transform:translateY(6px); animation:fadeIn .35s var(--ease) forwards;
    }
    @keyframes fadeIn{ to{ opacity:1; transform:none } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    @keyframes fadeInUp { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:none; } }
    @keyframes scaleIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:none; } }
    @keyframes successPulse { 0% { transform:scale(1); } 50% { transform:scale(1.05); } 100% { transform:scale(1); } }

    /* Tab panel animations */
    .tabpanel { animation: fadeInUp 0.3s var(--ease); }
    .tabpanel[hidden] { display:none; }

    /* Card hover effects */
    .card { transition: box-shadow var(--dur-fast) var(--ease), transform var(--dur-fast) var(--ease); }
    .card:hover { box-shadow: var(--elev-2); }

    /* KPI card animations */
    .kpi { transition: transform var(--dur-fast) var(--ease), box-shadow var(--dur-fast) var(--ease); }
    .kpi:hover { transform: translateY(-2px); box-shadow: var(--elev-2); }

    /* Table row animations */
    .table tbody tr { transition: background var(--dur-fast) var(--ease); }

    /* Button press effect */
    .btn:active { transform: scale(0.97); }

    /* Status select transition */
    .statusSel { transition: all var(--dur-fast) var(--ease); }

    /* Admin-specific header - Dark theme */
    .site-header{
      position:sticky; top:0; z-index:30;
      display:none; flex-direction:column; align-items:stretch;
      background: linear-gradient(135deg, #2d2a24 0%, #1a1815 100%);
      border-bottom: 2px solid var(--gold);
      padding:0;
      min-height:var(--header-h);
    }
    .site-header.visible { display:flex; }
    .nav{
      max-width:1200px; margin:0 auto; padding:12px 16px; width:100%;
      display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:16px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .brand img{ height:40px; width:auto; }
    .brand .title{
      font:800 14px/1 var(--font); letter-spacing:.02em; color:#fff;
      display:flex; flex-direction:column; gap:2px;
    }
    .brand .title small { font-size:11px; color:var(--gold); font-weight:700; letter-spacing:.12em; }

    .tabs{ display:flex; gap:6px; align-items:center; justify-content:center; flex-wrap:wrap; }
    .tab{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:8px 16px; border:1px solid rgba(255,255,255,0.2); border-radius:999px;
      background:transparent; font:700 13px/1 var(--font); cursor:pointer;
      white-space:nowrap; transition:all var(--dur-fast) var(--ease);
      color:rgba(255,255,255,0.8); text-decoration:none;
    }
    .tab:hover{ background:rgba(255,255,255,0.1); color:#fff; transform:translateY(-1px); }
    .tab[aria-selected="true"]{ background:var(--gold); color:#fff; border-color:var(--gold); }

    .header-actions{ display:flex; gap:10px; align-items:center; }
    .user-badge {
      height:36px; width:36px; display:grid; place-items:center; border-radius:50%;
      border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.1);
      cursor:pointer; color:#fff; font-size:18px;
      transition:all var(--dur-fast) var(--ease);
    }
    .user-badge:hover { background:rgba(255,255,255,0.2); transform:translateY(-1px); }

    .icon-btn{
      height:36px; width:36px; display:grid; place-items:center; border-radius:10px;
      border:1px solid rgba(255,255,255,0.2); background:transparent; cursor:pointer;
      color:#fff; transition:all var(--dur-fast) var(--ease);
    }
    .icon-btn:hover{ background:rgba(255,255,255,0.1); transform:translateY(-1px); }

    /* Header buttons (white text) */
    .site-header .btn{
      height:36px; padding:0 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.3);
      background:transparent; color:#fff; cursor:pointer; font:700 13px var(--font);
      transition:all var(--dur-fast) var(--ease);
    }
    .site-header .btn:hover{ background:rgba(255,255,255,0.1); transform:translateY(-1px); }

    /* Content area buttons (dark text) */
    .btn{
      height:36px; padding:0 14px; border-radius:10px; border:1px solid var(--line);
      background:var(--surface); color:var(--ink); cursor:pointer; font:700 13px var(--font);
      transition:all var(--dur-fast) var(--ease); box-shadow:var(--elev-1);
    }
    .btn:hover{ background:color-mix(in oklab, var(--surface) 95%, var(--gold)); transform:translateY(-1px); }
    .btn.primary { background:var(--gold); border-color:var(--gold); color:#fff; }
    .btn.primary:hover { background:var(--gold-dk); }
    .btn.danger { background:var(--bad); border-color:var(--bad); color:#fff; }
    .btn.danger:hover { background:#a01830; }
    .btn.success { background:var(--ok); border-color:var(--ok); color:#fff; }
    .btn.success:hover { background:#0b7a48; }

    /* Content area */
    .wrap{ max-width:1200px; margin:0 auto; padding:20px 16px; display:grid; gap:16px; min-height:calc(100vh - var(--header-h)); }
    .card{ background:var(--surface); border:1px solid var(--line); border-radius:var(--radius); padding:20px; box-shadow:var(--elev-1); }
    .card h3{ font:800 18px/1.2 var(--font); margin-bottom:12px; color:var(--black); }
    .card .subtitle { color:var(--muted); font-size:13px; margin-top:-8px; margin-bottom:16px; }

    /* KPI Cards */
    .kpis{ display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:12px; margin-bottom:16px; }
    .kpi{
      border:1px solid var(--line); border-radius:14px; padding:16px;
      background:var(--surface); position:relative; overflow:hidden;
    }
    .kpi .v{ font:800 28px/1 var(--font); color:var(--black); }
    .kpi .l{ color:var(--muted); font-size:12px; margin-top:4px; font-weight:600; }
    .kpi.critical {
      border-left:4px solid var(--bad); background:rgba(196,30,58,0.05);
    }
    .kpi.critical .v { color:var(--bad); }
    .kpi.warning { border-left:4px solid var(--warn); background:rgba(255,157,0,0.05); }
    .kpi.warning .v { color:var(--warn); }
    .kpi.success { border-left:4px solid var(--ok); background:rgba(14,154,90,0.05); }
    .kpi.success .v { color:var(--ok); }
    .kpi.info { border-left:4px solid var(--info); background:rgba(31,111,235,0.05); }
    .kpi.info .v { color:var(--info); }
    .kpi .trend { font-size:11px; color:var(--muted); margin-top:6px; }
    .kpi .trend.up { color:var(--ok); }
    .kpi .trend.down { color:var(--bad); }

    /* NPS Badges */
    .nps-badge {
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius:50%; font:800 14px var(--font);
    }
    .nps-badge.promoter { background:rgba(14,154,90,0.15); color:var(--ok); }
    .nps-badge.passive { background:rgba(255,157,0,0.15); color:var(--warn); }
    .nps-badge.detractor { background:rgba(196,30,58,0.15); color:var(--bad); }

    /* Priority rows */
    .priority-critical { border-left:4px solid var(--bad); background:rgba(196,30,58,0.04); }
    .priority-high { border-left:4px solid var(--warn); background:rgba(255,157,0,0.04); }
    .priority-normal { border-left:4px solid var(--info); }

    /* Aging badges */
    .aging-badge {
      display:inline-flex; padding:4px 10px; border-radius:999px;
      font:700 11px var(--font);
    }
    .aging-badge.urgent { background:var(--bad); color:#fff; animation:pulse 2s infinite; }
    .aging-badge.old { background:var(--warn); color:#fff; }
    .aging-badge.recent { background:var(--muted); color:#fff; }

    /* Tables */
    .table{ width:100%; border-collapse:collapse; }
    .table th{
      text-align:left; padding:12px 10px; font-size:11px; font-weight:800;
      color:var(--muted); text-transform:uppercase; letter-spacing:.05em;
      border-bottom:2px solid var(--line); background:rgba(0,0,0,0.02);
    }
    .table td{ border-bottom:1px solid var(--line); padding:12px 10px; font-size:13px; vertical-align:middle; }
    .table tbody tr:hover{ background:rgba(133,117,78,0.04); }
    .table .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }

    /* Status select */
    .statusSel{
      appearance:none; padding:6px 28px 6px 10px; border-radius:999px;
      border:1px solid var(--line); font:700 11px var(--font); cursor:pointer;
      background-image:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="10" height="6" viewBox="0 0 10 6"%3E%3Cpath fill="%236b7280" d="M5 6L0 0h10z"/%3E%3C/svg%3E');
      background-repeat:no-repeat; background-position:calc(100% - 8px) center;
      transition:all var(--dur-fast) var(--ease);
    }
    .statusSel.open { background-color:rgba(255,157,0,0.15); color:var(--warn); border-color:var(--warn); }
    .statusSel.in_progress { background-color:rgba(31,111,235,0.15); color:var(--info); border-color:var(--info); }
    .statusSel.resolved { background-color:rgba(14,154,90,0.15); color:var(--ok); border-color:var(--ok); }
    .statusSel.voc { background-color:rgba(128,128,128,0.15); color:#666; border-color:#999; }
    .statusSel.inactive { background-color:rgba(0,0,0,0.1); color:#444; border-color:#666; }

    /* Brand tags */
    .brandTag{
      display:inline-flex; align-items:center; gap:6px; padding:4px 10px;
      border-radius:999px; font:700 11px var(--font); background:var(--surface);
      border:1px solid var(--line);
    }
    .brandTag::before{ content:''; width:8px; height:8px; border-radius:50%; background:var(--brand-color); }

    /* Status badges */
    .status-badge {
      display:inline-flex; padding:4px 10px; border-radius:999px;
      font:700 11px var(--font);
    }
    .status-badge.claimed { background:rgba(14,154,90,0.15); color:var(--ok); }
    .status-badge.unclaimed { background:rgba(255,157,0,0.15); color:var(--warn); }

    /* Login screen */
    .login-wrap{ min-height:100dvh; display:grid; place-items:center; padding:24px 16px; background:linear-gradient(135deg, #2d2a24 0%, #1a1815 100%); }
    .login-card{
      width:min(420px,100%); background:var(--surface); border-radius:var(--radius);
      padding:32px; box-shadow:var(--elev-2);
    }
    .login-card .logo-wrap { display:flex; align-items:center; gap:12px; margin-bottom:24px; }
    .login-card .logo-wrap img { height:44px; }
    .login-card .logo-wrap .title { font:800 16px var(--font); color:var(--black); }
    .login-card .logo-wrap .title small { display:block; font-size:12px; color:var(--gold); font-weight:700; letter-spacing:.12em; }
    .login-card h1{ font:800 24px/1.2 var(--font); margin-bottom:8px; color:var(--black); }
    .login-card p{ color:var(--muted); font-size:14px; margin-bottom:20px; }
    .login-card label{ font:700 12px/1 var(--font); color:var(--muted); margin-top:16px; display:block; }
    .login-card input{
      width:100%; padding:14px 16px; border:1px solid var(--line); border-radius:10px;
      margin-top:8px; font:600 14px var(--font); transition:border-color var(--dur-fast) var(--ease);
    }
    .login-card input:focus { outline:none; border-color:var(--gold); }
    .login-error { background:rgba(196,30,58,0.1); border:1px solid var(--bad); color:var(--bad); padding:12px 14px; border-radius:10px; font-size:13px; margin-bottom:16px; }
    .password-wrap { position:relative; }
    .toggle-pw { position:absolute; right:14px; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; font-size:16px; opacity:0.5; }
    .toggle-pw:hover { opacity:1; }
    .login-btn {
      width:100%; height:48px; margin-top:20px; background:var(--gold); color:#fff;
      border:none; border-radius:10px; font:700 14px var(--font); cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:10px;
      transition:background var(--dur-fast) var(--ease);
    }
    .login-btn:hover { background:var(--gold-dk); }
    .login-btn:disabled { opacity:0.6; cursor:not-allowed; }
    .spinner { width:18px; height:18px; border:2px solid rgba(255,255,255,0.3); border-top-color:#fff; border-radius:50%; animation:spin 0.8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* Modal */
    .modal-overlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100;
      display:none; align-items:center; justify-content:center; backdrop-filter:blur(4px);
    }
    .modal-overlay.visible { display:flex; }
    .modal {
      position:relative;
      background:var(--surface); border-radius:var(--radius); padding:24px;
      width:min(480px, 90vw); max-height:85vh; overflow-y:auto;
      box-shadow:var(--elev-2); animation:modalIn .25s var(--ease);
    }
    .modal-close {
      position:absolute;
      top:16px;
      right:16px;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.05);
      border:none;
      border-radius:8px;
      cursor:pointer;
      color:var(--muted);
      transition:all var(--dur-fast) var(--ease);
    }
    .modal-close:hover { background:rgba(0,0,0,0.1); color:var(--ink); }
    @keyframes modalIn { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:none; } }
    .modal h2 { font:800 20px var(--font); margin-bottom:8px; }
    .modal .subtitle { color:var(--muted); font-size:13px; margin-bottom:20px; }
    .modal label { font:700 12px var(--font); color:var(--muted); display:block; margin-top:16px; }
    .modal input {
      width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:10px;
      margin-top:8px; font:600 14px var(--font);
    }
    .modal input:focus { outline:none; border-color:var(--gold); }
    .modal-actions { display:flex; gap:10px; margin-top:24px; justify-content:flex-end; }
    .modal .btn { height:40px; color:var(--ink); background:var(--surface); border:1px solid var(--line); }
    .modal .btn:hover { background:color-mix(in oklab, var(--surface) 95%, var(--gold)); }
    .modal .btn.primary { background:var(--gold); color:#fff; border-color:var(--gold); }
    .modal .btn.primary:hover { background:var(--gold-dk); }
    .modal .success-msg, .success-msg { background:rgba(14,154,90,0.1); color:var(--ok); padding:12px; border-radius:8px; font-size:13px; margin-top:16px; }
    .modal .error-msg, .error-msg { background:rgba(196,30,58,0.1); color:var(--bad); padding:12px; border-radius:8px; font-size:13px; margin-top:16px; }

    /* Validator panel */
    .validator-bar {
      position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:90;
      display:none; place-items:start center; padding-top:100px;
      backdrop-filter:blur(4px);
    }
    .validator-bar.visible { display:grid; }
    .validator-content {
      background:var(--surface); border-radius:var(--radius); padding:24px;
      width:min(600px, 90vw); box-shadow:var(--elev-2);
      animation:modalIn .25s var(--ease);
    }
    .validator-content h3 { font:800 18px var(--font); margin-bottom:4px; }
    .validator-content .subtitle { color:var(--muted); font-size:13px; margin-bottom:20px; }
    .validator-input-wrap { display:flex; gap:10px; margin-bottom:16px; }
    .validator-input-wrap input {
      flex:1; padding:14px 16px; border:1px solid var(--line); border-radius:10px;
      font:600 14px var(--font); font-family:monospace;
    }
    .validator-input-wrap input:focus { outline:none; border-color:var(--gold); }
    .validator-result {
      border:1px solid var(--line); border-radius:12px; padding:16px;
      background:rgba(0,0,0,0.02); min-height:120px;
    }
    .validator-result .status { font:800 16px var(--font); margin-bottom:12px; }
    .validator-result .status.valid { color:var(--ok); }
    .validator-result .status.claimed { color:var(--warn); }
    .validator-result .status.invalid { color:var(--bad); }
    .validator-result .details { display:grid; gap:8px; font-size:13px; }
    .validator-result .details dt { color:var(--muted); font-weight:600; }
    .validator-result .details dd { margin:0; font-weight:700; }
    .validator-actions { display:flex; gap:10px; margin-top:16px; }

    /* Charts container */
    .chart-container { position:relative; height:300px; margin:16px 0; }
    .chart-row { display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:16px; }
    .chart-card { background:var(--surface); border:1px solid var(--line); border-radius:var(--radius); padding:20px; }
    .chart-card h4 { font:800 14px var(--font); margin-bottom:16px; color:var(--black); }

    /* NPS Gauge */
    .nps-gauge-wrap { display:flex; align-items:center; justify-content:center; flex-direction:column; padding:20px; }
    .nps-gauge-value { font:800 48px var(--font); }
    .nps-gauge-value.positive { color:var(--ok); }
    .nps-gauge-value.neutral { color:var(--warn); }
    .nps-gauge-value.negative { color:var(--bad); }
    .nps-gauge-label { color:var(--muted); font-size:12px; margin-top:8px; }

    /* Period selector */
    .period-selector { display:flex; gap:6px; margin-bottom:16px; }
    .period-btn {
      padding:8px 16px; border:1px solid var(--line); border-radius:999px;
      background:var(--surface); font:700 12px var(--font); cursor:pointer;
      transition:all var(--dur-fast) var(--ease);
    }
    .period-btn:hover { background:rgba(0,0,0,0.04); }
    .period-btn.active { background:var(--gold); color:#fff; border-color:var(--gold); }

    /* Export section */
    .export-filters { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:20px; }
    .export-filters .field label { font:700 12px var(--font); color:var(--muted); display:block; margin-bottom:8px; }
    .export-filters .field select,
    .export-filters .field input {
      width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:10px;
      font:600 13px var(--font);
    }
    .export-actions { display:flex; gap:12px; flex-wrap:wrap; }

    /* Empty state */
    .empty{ padding:40px 20px; text-align:center; color:var(--muted); border:1px dashed var(--line); border-radius:12px; font-size:14px; }
    .empty-icon { font-size:32px; margin-bottom:12px; }

    /* Mobile select for tabs */
    .tab-select-wrap { display:none; }
    .tab-select {
      padding:10px 40px 10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.3);
      background:transparent; color:#fff; font:700 13px var(--font);
      appearance:none; cursor:pointer;
      background-image:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="10" height="6" viewBox="0 0 10 6"%3E%3Cpath fill="%23fff" d="M5 6L0 0h10z"/%3E%3C/svg%3E');
      background-repeat:no-repeat; background-position:calc(100% - 14px) center;
    }

    /* Filters panel */
    .filters-panel {
      background:var(--surface); border:1px solid var(--line); border-radius:var(--radius);
      padding:20px; margin-bottom:16px;
    }
    .filters-panel h4 { font:800 14px var(--font); margin-bottom:16px; }
    .filters-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:12px; }
    .filters-grid .field label { font:700 11px var(--font); color:var(--muted); display:block; margin-bottom:6px; }
    .filters-grid .field input,
    .filters-grid .field select {
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:8px;
      font:600 13px var(--font);
    }
    .filter-actions { display:flex; gap:10px; margin-top:16px; justify-content:flex-end; }

    /* Collapsible search/filter */
    .search-toggle-wrap { margin-bottom:16px; }
    .search-toggle-btn {
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 16px; border:1px solid var(--line); border-radius:999px;
      background:var(--surface); font:700 13px var(--font); cursor:pointer;
      transition:all var(--dur-fast) var(--ease); box-shadow:var(--elev-1);
    }
    .search-toggle-btn:hover { background:color-mix(in oklab, var(--surface) 95%, var(--gold)); transform:translateY(-1px); }
    .search-toggle-btn.active { background:var(--gold); color:#fff; border-color:var(--gold); }
    .search-toggle-btn .icon { font-size:16px; }
    .collapsible-filters {
      display:none; margin-top:12px;
      animation:slideDown .25s var(--ease);
    }
    .collapsible-filters.open { display:block; }
    @keyframes slideDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:none; } }

    /* Scrollable table wrapper */
    .table-wrap { overflow-x:auto; }

    /* Hamburger Menu (mobile only) */
    .hamburger {
      display: none;
      flex-direction: column;
      justify-content: center;
      gap: 5px;
      width: 40px;
      height: 40px;
      padding: 8px;
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all var(--dur-fast) var(--ease);
    }
    .hamburger:hover { background: rgba(255,255,255,0.1); }
    .hamburger span {
      display: block;
      width: 100%;
      height: 2px;
      background: #fff;
      border-radius: 2px;
      transition: all var(--dur-fast) var(--ease);
    }
    .hamburger.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
    .hamburger.active span:nth-child(2) { opacity: 0; }
    .hamburger.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }

    /* Sidebar Overlay (mobile only) */
    .sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 40;
      opacity: 0;
      visibility: hidden;
      transition: all var(--dur-med) var(--ease);
      display: none;
    }
    .sidebar-overlay.visible { opacity: 1; visibility: visible; }

    /* Sidebar - Always visible on desktop */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 240px;
      height: 100vh;
      background: linear-gradient(180deg, #2d2a24 0%, #1a1815 100%);
      z-index: 50;
      display: flex;
      flex-direction: column;
      transform: translateX(0);
      transition: transform var(--dur-med) var(--ease);
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .sidebar-close {
      display: none;
      margin-left: auto;
      width: 32px;
      height: 32px;
      place-items: center;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: all var(--dur-fast) var(--ease);
    }
    .sidebar-close:hover { background: rgba(255,255,255,0.2); }

    .sidebar-nav {
      flex: 1;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      overflow-y: auto;
    }
    .sidebar-tab {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: transparent;
      border: none;
      border-radius: 10px;
      color: rgba(255,255,255,0.8);
      font: 600 14px var(--font);
      text-align: left;
      cursor: pointer;
      transition: all var(--dur-fast) var(--ease);
    }
    .sidebar-tab:hover { background: rgba(255,255,255,0.1); color: #fff; }
    .sidebar-tab.active { background: var(--gold); color: #fff; }
    .sidebar-external {
      text-decoration: none;
      color: rgba(14,155,164,0.9);
      border: 1px solid rgba(14,155,164,0.3);
      background: rgba(14,155,164,0.08);
    }
    .sidebar-external:hover {
      background: rgba(14,155,164,0.18);
      color: #0e9ba4;
      border-color: rgba(14,155,164,0.5);
    }

    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .sidebar-footer .btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
    }
    .sidebar-footer .btn:hover { background: rgba(255,255,255,0.1); }

    /* Desktop layout with sidebar */
    .site-header { display: none !important; }
    .site-header.visible { display: none !important; }

    /* Fixed sidebar + scrollable content layout (only when app is visible) */
    body.app-visible {
      height: 100%;
      overflow: hidden;
    }
    body.app-visible .wrap {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 240px;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      box-sizing: border-box;
    }

    /* Sidebar hidden by default (shown via JS when logged in) */
    .sidebar { display: none; }
    .sidebar[style*="flex"] { display: flex; }

    /* NPS Summary Card */
    .nps-summary {
      background: linear-gradient(135deg, #2d2a24 0%, #1a1815 100%);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 16px;
      color: #fff;
    }
    .nps-summary-inner {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      align-items: center;
      justify-content: space-between;
    }
    .nps-main .nps-label {
      font-size: 12px;
      color: var(--gold);
      font-weight: 700;
      letter-spacing: .1em;
      margin-bottom: 4px;
    }
    .nps-main .nps-value {
      font-size: 48px;
      font-weight: 800;
      line-height: 1;
    }
    .nps-main .nps-sublabel {
      font-size: 12px;
      color: rgba(255,255,255,0.7);
      margin-top: 4px;
    }
    .nps-breakdown {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }
    .nps-stat {
      text-align: center;
    }
    .nps-stat-value {
      font-size: 24px;
      font-weight: 800;
    }
    .nps-stat-value.promoter { color: var(--ok); }
    .nps-stat-value.passive { color: var(--warn); }
    .nps-stat-value.detractor { color: var(--bad); }
    .nps-stat-label {
      font-size: 11px;
      color: rgba(255,255,255,0.7);
    }

    /* NPS Category Filter Buttons */
    .nps-category-filters {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .nps-cat-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 18px;
      border-radius: 10px;
      border: 2px solid var(--line);
      background: var(--surface);
      cursor: pointer;
      font-family: var(--font);
      font-weight: 700;
      font-size: 14px;
      transition: all var(--dur-fast) var(--ease);
      color: var(--muted);
      position: relative;
    }
    .nps-cat-btn:hover { transform: translateY(-1px); box-shadow: var(--elev-1); }
    .nps-cat-btn .nps-cat-icon {
      width: 26px; height: 26px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 900; font-size: 14px;
    }
    .nps-cat-btn .nps-cat-count {
      background: var(--line); border-radius: 20px; padding: 2px 8px;
      font-size: 12px; font-weight: 800;
    }
    /* Detractor button */
    .nps-cat-btn.detractor { border-color: rgba(196,30,58,0.3); }
    .nps-cat-btn.detractor .nps-cat-icon { background: rgba(196,30,58,0.15); color: var(--bad); }
    .nps-cat-btn.detractor.active { background: rgba(196,30,58,0.08); border-color: var(--bad); color: var(--bad); }
    .nps-cat-btn.detractor.active .nps-cat-count { background: rgba(196,30,58,0.2); color: var(--bad); }
    /* Passive button */
    .nps-cat-btn.passive { border-color: rgba(255,157,0,0.3); }
    .nps-cat-btn.passive .nps-cat-icon { background: rgba(255,157,0,0.15); color: var(--warn); }
    .nps-cat-btn.passive.active { background: rgba(255,157,0,0.08); border-color: var(--warn); color: var(--warn); }
    .nps-cat-btn.passive.active .nps-cat-count { background: rgba(255,157,0,0.2); color: var(--warn); }
    /* Promoter button */
    .nps-cat-btn.promoter { border-color: rgba(14,154,90,0.3); }
    .nps-cat-btn.promoter .nps-cat-icon { background: rgba(14,154,90,0.15); color: var(--ok); }
    .nps-cat-btn.promoter.active { background: rgba(14,154,90,0.08); border-color: var(--ok); color: var(--ok); }
    .nps-cat-btn.promoter.active .nps-cat-count { background: rgba(14,154,90,0.2); color: var(--ok); }

    /* Mobile responsiveness */
    @media (max-width:900px){
      .kpis { grid-template-columns:repeat(2, 1fr); }
      .nps-category-filters { grid-template-columns:1fr; }
      .filters-grid { grid-template-columns:repeat(2, 1fr); }
      .export-filters { grid-template-columns:repeat(2, 1fr); }

      /* Sidebar becomes slide-out on tablet/mobile */
      .sidebar[style*="flex"] { transform: translateX(-100%); width: 280px; max-width: 85vw; }
      .sidebar.open { transform: translateX(0) !important; }
      .sidebar-overlay { display: block; }
      .sidebar-close { display: grid; }
      body.app-visible { height: auto; overflow: auto; }
      body.app-visible .wrap { position: static; left: 0; width: 100%; max-width: 1200px; padding: 16px; margin: 0 auto; overflow: visible; }

      /* Show header with hamburger */
      .site-header.visible { display: flex !important; }
      .hamburger { display: flex; }
      .tabs { display: none; }
      .tab-select-wrap { display: none; }
    }
    @media (max-width:720px){
      .nav { grid-template-columns:auto auto 1fr; gap:10px; padding:10px 12px; }
      .header-actions { justify-content:flex-end; gap:8px; }
      .header-actions #signOutBtn { display:none; }
      .brand .title { display:none; }
      .brand img { height:32px; }
      .wrap { padding:12px 10px; gap:12px; }
      .card { padding:16px; border-radius:12px; }
      .card h3 { font-size:16px; }
      .validator-input-wrap { flex-direction:column; }
      .validator-input-wrap .btn { width:100%; height:48px; }
    }
    @media (max-width:640px){
      .kpis { grid-template-columns:1fr; gap:10px; }
      .kpi { padding:14px; }
      .kpi .v { font-size:24px; }
      .filters-grid { grid-template-columns:1fr; }
      .export-filters { grid-template-columns:1fr; }
      .filter-actions { flex-direction:column; }
      .filter-actions .btn { width:100%; height:44px; }
      .chart-row { grid-template-columns:1fr; }
      .chart-container { height:250px; }
      .table thead { display:none; }
      .table tr { display:block; border:1px solid var(--line); border-radius:12px; padding:12px; margin-bottom:10px; background:var(--surface); }
      .table td { display:flex; justify-content:space-between; align-items:center; border:none; padding:8px 4px; flex-wrap:wrap; gap:4px; }
      .table td::before { content:attr(data-label); font-weight:700; color:var(--muted); font-size:11px; }
      .table td .btn { height:36px; font-size:12px; }
      .statusSel { font-size:12px; padding:8px 24px 8px 10px; }
      .brandTag { font-size:10px; padding:3px 8px; }
      .nps-badge { width:32px; height:32px; font-size:12px; }
      .aging-badge { font-size:10px; padding:3px 8px; }
      .period-selector { flex-wrap:wrap; gap:8px; }
      .period-btn { padding:10px 14px; font-size:11px; }
      .modal { padding:16px; width:95vw; }
      .modal h2 { font-size:18px; }
      .modal-actions { flex-direction:column; }
      .modal-actions .btn { width:100%; height:44px; }
      .search-toggle-btn { width:100%; justify-content:center; }
      .export-actions { flex-direction:column; }
      .export-actions .btn { width:100%; height:44px; }
      /* NPS Summary mobile */
      .nps-summary { padding:16px; }
      .nps-summary-inner { flex-direction:column; gap:16px; align-items:flex-start; }
      .nps-main .nps-value { font-size:36px; }
      .nps-breakdown { width:100%; justify-content:space-between; gap:12px; }
      .nps-stat { flex:1; min-width:70px; }
      .nps-stat-value { font-size:20px; }
    }
    @media (max-width:400px){
      .kpi .v { font-size:20px; }
      .kpi .l { font-size:10px; }
      .table td { font-size:12px; }
      .nav { padding:8px 10px; }
      .wrap { padding:10px 8px; }
      .card { padding:12px; }
      .login-card { padding:20px; }
      .login-card h1 { font-size:20px; }
      .nps-main .nps-value { font-size:32px; }
      .nps-stat-value { font-size:18px; }
      .nps-breakdown { gap:8px; }
    }
  </style>
</head>
<body>
  <!-- Animated background -->
  <div class="bg" aria-hidden="true"></div>

  <!-- LOGIN -->
  <main id="loginView" class="login-wrap">
    <section class="login-card">
      <div class="logo-wrap">
        <img src="assets/logos/nglogocircle.png" alt="Logo">
        <div class="title"><small>ADMIN DASHBOARD</small></div>
      </div>
      <h1>Welcome back</h1>
      <p>Sign in to access the admin dashboard.</p>

      <div id="loginError" class="login-error" style="display:none"></div>

      <label for="email">Email</label>
      <input id="email" type="email" placeholder="admin@nipponhasha.ph" autocomplete="username" required />

      <label for="password">Password</label>
      <div class="password-wrap">
        <input id="password" type="password" placeholder="Enter your password" autocomplete="current-password" required />
        <button type="button" id="togglePassword" class="toggle-pw">üëÅ</button>
      </div>

      <button id="loginBtn" class="login-btn">
        <span id="loginBtnText">Sign in</span>
        <span id="loginSpinner" class="spinner" style="display:none"></span>
      </button>
    </section>
  </main>

  <!-- HEADER -->
  <header class="site-header" id="appHeader">
    <nav class="nav">
      <!-- Hamburger menu button (mobile only) -->
      <button class="hamburger" id="hamburgerBtn" aria-label="Open menu">
        <span></span>
        <span></span>
        <span></span>
      </button>

      <div class="brand">
        <img src="assets/logos/nglogocircle.png" alt="Logo">
        <div class="title"><small>ADMIN DASHBOARD</small></div>
      </div>

      <div class="tabs" role="tablist">
        <button class="tab" data-tab="overview" aria-selected="true">Overview</button>
        <button class="tab" data-tab="responses">Responses</button>
        <button class="tab" data-tab="validator">Validator</button>
        <button class="tab" data-tab="pending">Pending</button>
        <button class="tab" data-tab="redeemed">Redeemed</button>
        <button class="tab" data-tab="analytics">Analytics</button>
        <button class="tab" data-tab="export">Export</button>
      </div>

      <div class="header-actions">
        <button id="signOutBtn" class="btn">Sign out</button>
      </div>
    </nav>
  </header>

  <!-- Mobile Sidebar Menu -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <img src="assets/logos/nglogocircle.png" alt="Logo" style="height:36px">
      <span style="font:700 14px var(--font); color:var(--gold)">ADMIN</span>
      <button class="sidebar-close" id="sidebarClose">‚úï</button>
    </div>
    <nav class="sidebar-nav">
      <button class="sidebar-tab" data-tab="overview">Overview</button>
      <button class="sidebar-tab" data-tab="responses">Responses</button>
      <button class="sidebar-tab" data-tab="validator">Validator</button>
      <button class="sidebar-tab" data-tab="pending">Pending</button>
      <button class="sidebar-tab" data-tab="redeemed">Redeemed</button>
      <button class="sidebar-tab" data-tab="analytics">Analytics</button>
      <button class="sidebar-tab" data-tab="export">Export</button>
      <div style="border-top:1px solid rgba(255,255,255,0.1); margin:8px 0"></div>
      <a href="https://crstntaro.github.io/NH_FoodTruckSurvey/admin.html" target="_blank" rel="noopener" class="sidebar-tab sidebar-external" title="Opens in new tab">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="flex-shrink:0">
          <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
          <polyline points="15 3 21 3 21 9"></polyline>
          <line x1="10" y1="14" x2="21" y2="3"></line>
        </svg>
        Food Truck
      </a>
    </nav>
    <div class="sidebar-footer">
      <button class="sidebar-tab" data-tab="profile" style="width:100%;margin-bottom:10px;background:rgba(255,255,255,0.05)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        Profile
      </button>
      <button id="sidebarSignOut" class="btn" style="width:100%">Sign out</button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main id="appView" class="wrap" style="display:none">

    <!-- OVERVIEW TAB - Win-Back Dashboard -->
    <section class="tabpanel" id="tab-overview">
      <div class="card">
        <h3>NPS Dashboard</h3>
        <p class="subtitle">Monitor all NPS categories. Detractors are prioritized for win-back, with promoters and passives also tracked.</p>

        <div class="kpis" id="overviewKpis">
          <div class="kpi critical">
            <div class="v" id="kpiCritical">-</div>
            <div class="l">Critical (NPS 0-3)</div>
          </div>
          <div class="kpi warning">
            <div class="v" id="kpiDetractors">-</div>
            <div class="l">Detractors (NPS 4-6)</div>
          </div>
          <div class="kpi info">
            <div class="v" id="kpiOpenTickets">-</div>
            <div class="l">Open Tickets</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiOldestUnresolved">-</div>
            <div class="l">Oldest Unresolved</div>
          </div>
          <div class="kpi" style="border-left:4px solid #444; background:rgba(0,0,0,0.05)">
            <div class="v" id="kpiInactive" style="color:#444">-</div>
            <div class="l">Inactive (30+ days)</div>
          </div>
        </div>

        <!-- Overall NPS Summary -->
        <div class="nps-summary">
          <div class="nps-summary-inner">
            <div class="nps-main">
              <div class="nps-label">OVERALL NPS SCORE</div>
              <div class="nps-value" id="overviewNpsScore">-</div>
              <div class="nps-sublabel" id="overviewNpsLabel">Net Promoter Score</div>
            </div>
            <div class="nps-breakdown">
              <div class="nps-stat">
                <div class="nps-stat-value promoter" id="overviewPromoters">-</div>
                <div class="nps-stat-label">Promoters (9-10)</div>
              </div>
              <div class="nps-stat">
                <div class="nps-stat-value passive" id="overviewPassives">-</div>
                <div class="nps-stat-label">Passives (7-8)</div>
              </div>
              <div class="nps-stat">
                <div class="nps-stat-value detractor" id="overviewDetractorsPct">-</div>
                <div class="nps-stat-label">Detractors (0-6)</div>
              </div>
              <div class="nps-stat">
                <div class="nps-stat-value" id="overviewTotalResponses">-</div>
                <div class="nps-stat-label">Total Responses</div>
              </div>
            </div>
          </div>
        </div>

        <!-- NPS Category Filter Buttons -->
        <div class="nps-category-filters">
          <button class="nps-cat-btn active detractor" data-nps-cat="detractors" id="btnDetractors">
            <span class="nps-cat-icon">!</span>
            <span class="nps-cat-label">Detractors</span>
            <span class="nps-cat-count" id="btnDetractorsCount">0</span>
          </button>
          <button class="nps-cat-btn passive" data-nps-cat="passives" id="btnPassives">
            <span class="nps-cat-icon">~</span>
            <span class="nps-cat-label">Passives</span>
            <span class="nps-cat-count" id="btnPassivesCount">0</span>
          </button>
          <button class="nps-cat-btn promoter" data-nps-cat="promoters" id="btnPromoters">
            <span class="nps-cat-icon">&#x2713;</span>
            <span class="nps-cat-label">Promoters</span>
            <span class="nps-cat-count" id="btnPromotersCount">0</span>
          </button>
        </div>

        <div class="table-wrap">
          <table class="table" id="detractorsTable">
            <thead id="overviewTableHead">
              <tr>
                <th>Age</th>
                <th>NPS</th>
                <th>Brand / Branch</th>
                <th>Customer</th>
                <th>Concern</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="detractorsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- RESPONSES TAB -->
    <section class="tabpanel" id="tab-responses" hidden>
      <div class="card">
        <h3>All Responses</h3>
        <p class="subtitle">View all completed survey responses from Supabase.</p>

        <div class="search-toggle-wrap">
          <button class="search-toggle-btn" id="respSearchToggle">
            <span class="icon">üîç</span>
            <span>Search & Filter</span>
          </button>
        </div>

        <div class="collapsible-filters" id="respFiltersCollapsible">
          <div class="filters-panel">
            <h4>Filters</h4>
            <div class="filters-grid">
              <div class="field">
                <label>Search</label>
                <input type="text" id="respFilterSearch" placeholder="Name, receipt, email...">
              </div>
              <div class="field">
                <label>Brand</label>
                <select id="respFilterBrand">
                  <option value="">All Brands</option>
                  <option value="Ramen Yushoken">Ramen Yushoken</option>
                  <option value="Mendokoro">Mendokoro</option>
                  <option value="Marudori">Marudori</option>
                  <option value="Kazu Caf√©">Kazu Caf√©</option>
                  <option value="Kazunori">Kazunori</option>
                </select>
              </div>
              <div class="field" id="branchFilterWrap" style="display:none">
                <label>Branch/Store</label>
                <select id="respFilterBranch">
                  <option value="">All Branches</option>
                </select>
              </div>
              <div class="field">
                <label>NPS Category</label>
                <select id="respFilterNps">
                  <option value="">All</option>
                  <option value="detractor">Detractors (0-6)</option>
                  <option value="passive">Passives (7-8)</option>
                  <option value="promoter">Promoters (9-10)</option>
                </select>
              </div>
              <div class="field">
                <label>Date From</label>
                <input type="date" id="respFilterFrom">
              </div>
              <div class="field">
                <label>Date To</label>
                <input type="date" id="respFilterTo">
              </div>
            </div>
            <div class="filter-actions">
              <button class="btn" id="respClearFilters">Clear</button>
              <button class="btn primary" id="respApplyFilters">Apply Filters</button>
            </div>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table" id="responsesTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Customer</th>
                <th>Brand / Branch</th>
                <th>Receipt</th>
                <th>NPS</th>
                <th>Ticket</th>
                <th>Reward</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="responsesBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- VALIDATOR TAB -->
    <section class="tabpanel" id="tab-validator" hidden>
      <div class="card">
        <h3>Receipt & Code Validator</h3>
        <p class="subtitle">Validate reward codes and mark them as redeemed when customers claim their rewards.</p>

        <div class="validator-input-wrap">
          <input type="text" id="validatorInput" placeholder="Enter reward code or receipt number..." class="mono">
          <button class="btn primary" id="validateBtn">Validate</button>
        </div>

        <div class="validator-result" id="validatorResult">
          <div class="status" id="validatorStatus">Enter a code or receipt to validate</div>
          <div class="details" id="validatorDetails" style="display:none">
            <dl>
              <dt>Customer</dt>
              <dd id="valCustomer">-</dd>
              <dt>NPS Score</dt>
              <dd id="valNps">-</dd>
              <dt>Receipt</dt>
              <dd id="valReceipt">-</dd>
              <dt>Reward Code</dt>
              <dd id="valCode">-</dd>
              <dt>Status</dt>
              <dd id="valRewardStatus">-</dd>
              <dt>Survey Date</dt>
              <dd id="valDate">-</dd>
            </dl>
          </div>
        </div>

        <div class="validator-actions" id="validatorActions" style="display:none">
          <button class="btn success" id="markRedeemedBtn">Mark as Redeemed</button>
        </div>
      </div>
    </section>

    <!-- PENDING REWARDS TAB -->
    <section class="tabpanel" id="tab-pending" hidden>
      <div class="card">
        <h3>Pending Rewards</h3>
        <p class="subtitle">Unclaimed rewards awaiting redemption. Rewards expire 30 days after survey completion.</p>

        <div class="search-toggle-wrap">
          <button class="search-toggle-btn" id="pendingSearchToggle">
            <span class="icon">üîç</span>
            <span>Search & Filter</span>
          </button>
        </div>

        <div class="collapsible-filters" id="pendingFiltersCollapsible">
          <div class="filters-panel">
            <h4>Filters</h4>
            <div class="filters-grid">
              <div class="field">
                <label>Search</label>
                <input type="text" id="pendingFilterSearch" placeholder="Name, code, receipt, email...">
              </div>
              <div class="field">
                <label>Brand</label>
                <select id="pendingFilterBrand">
                  <option value="">All Brands</option>
                  <option value="Ramen Yushoken">Ramen Yushoken</option>
                  <option value="Mendokoro">Mendokoro</option>
                  <option value="Marudori">Marudori</option>
                  <option value="Kazu Caf√©">Kazu Caf√©</option>
                  <option value="Kazunori">Kazunori</option>
                </select>
              </div>
              <div class="field" id="pendingBranchFilterWrap" style="display:none">
                <label>Branch/Store</label>
                <select id="pendingFilterBranch">
                  <option value="">All Branches</option>
                </select>
              </div>
              <div class="field">
                <label>Status</label>
                <select id="pendingFilterStatus">
                  <option value="">All</option>
                  <option value="valid">Valid (< 30 days)</option>
                  <option value="expiring">Expiring Soon (< 7 days)</option>
                  <option value="expired">Expired (> 30 days)</option>
                </select>
              </div>
            </div>
            <div class="filter-actions">
              <button class="btn" id="pendingClearFilters">Clear</button>
              <button class="btn primary" id="pendingApplyFilters">Apply Filters</button>
            </div>
          </div>
        </div>

        <div class="kpis" id="pendingKpis">
          <div class="kpi info">
            <div class="v" id="kpiTotalPending">-</div>
            <div class="l">Total Pending</div>
          </div>
          <div class="kpi success">
            <div class="v" id="kpiValidPending">-</div>
            <div class="l">Valid (< 30 days)</div>
          </div>
          <div class="kpi warning">
            <div class="v" id="kpiExpiringSoon">-</div>
            <div class="l">Expiring Soon (< 7 days)</div>
          </div>
          <div class="kpi critical">
            <div class="v" id="kpiExpired">-</div>
            <div class="l">Expired</div>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table" id="pendingTable">
            <thead>
              <tr>
                <th>Survey Date</th>
                <th>Customer</th>
                <th>Reward Code</th>
                <th>Receipt</th>
                <th>Brand / Branch</th>
                <th>Days Left</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="pendingBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- REDEEMED TAB -->
    <section class="tabpanel" id="tab-redeemed" hidden>
      <div class="card">
        <h3>Redeemed Rewards</h3>
        <p class="subtitle">View all claimed rewards with their redemption details.</p>

        <div class="search-toggle-wrap">
          <button class="search-toggle-btn" id="redeemedSearchToggle">
            <span class="icon">üîç</span>
            <span>Search & Filter</span>
          </button>
        </div>

        <div class="collapsible-filters" id="redeemedFiltersCollapsible">
          <div class="filters-panel">
            <h4>Filters</h4>
            <div class="filters-grid">
              <div class="field">
                <label>Search</label>
                <input type="text" id="redeemedFilterSearch" placeholder="Name, code, receipt, email...">
              </div>
              <div class="field">
                <label>Brand</label>
                <select id="redeemedFilterBrand">
                  <option value="">All Brands</option>
                  <option value="Ramen Yushoken">Ramen Yushoken</option>
                  <option value="Mendokoro">Mendokoro</option>
                  <option value="Marudori">Marudori</option>
                  <option value="Kazu Caf√©">Kazu Caf√©</option>
                  <option value="Kazunori">Kazunori</option>
                </select>
              </div>
              <div class="field" id="redeemedBranchFilterWrap" style="display:none">
                <label>Branch/Store</label>
                <select id="redeemedFilterBranch">
                  <option value="">All Branches</option>
                </select>
              </div>
              <div class="field">
                <label>Date From</label>
                <input type="date" id="redeemedFilterFrom">
              </div>
              <div class="field">
                <label>Date To</label>
                <input type="date" id="redeemedFilterTo">
              </div>
            </div>
            <div class="filter-actions">
              <button class="btn" id="redeemedClearFilters">Clear</button>
              <button class="btn primary" id="redeemedApplyFilters">Apply Filters</button>
            </div>
          </div>
        </div>

        <div class="kpis" id="redeemedKpis">
          <div class="kpi success">
            <div class="v" id="kpiTotalRedeemed">-</div>
            <div class="l">Total Redeemed</div>
          </div>
          <div class="kpi info">
            <div class="v" id="kpiRedeemedToday">-</div>
            <div class="l">Redeemed Today</div>
          </div>
          <div class="kpi warning">
            <div class="v" id="kpiRedeemedThisWeek">-</div>
            <div class="l">This Week</div>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table" id="redeemedTable">
            <thead>
              <tr>
                <th>Redeemed At</th>
                <th>Customer</th>
                <th>Reward Code</th>
                <th>Receipt</th>
                <th>Survey Brand/Branch</th>
                <th>Redeemed By</th>
                <th>Redeemed At (Location)</th>
              </tr>
            </thead>
            <tbody id="redeemedBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ANALYTICS TAB -->
    <section class="tabpanel" id="tab-analytics" hidden>
      <div class="card">
        <h3>Analytics Dashboard</h3>
        <p class="subtitle">Multi-brand NPS analysis and trends for executive review.</p>

        <div class="period-selector">
          <button class="period-btn active" data-period="7">Last 7 Days</button>
          <button class="period-btn" data-period="30">Last 30 Days</button>
          <button class="period-btn" data-period="90">Last 90 Days</button>
          <button class="period-btn" data-period="all">All Time</button>
        </div>

        <div class="kpis" id="analyticsKpis">
          <div class="kpi">
            <div class="v" id="kpiNpsScore">-</div>
            <div class="l">Overall NPS Score</div>
          </div>
          <div class="kpi success">
            <div class="v" id="kpiPromoters">-</div>
            <div class="l">Promoters (9-10)</div>
          </div>
          <div class="kpi warning">
            <div class="v" id="kpiPassives">-</div>
            <div class="l">Passives (7-8)</div>
          </div>
          <div class="kpi critical">
            <div class="v" id="kpiDetractorsPct">-</div>
            <div class="l">Detractors (0-6)</div>
          </div>
          <div class="kpi info">
            <div class="v" id="kpiTotalResponses">-</div>
            <div class="l">Total Responses</div>
          </div>
        </div>

        <div class="chart-row">
          <div class="chart-card">
            <h4>NPS Category Distribution</h4>
            <div class="chart-container">
              <canvas id="npsCategoryChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h4>Brand NPS Comparison</h4>
            <div class="chart-container">
              <canvas id="brandNpsChart"></canvas>
            </div>
          </div>
        </div>

        <div class="chart-row" style="margin-top:16px">
          <div class="chart-card">
            <h4>NPS Trend Over Time</h4>
            <div class="chart-container">
              <canvas id="npsTrendChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h4>Responses by Brand</h4>
            <div class="chart-container">
              <canvas id="brandResponsesChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <h4 style="font:800 14px var(--font); margin-bottom:12px">Recent Detractor Comments</h4>
          <div id="detractorComments"></div>
        </div>
      </div>
    </section>

    <!-- EXPORT TAB -->
    <section class="tabpanel" id="tab-export" hidden>
      <div class="card">
        <h3>Export Data</h3>
        <p class="subtitle">Download survey responses in Excel or CSV format.</p>

        <div class="export-filters">
          <div class="field">
            <label>Brand</label>
            <select id="exportBrand">
              <option value="">All Brands</option>
              <option value="Ramen Yushoken">Ramen Yushoken</option>
              <option value="Mendokoro">Mendokoro</option>
              <option value="Marudori">Marudori</option>
              <option value="Kazu Caf√©">Kazu Caf√©</option>
              <option value="Kazunori">Kazunori</option>
            </select>
          </div>
          <div class="field">
            <label>NPS Category</label>
            <select id="exportNps">
              <option value="">All</option>
              <option value="detractor">Detractors Only</option>
              <option value="passive">Passives Only</option>
              <option value="promoter">Promoters Only</option>
            </select>
          </div>
          <div class="field">
            <label>Date From</label>
            <input type="date" id="exportFrom">
          </div>
          <div class="field">
            <label>Date To</label>
            <input type="date" id="exportTo">
          </div>
        </div>

        <div class="kpis" style="margin-bottom:20px">
          <div class="kpi info">
            <div class="v" id="exportPreviewCount">-</div>
            <div class="l">Records to Export</div>
          </div>
        </div>

        <div class="export-actions">
          <button class="btn primary" id="exportExcelBtn">Download Excel (.xlsx)</button>
          <button class="btn" id="exportCsvBtn">Download CSV</button>
        </div>
      </div>
    </section>

    <!-- PROFILE TAB -->
    <section class="tabpanel" id="tab-profile" hidden>
      <!-- Profile Header Card -->
      <div class="card" style="background:linear-gradient(135deg, #2d2a24 0%, #1a1815 100%); border:none; margin-bottom:16px">
        <div style="display:flex; gap:20px; align-items:center; flex-wrap:wrap">
          <div id="tabProfilePicPreview" style="width:72px; height:72px; border-radius:50%; background:var(--gold); display:flex; align-items:center; justify-content:center; font:800 24px var(--font); color:#fff; border:3px solid rgba(255,255,255,0.2)">
            <span id="tabProfileInitials">A</span>
          </div>
          <div style="flex:1; min-width:200px">
            <div style="font:800 20px var(--font); color:#fff" id="tabProfileDisplayName">-</div>
            <div style="font-size:13px; color:rgba(255,255,255,0.7); margin-top:4px" id="tabProfileEmail">-</div>
            <div style="display:inline-block; margin-top:8px; padding:4px 12px; background:var(--gold); border-radius:999px; font:700 11px var(--font); color:#fff" id="tabProfileRole">-</div>
          </div>
        </div>
      </div>

      <!-- Settings Cards Grid -->
      <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:16px">
        <!-- Profile Settings Card -->
        <div class="card">
          <h3 style="display:flex; align-items:center; gap:10px">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Profile Settings
          </h3>
          <p class="subtitle">Update your profile information</p>

          <!-- Profile Picture Upload -->
          <label style="font:700 11px var(--font); color:var(--muted); display:block; margin-bottom:6px">Profile Picture</label>
          <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px">
            <div id="tabProfilePicEdit" style="width:64px; height:64px; border-radius:50%; background:var(--gold); display:flex; align-items:center; justify-content:center; font:800 20px var(--font); color:#fff; overflow:hidden; border:2px solid var(--line)">
              <span id="tabProfilePicInitials">A</span>
            </div>
            <div style="flex:1">
              <input type="file" id="tabProfilePicFile" accept="image/*" style="display:none">
              <button type="button" class="btn" id="tabUploadPicBtn" style="font-size:12px; padding:8px 16px">Upload Photo</button>
              <button type="button" class="btn" id="tabRemovePicBtn" style="font-size:12px; padding:8px 12px; margin-left:8px; display:none">Remove</button>
              <p style="font-size:11px; color:var(--muted); margin:6px 0 0">Max 1MB. JPG, PNG, or GIF.</p>
            </div>
          </div>
          <input type="hidden" id="tabProfilePicData">

          <label style="font:700 11px var(--font); color:var(--muted); display:block; margin-bottom:6px">Display Name</label>
          <input type="text" id="tabDisplayNameInput" placeholder="Enter your name" style="width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:10px; font:500 14px var(--font); margin-bottom:12px">
          <div id="tabProfileSaveMsg"></div>
          <button class="btn primary" id="tabSaveProfileBtn" style="width:100%; height:44px">Save Profile</button>
        </div>

        <!-- Security Card -->
        <div class="card">
          <h3 style="display:flex; align-items:center; gap:10px">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            Security
          </h3>
          <p class="subtitle">Change your password</p>

          <label style="font:700 11px var(--font); color:var(--muted); display:block; margin-bottom:6px">Current Password</label>
          <input type="password" id="tabCurrentPassword" placeholder="Enter current password" style="width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:10px; font:500 14px var(--font); margin-bottom:12px">

          <label style="font:700 11px var(--font); color:var(--muted); display:block; margin-bottom:6px">New Password</label>
          <input type="password" id="tabNewPassword" placeholder="Enter new password" style="width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:10px; font:500 14px var(--font); margin-bottom:12px">

          <label style="font:700 11px var(--font); color:var(--muted); display:block; margin-bottom:6px">Confirm New Password</label>
          <input type="password" id="tabConfirmPassword" placeholder="Confirm new password" style="width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:10px; font:500 14px var(--font); margin-bottom:12px">

          <div id="tabPasswordMsg"></div>
          <button class="btn" id="tabChangePasswordBtn" style="width:100%; height:44px">Change Password</button>
        </div>

        <!-- Account Info Card -->
        <div class="card">
          <h3 style="display:flex; align-items:center; gap:10px">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            Account Info
          </h3>
          <p class="subtitle">Your account details</p>

          <div style="display:grid; gap:12px">
            <div style="display:flex; justify-content:space-between; padding:12px; background:rgba(0,0,0,0.03); border-radius:10px">
              <span style="font:600 13px var(--font); color:var(--muted)">Email</span>
              <span style="font:600 13px var(--font)" id="tabProfileEmailInfo">-</span>
            </div>
            <div style="display:flex; justify-content:space-between; padding:12px; background:rgba(0,0,0,0.03); border-radius:10px">
              <span style="font:600 13px var(--font); color:var(--muted)">Role</span>
              <span style="font:600 13px var(--font)" id="tabProfileRoleInfo">-</span>
            </div>
            <div style="display:flex; justify-content:space-between; padding:12px; background:rgba(0,0,0,0.03); border-radius:10px">
              <span style="font:600 13px var(--font); color:var(--muted)">Brand Access</span>
              <span style="font:600 13px var(--font)" id="tabProfileBrandInfo">-</span>
            </div>
            <div style="display:flex; justify-content:space-between; padding:12px; background:rgba(0,0,0,0.03); border-radius:10px">
              <span style="font:600 13px var(--font); color:var(--muted)">Branch Access</span>
              <span style="font:600 13px var(--font)" id="tabProfileBranchInfo">-</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- PROFILE MODAL -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal" style="position:relative">
      <button class="modal-close" id="profileModalClose" aria-label="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <h2>Account Settings</h2>
      <p class="subtitle">Manage your admin account</p>

      <div style="display:flex; gap:16px; align-items:center; background:rgba(0,0,0,0.03); padding:16px; border-radius:10px; margin-bottom:20px">
        <div id="profilePicPreview" style="width:60px; height:60px; border-radius:50%; background:var(--gold); display:flex; align-items:center; justify-content:center; font:800 20px var(--font); color:#fff; overflow:hidden">
          <span id="profileInitials">A</span>
        </div>
        <div style="flex:1">
          <div style="font:700 14px var(--font)" id="profileDisplayName">-</div>
          <div style="font-size:12px; color:var(--muted)" id="profileEmail">-</div>
          <div style="font-size:11px; color:var(--muted)" id="profileRole">-</div>
        </div>
      </div>

      <h4 style="font:700 14px var(--font); margin-bottom:12px">Profile Info</h4>
      <label for="displayNameInput">Display Name</label>
      <input type="text" id="displayNameInput" placeholder="Your name">
      <label for="profilePicFile">Profile Picture</label>
      <input type="file" id="profilePicFile" accept="image/*" style="padding:8px">
      <input type="hidden" id="profilePicInput">
      <button class="btn primary" id="saveProfileBtn" style="margin-top:12px; width:100%">Save Profile</button>
      <div id="profileSaveMsg" style="margin-top:8px"></div>

      <hr style="border:none; border-top:1px solid var(--line); margin:20px 0">

      <h4 style="font:700 14px var(--font); margin-bottom:4px">Change Password</h4>
      <p style="font-size:12px; color:var(--muted); margin-bottom:12px">You'll need to sign in again after changing your password.</p>

      <div id="passwordMsg"></div>

      <label for="currentPassword">Current Password</label>
      <input type="password" id="currentPassword" placeholder="Enter current password">

      <label for="newPassword">New Password</label>
      <input type="password" id="newPassword" placeholder="Enter new password">

      <label for="confirmPassword">Confirm New Password</label>
      <input type="password" id="confirmPassword" placeholder="Confirm new password">

      <div class="modal-actions">
        <button class="btn" id="closeProfileBtn">Cancel</button>
        <button class="btn primary" id="changePasswordBtn">Change Password</button>
      </div>
    </div>
  </div>

  <!-- RESPONSE DETAIL MODAL -->
  <div class="modal-overlay" id="responseDetailModal">
    <div class="modal" style="max-width:600px;position:relative">
      <button class="modal-close" id="responseDetailModalClose" aria-label="Close">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      <h2>Response Details</h2>
      <p class="subtitle" id="detailSubtitle">-</p>
      <div id="responseDetailContent"></div>
      <div class="modal-actions">
        <button class="btn" id="closeDetailBtn">Close</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- CONFIG ---------- */
    const SUPABASE_URL = 'https://hxkrwxwrbffjkmepqlbh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4a3J3eHdyYmZmamttZXBxbGJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjQ0MzYsImV4cCI6MjA3MTM0MDQzNn0.clmhrWPkZp9lD1zcUJRDF-2BPlpmt6x2ojNkKwjJBFw';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ---------- Brand Config ---------- */
    const brandMeta = {
      'Ramen Yushoken': { color: '#f4b400', route: 'YSHK', branches: ['Molito (Alabang)', 'Cebu', 'Ortigas', 'Pasay'] },
      'Mendokoro': { color: '#c41e3a', route: 'MDNK', branches: ['Molito (Alabang)', 'Bonifacio Global City', 'Cebu', 'Katipunan', 'Salcedo Village (Makati)', 'Pasay'] },
      'Marudori': { color: '#0e9a5a', route: 'MRDR', branches: ['Rockwell', 'Vertis North'] },
      'Kazu Caf√©': { color: '#2f9e6e', route: 'KZCF', branches: ['Kazu Caf√© (Makati)'] },
      'Kazunori': { color: '#2f9e6e', route: 'KZNR', branches: ['Kazunori (Makati)'] }
    };

    // All unique branches across all brands
    const allBranches = [
      'Molito (Alabang)', 'Bonifacio Global City', 'Cebu', 'Katipunan',
      'Salcedo Village (Makati)', 'Pasay', 'Ortigas', 'Rockwell',
      'Vertis North', 'Kazu Caf√© (Makati)', 'Kazunori (Makati)'
    ];

    /* ---------- State ---------- */
    let currentUser = null;
    let allResponses = [];
    let filteredResponses = [];
    let activeTab = 'overview';
    let analyticsPeriod = 7;
    let charts = {};

    /* ---------- DOM Elements ---------- */
    const loginView = document.getElementById('loginView');
    const appView = document.getElementById('appView');
    const appHeader = document.getElementById('appHeader');
    const loginBtn = document.getElementById('loginBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userBadge = document.getElementById('userBadge');
    const tabBtns = Array.from(document.querySelectorAll('.tab[data-tab]'));
    const tabPanels = Array.from(document.querySelectorAll('.tabpanel'));
    const tabSelect = document.getElementById('tabSelect');

    /* ---------- DataService ---------- */
    const DataService = {
      async fetchResponses() {
        try {
          console.log('Fetching survey responses...');
          const { data, error } = await sb
            .from('survey_responses')
            .select('*')
            .not('completed_at', 'is', null)
            .order('completed_at', { ascending: false });

          if (error) {
            console.error('Supabase query error:', error);
            throw error;
          }
          console.log(`Fetched ${data?.length || 0} responses`);
          return data || [];
        } catch (err) {
          console.error('Error fetching responses:', err);
          // Show error to user
          alert('Failed to load survey data. Please check the console for details and refresh the page.');
          return [];
        }
      },

      async updateTicketStatus(id, status) {
        try {
          const token = localStorage.getItem('admin_token');
          const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/update-status`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`,
              'apikey': SUPABASE_ANON_KEY
            },
            body: JSON.stringify({ id, status })
          });

          const data = await response.json();
          if (!response.ok || !data.success) throw new Error(data.error || 'Update failed');
          return true;
        } catch (err) {
          console.error('Error updating ticket status:', err);
          return false;
        }
      },

      async markRewardClaimed(id) {
        try {
          const token = localStorage.getItem('admin_token');
          const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/mark-redeemed`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`,
              'apikey': SUPABASE_ANON_KEY
            },
            body: JSON.stringify({ id })
          });

          const data = await response.json();
          if (!response.ok || !data.success) throw new Error(data.error || 'Update failed');
          return true;
        } catch (err) {
          console.error('Error marking reward claimed:', err);
          return false;
        }
      },

      async findByCodeOrReceipt(query) {
        try {
          // Try to find by reward code first
          let { data, error } = await sb
            .from('survey_responses')
            .select('*')
            .eq('reward_code', query.toUpperCase())
            .single();

          if (!data) {
            // Try to find by receipt
            const result = await sb
              .from('survey_responses')
              .select('*')
              .eq('receipt', query.toUpperCase())
              .single();
            data = result.data;
            error = result.error;
          }

          if (error && error.code !== 'PGRST116') throw error;
          return data;
        } catch (err) {
          console.error('Error finding response:', err);
          return null;
        }
      },

      getDetractors(responses) {
        return responses
          .filter(r => r.q12 !== null && r.q12 <= 6)
          .sort((a, b) => {
            // Sort by priority: Critical (NPS 0-3) first, then by age (oldest first)
            const aNps = a.q12;
            const bNps = b.q12;
            const aDays = Math.floor((Date.now() - new Date(a.completed_at).getTime()) / 86400000);
            const bDays = Math.floor((Date.now() - new Date(b.completed_at).getTime()) / 86400000);

            // Priority score: lower is higher priority
            // Critical (NPS 0-3) = 0, Urgent (>7 days) = 1, High (>3 days) = 2, Normal = 3
            const getPriorityScore = (nps, days) => {
              if (nps <= 3) return 0; // Critical
              if (days > 7) return 1; // Urgent
              if (days > 3) return 2; // High
              return 3; // Normal
            };

            const aPriority = getPriorityScore(aNps, aDays);
            const bPriority = getPriorityScore(bNps, bDays);

            // Sort by priority first, then by days old (oldest first)
            if (aPriority !== bPriority) return aPriority - bPriority;
            return bDays - aDays; // Older first within same priority
          });
      },

      calculateNPS(responses) {
        const scored = responses.filter(r => r.q12 !== null);
        if (scored.length === 0) return { score: 0, promoters: 0, passives: 0, detractors: 0, total: 0 };

        const promoters = scored.filter(r => r.q12 >= 9).length;
        const passives = scored.filter(r => r.q12 >= 7 && r.q12 <= 8).length;
        const detractors = scored.filter(r => r.q12 <= 6).length;
        const total = scored.length;

        const score = Math.round(((promoters - detractors) / total) * 100);

        return { score, promoters, passives, detractors, total };
      },

      calculateBrandNPS(responses) {
        const brandData = {};
        for (const brand of Object.keys(brandMeta)) {
          const brandResponses = responses.filter(r => r.brand === brand);
          brandData[brand] = this.calculateNPS(brandResponses);
        }
        return brandData;
      }
    };

    /* ---------- Security Utility Functions ---------- */
    // SECURITY: Escape HTML to prevent XSS attacks
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      const div = document.createElement('div');
      div.textContent = String(str);
      return div.innerHTML;
    }

    // SECURITY: Sanitize user input for display
    function sanitize(str) {
      return escapeHtml(str);
    }

    // SECURITY: Validate and sanitize URL for images
    function sanitizeImageUrl(url) {
      if (!url) return '';
      // Only allow data URLs (base64) or https URLs
      if (url.startsWith('data:image/')) return url;
      if (url.startsWith('https://')) return encodeURI(url);
      return ''; // Reject other URLs
    }

    // SECURITY: Validate password strength
    function isStrongPassword(password) {
      if (password.length < 12) return { valid: false, message: 'Password must be at least 12 characters' };
      if (!/[A-Z]/.test(password)) return { valid: false, message: 'Password must contain at least one uppercase letter' };
      if (!/[a-z]/.test(password)) return { valid: false, message: 'Password must contain at least one lowercase letter' };
      if (!/[0-9]/.test(password)) return { valid: false, message: 'Password must contain at least one number' };
      if (!/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password)) return { valid: false, message: 'Password must contain at least one special character' };
      return { valid: true, message: '' };
    }

    /* ---------- Utility Functions ---------- */
    // Calculate average of all slider ratings (q5-q11, 1-5 scale) and convert to 0-10
    function calculateAvgRating(r) {
      const ratings = [r.q5, r.q6, r.q7, r.q8, r.q10, r.q11].filter(v => v !== null && v !== undefined);
      if (ratings.length === 0) return null;
      const avg = ratings.reduce((a, b) => a + Number(b), 0) / ratings.length;
      return Math.round((avg - 1) * 2.5); // Convert 1-5 to 0-10 scale
    }

    function getNPSCategory(score) {
      if (score === null || score === undefined) return 'unknown';
      if (score >= 9) return 'promoter';
      if (score >= 7) return 'passive';
      return 'detractor';
    }

    function humanAgo(dateStr) {
      if (!dateStr) return '-';
      const ms = Date.now() - new Date(dateStr).getTime();
      const days = Math.floor(ms / 86400000);
      const hours = Math.floor((ms % 86400000) / 3600000);
      if (days > 0) return `${days}d ${hours}h`;
      if (hours > 0) return `${hours}h`;
      return '<1h';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('en-PH', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });
    }

    function getPriorityClass(nps, daysOld) {
      if (nps <= 3 || daysOld > 7) return 'priority-critical';
      if (nps <= 6 || daysOld > 3) return 'priority-high';
      return 'priority-normal';
    }

    function getAgingBadge(dateStr, ticketStatus) {
      const days = Math.floor((Date.now() - new Date(dateStr).getTime()) / 86400000);
      // Mark as inactive if 30+ days old and not resolved
      if (days >= 30 && ticketStatus !== 'resolved') {
        return `<span class="aging-badge" style="background:#444;color:#fff">${days}d - Inactive</span>`;
      }
      if (days > 7) return `<span class="aging-badge urgent">${days}d ago</span>`;
      if (days > 3) return `<span class="aging-badge old">${days}d ago</span>`;
      return `<span class="aging-badge recent">${humanAgo(dateStr)}</span>`;
    }

    function isCustomerInactive(response) {
      if (!response.completed_at) return false;
      if (response.ticket_status === 'resolved' || response.ticket_status === 'inactive') return false;
      const days = Math.floor((Date.now() - new Date(response.completed_at).getTime()) / 86400000);
      return days >= 30;
    }

    function brandBadge(brand) {
      const meta = brandMeta[brand] || { color: '#6b7280' };
      return `<span class="brandTag" style="--brand-color:${meta.color}">${brand || '-'}</span>`;
    }

    function npsBadge(score) {
      if (score === null || score === undefined) return '<span class="nps-badge">-</span>';
      const cat = getNPSCategory(score);
      return `<span class="nps-badge ${cat}">${score}</span>`;
    }

    /* ---------- Login Functions ---------- */
    function showLoginError(message) {
      const errorEl = document.getElementById('loginError');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => { errorEl.style.display = 'none'; }, 5000);
    }

    function setLoginLoading(isLoading) {
      const btn = document.getElementById('loginBtn');
      const text = document.getElementById('loginBtnText');
      const spinner = document.getElementById('loginSpinner');
      btn.disabled = isLoading;
      text.textContent = isLoading ? 'Signing in...' : 'Sign in';
      spinner.style.display = isLoading ? 'inline-block' : 'none';
    }

    function showApp() {
      loginView.style.display = 'none';
      appHeader.classList.add('visible');
      appView.style.display = 'grid';

      // Show sidebar
      if (sidebar) sidebar.style.display = 'flex';

      // Enable fixed sidebar layout
      document.body.classList.add('app-visible');

      // Update user badge if it exists
      if (currentUser && userBadge) {
        userBadge.title = `${currentUser.email}\n${currentUser.brand || 'All Brands'} - ${currentUser.role || 'admin'}`;
      }

      // Apply role-based tab visibility
      applyRolePermissions();

      initApp();
    }

    function applyRolePermissions() {
      const role = currentUser?.role || 'validator';
      const isValidator = role === 'validator' || role === 'branch_validator';
      const isSuperAdminRole = role === 'super_admin';
      const isBrandManager = role === 'brand_manager' || role === 'branch_manager';

      // Tabs that validators can NOT see (they can only see: validator, pending, redeemed, profile)
      const restrictedTabs = ['overview', 'responses', 'analytics', 'export'];

      // Hide/show sidebar tabs based on role
      sidebarTabs.forEach(tab => {
        const tabId = tab.dataset.tab;
        if (isValidator && restrictedTabs.includes(tabId)) {
          tab.style.display = 'none';
        } else {
          tab.style.display = '';
        }
      });

      // Hide/show header tabs based on role
      tabBtns.forEach(tab => {
        const tabId = tab.dataset.tab;
        if (isValidator && restrictedTabs.includes(tabId)) {
          tab.style.display = 'none';
        } else {
          tab.style.display = '';
        }
      });

      // Set default tab based on role
      if (isValidator) {
        setTab('validator');
      } else {
        setTab('overview');
      }
    }

    function showLogin() {
      loginView.style.display = 'grid';
      appHeader.classList.remove('visible');
      appView.style.display = 'none';

      // Hide sidebar
      if (sidebar) sidebar.style.display = 'none';
      closeSidebar();

      // Disable fixed sidebar layout
      document.body.classList.remove('app-visible');
    }

    /* ---------- Password Toggle ---------- */
    document.getElementById('togglePassword')?.addEventListener('click', () => {
      const pw = document.getElementById('password');
      const toggle = document.getElementById('togglePassword');
      if (pw.type === 'password') {
        pw.type = 'text';
        toggle.textContent = 'üôà';
      } else {
        pw.type = 'password';
        toggle.textContent = 'üëÅ';
      }
    });

    /* ---------- Sidebar Menu ---------- */
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const sidebarClose = document.getElementById('sidebarClose');
    const sidebarTabs = document.querySelectorAll('.sidebar-tab');
    const sidebarSignOut = document.getElementById('sidebarSignOut');

    function openSidebar() {
      sidebar.classList.add('open');
      sidebarOverlay.classList.add('visible');
      hamburgerBtn?.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeSidebar() {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('visible');
      hamburgerBtn?.classList.remove('active');
      document.body.style.overflow = '';
    }

    hamburgerBtn?.addEventListener('click', () => {
      if (sidebar.classList.contains('open')) {
        closeSidebar();
      } else {
        openSidebar();
      }
    });

    sidebarOverlay?.addEventListener('click', closeSidebar);
    sidebarClose?.addEventListener('click', closeSidebar);

    sidebarTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.dataset.tab;
        setTab(tabId);
        closeSidebar();
        // Update active state
        sidebarTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
      });
    });

    sidebarSignOut?.addEventListener('click', async () => {
      closeSidebar();
      await handleSignOut();
    });

    // Update sidebar active state when tab changes
    function updateSidebarActiveTab(tabId) {
      sidebarTabs.forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tabId);
      });
    }

    /* ---------- Login Handler ---------- */
    loginBtn.addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password) {
        showLoginError('Please enter email and password');
        return;
      }

      setLoginLoading(true);

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // Store tokens and user info
          localStorage.setItem('admin_token', data.token);
          localStorage.setItem('admin_refresh_token', data.refresh_token);
          localStorage.setItem('admin_user', JSON.stringify(data.user));
          currentUser = data.user;

          // Set the session on the Supabase client for authenticated operations
          await sb.auth.setSession({
            access_token: data.token,
            refresh_token: data.refresh_token
          });

          showApp();
        } else {
          showLoginError(data.error || 'Invalid credentials');
        }
      } catch (err) {
        console.error('Login failed:', err);
        showLoginError('Connection failed. Please try again.');
      } finally {
        setLoginLoading(false);
      }
    });

    // Enter key for login
    document.getElementById('password')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') loginBtn.click();
    });

    /* ---------- Sign Out Handler ---------- */
    async function handleSignOut() {
      const token = localStorage.getItem('admin_token');

      // Clear local storage FIRST to ensure logout even if API fails
      localStorage.removeItem('admin_token');
      localStorage.removeItem('admin_refresh_token');
      localStorage.removeItem('admin_user');
      currentUser = null;
      if (userBadge) userBadge.title = 'Click to manage profile';

      // Sign out from Supabase client
      await sb.auth.signOut();

      if (token) {
        try {
          await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/logout`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`,
              'apikey': SUPABASE_ANON_KEY
            },
            body: JSON.stringify({})
          });
        } catch (err) {
          console.error('Logout API call failed:', err);
        }
      }

      // Force page reload to clear any state
      window.location.href = window.location.pathname;
    }

    signOutBtn?.addEventListener('click', handleSignOut);

    /* ---------- Tab Navigation ---------- */
    function setTab(id) {
      if (!id) return;
      activeTab = id;

      tabBtns.forEach(btn => {
        btn.setAttribute('aria-selected', String(btn.dataset.tab === id));
      });

      tabPanels.forEach(panel => {
        const isActive = panel.id === 'tab-' + id;
        panel.hidden = !isActive;
      });

      if (tabSelect) tabSelect.value = id;

      // Update sidebar active state
      if (typeof updateSidebarActiveTab === 'function') {
        updateSidebarActiveTab(id);
      }

      // Scroll to top smoothly when switching tabs
      window.scrollTo({ top: 0, behavior: 'smooth' });

      // Refresh tab content
      if (id === 'overview') paintOverview();
      if (id === 'responses') paintResponses();
      if (id === 'pending') paintPending();
      if (id === 'redeemed') paintRedeemed();
      if (id === 'analytics') paintAnalytics();
      if (id === 'export') updateExportPreview();
      if (id === 'profile') paintProfile();
    }

    /* ---------- Profile Tab ---------- */
    function paintProfile() {
      const name = currentUser?.display_name || '';
      const pic = currentUser?.profile_pic || '';
      const role = currentUser?.role || 'admin';
      const brand = currentUser?.brand || 'All Brands';
      const branch = currentUser?.branch || 'All Branches';

      // Header section
      const displayNameEl = document.getElementById('tabProfileDisplayName');
      const emailEl = document.getElementById('tabProfileEmail');
      const roleEl = document.getElementById('tabProfileRole');
      const inputEl = document.getElementById('tabDisplayNameInput');
      const initialsEl = document.getElementById('tabProfileInitials');
      const headerPicEl = document.getElementById('tabProfilePicPreview');

      if (displayNameEl) displayNameEl.textContent = name || currentUser?.email || '-';
      if (emailEl) emailEl.textContent = currentUser?.email || '-';
      if (roleEl) roleEl.textContent = role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
      if (inputEl) inputEl.value = name;

      const initials = getInitials(name, currentUser?.email);
      if (initialsEl) initialsEl.textContent = initials;

      // Header profile picture
      if (headerPicEl) {
        if (pic) {
          const safePic = sanitizeImageUrl(pic);
          headerPicEl.innerHTML = safePic ? `<img src="${safePic}" style="width:100%;height:100%;object-fit:cover">` : `<span id="tabProfileInitials">${initials}</span>`;
        } else {
          headerPicEl.innerHTML = `<span id="tabProfileInitials">${initials}</span>`;
        }
      }

      // Edit form profile picture
      const editPicEl = document.getElementById('tabProfilePicEdit');
      const picDataEl = document.getElementById('tabProfilePicData');
      const removeBtnEl = document.getElementById('tabRemovePicBtn');

      if (editPicEl) {
        if (pic) {
          const safePic = sanitizeImageUrl(pic);
          editPicEl.innerHTML = safePic ? `<img src="${safePic}" style="width:100%;height:100%;object-fit:cover">` : `<span id="tabProfilePicInitials">${initials}</span>`;
        } else {
          editPicEl.innerHTML = `<span id="tabProfilePicInitials">${initials}</span>`;
        }
      }
      if (picDataEl) picDataEl.value = pic || '';
      if (removeBtnEl) removeBtnEl.style.display = pic ? 'inline-block' : 'none';

      // Account Info section
      const emailInfoEl = document.getElementById('tabProfileEmailInfo');
      const roleInfoEl = document.getElementById('tabProfileRoleInfo');
      const brandInfoEl = document.getElementById('tabProfileBrandInfo');
      const branchInfoEl = document.getElementById('tabProfileBranchInfo');

      if (emailInfoEl) emailInfoEl.textContent = currentUser?.email || '-';
      if (roleInfoEl) roleInfoEl.textContent = role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
      if (brandInfoEl) brandInfoEl.textContent = brand;
      if (branchInfoEl) branchInfoEl.textContent = branch;

      // Clear messages and password fields
      const pwMsg = document.getElementById('tabPasswordMsg');
      const saveMsg = document.getElementById('tabProfileSaveMsg');
      if (pwMsg) pwMsg.innerHTML = '';
      if (saveMsg) saveMsg.innerHTML = '';

      // Clear password fields
      const currPw = document.getElementById('tabCurrentPassword');
      const newPw = document.getElementById('tabNewPassword');
      const confPw = document.getElementById('tabConfirmPassword');
      if (currPw) currPw.value = '';
      if (newPw) newPw.value = '';
      if (confPw) confPw.value = '';
    }

    function getInitials(name, email) {
      if (name) {
        const parts = name.split(' ');
        return parts.length > 1 ? (parts[0][0] + parts[1][0]).toUpperCase() : name.substring(0, 2).toUpperCase();
      }
      return email ? email.substring(0, 2).toUpperCase() : 'A';
    }

    // Profile picture upload button
    document.getElementById('tabUploadPicBtn')?.addEventListener('click', () => {
      document.getElementById('tabProfilePicFile').click();
    });

    // Profile picture file selection
    document.getElementById('tabProfilePicFile')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (file.size > 1000000) {
        document.getElementById('tabProfileSaveMsg').innerHTML = '<div class="error-msg">Image must be under 1MB</div>';
        return;
      }

      const reader = new FileReader();
      reader.onload = (ev) => {
        const result = ev.target.result;
        const safeUrl = sanitizeImageUrl(result);
        if (safeUrl) {
          document.getElementById('tabProfilePicData').value = safeUrl;
          document.getElementById('tabProfilePicEdit').innerHTML = `<img src="${safeUrl}" style="width:100%;height:100%;object-fit:cover">`;
          document.getElementById('tabRemovePicBtn').style.display = 'inline-block';
          document.getElementById('tabProfileSaveMsg').innerHTML = '<div style="color:var(--gold);font-size:12px">Click "Save Profile" to apply changes</div>';
        }
      };
      reader.readAsDataURL(file);
    });

    // Remove profile picture button
    document.getElementById('tabRemovePicBtn')?.addEventListener('click', () => {
      document.getElementById('tabProfilePicData').value = '';
      document.getElementById('tabProfilePicEdit').innerHTML = `<span id="tabProfilePicInitials">${getInitials(currentUser?.display_name, currentUser?.email)}</span>`;
      document.getElementById('tabRemovePicBtn').style.display = 'none';
      document.getElementById('tabProfileSaveMsg').innerHTML = '<div style="color:var(--gold);font-size:12px">Click "Save Profile" to apply changes</div>';
    });

    // Profile tab save button
    document.getElementById('tabSaveProfileBtn')?.addEventListener('click', async () => {
      const displayName = document.getElementById('tabDisplayNameInput').value.trim();
      const profilePic = document.getElementById('tabProfilePicData').value;
      const msgEl = document.getElementById('tabProfileSaveMsg');
      const btn = document.getElementById('tabSaveProfileBtn');

      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        const token = localStorage.getItem('admin_token');
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/update-profile`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ display_name: displayName, profile_pic: profilePic })
        });
        const data = await response.json();
        if (response.ok && data.success) {
          currentUser.display_name = displayName;
          currentUser.profile_pic = profilePic;
          localStorage.setItem('admin_user', JSON.stringify(currentUser));

          msgEl.innerHTML = '<div class="success-msg">Profile saved successfully!</div>';

          // Update header display
          document.getElementById('tabProfileDisplayName').textContent = displayName || currentUser?.email || '-';
          document.getElementById('tabProfileInitials').textContent = getInitials(displayName, currentUser?.email);

          // Update header profile picture
          const headerPic = document.getElementById('tabProfilePicPreview');
          if (headerPic) {
            if (profilePic) {
              headerPic.innerHTML = `<img src="${sanitizeImageUrl(profilePic)}" style="width:100%;height:100%;object-fit:cover">`;
            } else {
              headerPic.innerHTML = `<span id="tabProfileInitials">${getInitials(displayName, currentUser?.email)}</span>`;
            }
          }

          // Update remove button visibility
          document.getElementById('tabRemovePicBtn').style.display = profilePic ? 'inline-block' : 'none';
        } else {
          msgEl.innerHTML = `<div class="error-msg">${sanitize(data.error) || 'Failed to save profile'}</div>`;
        }
      } catch (err) {
        msgEl.innerHTML = '<div class="error-msg">Connection failed. Please try again.</div>';
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Profile';
      }
    });

    // Profile tab change password
    document.getElementById('tabChangePasswordBtn')?.addEventListener('click', async () => {
      const current = document.getElementById('tabCurrentPassword').value;
      const newPw = document.getElementById('tabNewPassword').value;
      const confirm = document.getElementById('tabConfirmPassword').value;
      const msgEl = document.getElementById('tabPasswordMsg');

      if (!current || !newPw || !confirm) {
        msgEl.innerHTML = '<div class="error-msg">Please fill in all fields</div>';
        return;
      }
      if (newPw !== confirm) {
        msgEl.innerHTML = '<div class="error-msg">New passwords do not match</div>';
        return;
      }
      // SECURITY: Enforce strong password requirements
      const passwordCheck = isStrongPassword(newPw);
      if (!passwordCheck.valid) {
        msgEl.innerHTML = `<div class="error-msg">${sanitize(passwordCheck.message)}</div>`;
        return;
      }

      try {
        const token = localStorage.getItem('admin_token');
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/change-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ current_password: current, new_password: newPw })
        });
        const data = await response.json();
        if (response.ok && data.success) {
          msgEl.innerHTML = '<div class="success-msg">Password changed successfully! Signing out...</div>';
          document.getElementById('tabCurrentPassword').value = '';
          document.getElementById('tabNewPassword').value = '';
          document.getElementById('tabConfirmPassword').value = '';
          setTimeout(() => {
            sidebarSignOut.click();
          }, 2000);
        } else {
          msgEl.innerHTML = `<div class="error-msg">${sanitize(data.error) || 'Failed to change password'}</div>`;
        }
      } catch (err) {
        msgEl.innerHTML = '<div class="error-msg">Connection failed. Please try again.</div>';
      }
    });

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => setTab(btn.dataset.tab));
    });

    if (tabSelect) {
      tabSelect.addEventListener('change', (e) => setTab(e.target.value));
    }

    /* ---------- Profile Modal ---------- */
    function getInitials(name, email) {
      if (name) return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0,2);
      if (email) return email[0].toUpperCase();
      return 'A';
    }

    userBadge?.addEventListener('click', () => {
      document.getElementById('profileModal').classList.add('visible');
      const name = currentUser?.display_name || '';
      const pic = currentUser?.profile_pic || '';
      document.getElementById('profileDisplayName').textContent = name || currentUser?.email || '-';
      document.getElementById('profileEmail').textContent = currentUser?.email || '-';
      document.getElementById('profileRole').textContent = `${currentUser?.brand || 'All Brands'} - ${currentUser?.role || 'Admin'}`;
      document.getElementById('displayNameInput').value = name;
      document.getElementById('profilePicInput').value = pic;
      document.getElementById('profileInitials').textContent = getInitials(name, currentUser?.email);
      if (pic) {
        const safePic = sanitizeImageUrl(pic);
        document.getElementById('profilePicPreview').innerHTML = safePic ? `<img src="${safePic}" style="width:100%;height:100%;object-fit:cover">` : '';
      }
      document.getElementById('passwordMsg').innerHTML = '';
      document.getElementById('profileSaveMsg').innerHTML = '';
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    });

    document.getElementById('profilePicFile')?.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (file.size > 500000) { alert('Image must be under 500KB'); return; }
      const reader = new FileReader();
      reader.onload = (ev) => {
        const safePic = sanitizeImageUrl(ev.target.result);
        if (safePic) {
          document.getElementById('profilePicInput').value = safePic;
          document.getElementById('profilePicPreview').innerHTML = `<img src="${safePic}" style="width:100%;height:100%;object-fit:cover">`;
        }
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('saveProfileBtn')?.addEventListener('click', async () => {
      const name = document.getElementById('displayNameInput').value.trim();
      const pic = document.getElementById('profilePicInput').value;
      const msgEl = document.getElementById('profileSaveMsg');
      try {
        const { error } = await sb.from('admin_users').update({ display_name: name, profile_pic: pic }).eq('email', currentUser?.email);
        if (error) throw error;
        currentUser.display_name = name;
        currentUser.profile_pic = pic;
        localStorage.setItem('admin_user', JSON.stringify(currentUser));
        if (userBadge) userBadge.title = `${name || currentUser.email}\n${currentUser.brand || 'All Brands'} - ${currentUser.role || 'admin'}`;
        msgEl.innerHTML = '<div class="success-msg">Profile saved!</div>';
      } catch (err) {
        msgEl.innerHTML = '<div class="error-msg">Failed to save</div>';
      }
    });

    document.getElementById('closeProfileBtn').addEventListener('click', () => {
      document.getElementById('profileModal').classList.remove('visible');
    });

    document.getElementById('profileModalClose')?.addEventListener('click', () => {
      document.getElementById('profileModal').classList.remove('visible');
    });

    document.getElementById('changePasswordBtn').addEventListener('click', async () => {
      const current = document.getElementById('currentPassword').value;
      const newPw = document.getElementById('newPassword').value;
      const confirm = document.getElementById('confirmPassword').value;
      const msgEl = document.getElementById('passwordMsg');

      if (!current || !newPw || !confirm) {
        msgEl.innerHTML = '<div class="error-msg">Please fill in all fields</div>';
        return;
      }

      if (newPw !== confirm) {
        msgEl.innerHTML = '<div class="error-msg">New passwords do not match</div>';
        return;
      }

      // SECURITY: Enforce strong password requirements
      const passwordCheck = isStrongPassword(newPw);
      if (!passwordCheck.valid) {
        msgEl.innerHTML = `<div class="error-msg">${sanitize(passwordCheck.message)}</div>`;
        return;
      }

      try {
        const token = localStorage.getItem('admin_token');
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/change-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ current_password: current, new_password: newPw })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          msgEl.innerHTML = '<div class="success-msg">Password changed successfully! Signing out...</div>';
          setTimeout(() => {
            document.getElementById('profileModal').classList.remove('visible');
            signOutBtn.click();
          }, 2000);
        } else {
          msgEl.innerHTML = `<div class="error-msg">${sanitize(data.error) || 'Failed to change password'}</div>`;
        }
      } catch (err) {
        console.error('Password change failed:', err);
        msgEl.innerHTML = '<div class="error-msg">Connection failed. Please try again.</div>';
      }
    });

    // Close modal on overlay click
    document.getElementById('profileModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('profileModal')) {
        document.getElementById('profileModal').classList.remove('visible');
      }
    });

    /* ---------- Access Control ---------- */
    function isSuperAdmin() {
      return currentUser?.role === 'super_admin' || currentUser?.brand === 'All';
    }

    function isBrandManager() {
      return currentUser?.role === 'brand_manager' || currentUser?.role === 'branch_manager';
    }

    function isValidator() {
      return currentUser?.role === 'validator' || currentUser?.role === 'branch_validator';
    }

    function filterByUserAccess(responses) {
      // Super admin sees everything
      if (isSuperAdmin()) return responses;

      // Brand manager sees all branches within their brand
      if (isBrandManager()) {
        return responses.filter(r => r.brand === currentUser?.brand);
      }

      // Branch admin sees only their branch
      if (currentUser?.branch && currentUser.branch !== 'All') {
        return responses.filter(r =>
          r.brand === currentUser?.brand && r.branch === currentUser?.branch
        );
      }

      // Default: filter by brand only
      return responses.filter(r => r.brand === currentUser?.brand);
    }

    /* ---------- App Initialization ---------- */
    async function initApp() {
      console.log('Initializing app...');
      // Fetch real data from Supabase
      allResponses = await DataService.fetchResponses();
      console.log('Total responses loaded:', allResponses.length);
      // For Responses/Analytics/Export: filter by user access
      filteredResponses = filterByUserAccess([...allResponses]);
      console.log('Filtered responses:', filteredResponses.length);

      // Show branch filter for super admin and populate with unique branches
      if (isSuperAdmin()) {
        const uniqueBranches = [...new Set(allResponses.map(r => r.branch).filter(Boolean))].sort();

        // Responses tab branch filter
        const branchFilterWrap = document.getElementById('branchFilterWrap');
        const branchSelect = document.getElementById('respFilterBranch');
        if (branchFilterWrap && branchSelect) {
          branchFilterWrap.style.display = 'block';
          uniqueBranches.forEach(branch => {
            const option = document.createElement('option');
            option.value = branch;
            option.textContent = branch;
            branchSelect.appendChild(option);
          });
        }

        // Redeemed tab branch filter
        const redeemedBranchFilterWrap = document.getElementById('redeemedBranchFilterWrap');
        const redeemedBranchSelect = document.getElementById('redeemedFilterBranch');
        if (redeemedBranchFilterWrap && redeemedBranchSelect) {
          redeemedBranchFilterWrap.style.display = 'block';
          uniqueBranches.forEach(branch => {
            const option = document.createElement('option');
            option.value = branch;
            option.textContent = branch;
            redeemedBranchSelect.appendChild(option);
          });
        }

        // Pending tab branch filter
        const pendingBranchFilterWrap = document.getElementById('pendingBranchFilterWrap');
        const pendingBranchSelect = document.getElementById('pendingFilterBranch');
        if (pendingBranchFilterWrap && pendingBranchSelect) {
          pendingBranchFilterWrap.style.display = 'block';
          uniqueBranches.forEach(branch => {
            const option = document.createElement('option');
            option.value = branch;
            option.textContent = branch;
            pendingBranchSelect.appendChild(option);
          });
        }
      }

      // Paint initial view
      setTab('overview');
    }

    /* ---------- Overview Tab ---------- */
    let overviewNpsCat = 'detractors'; // default category shown

    function paintOverview() {
      const detractors = DataService.getDetractors(allResponses);
      const critical = detractors.filter(r => r.q12 <= 3);
      const openTickets = allResponses.filter(r => r.ticket_status === 'open' || !r.ticket_status);

      // Calculate oldest unresolved
      let oldestUnresolved = '-';
      const unresolvedDetractors = detractors.filter(r => r.ticket_status !== 'resolved');
      if (unresolvedDetractors.length > 0) {
        const oldest = unresolvedDetractors[0]; // Already sorted oldest first
        const days = Math.floor((Date.now() - new Date(oldest.completed_at).getTime()) / 86400000);
        oldestUnresolved = `${days}d`;
      }

      // Count inactive customers (30+ days without resolution)
      const inactiveCustomers = allResponses.filter(r => isCustomerInactive(r));

      // Update KPIs
      document.getElementById('kpiCritical').textContent = critical.length;
      document.getElementById('kpiDetractors').textContent = detractors.length - critical.length;
      document.getElementById('kpiOpenTickets').textContent = openTickets.length;
      document.getElementById('kpiOldestUnresolved').textContent = oldestUnresolved;
      document.getElementById('kpiInactive').textContent = inactiveCustomers.length;

      // Calculate and display overall NPS
      const npsData = DataService.calculateNPS(allResponses);
      const npsScoreEl = document.getElementById('overviewNpsScore');
      npsScoreEl.textContent = npsData.score;
      npsScoreEl.style.color = npsData.score > 0 ? 'var(--ok)' : npsData.score < 0 ? 'var(--bad)' : 'var(--warn)';

      document.getElementById('overviewPromoters').textContent = `${npsData.total ? Math.round((npsData.promoters / npsData.total) * 100) : 0}%`;
      document.getElementById('overviewPassives').textContent = `${npsData.total ? Math.round((npsData.passives / npsData.total) * 100) : 0}%`;
      document.getElementById('overviewDetractorsPct').textContent = `${npsData.total ? Math.round((npsData.detractors / npsData.total) * 100) : 0}%`;
      document.getElementById('overviewTotalResponses').textContent = npsData.total;

      // Update category button counts
      const promoters = allResponses.filter(r => r.q12 !== null && r.q12 >= 9);
      const passives = allResponses.filter(r => r.q12 !== null && r.q12 >= 7 && r.q12 <= 8);
      document.getElementById('btnDetractorsCount').textContent = detractors.length;
      document.getElementById('btnPassivesCount').textContent = passives.length;
      document.getElementById('btnPromotersCount').textContent = promoters.length;

      // Setup category button click handlers (only once)
      if (!paintOverview._listenersAttached) {
        document.querySelectorAll('.nps-cat-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            overviewNpsCat = btn.dataset.npsCat;
            document.querySelectorAll('.nps-cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            paintOverviewTable();
          });
        });
        paintOverview._listenersAttached = true;
      }

      paintOverviewTable();
    }

    function paintOverviewTable() {
      const tbody = document.getElementById('detractorsBody');
      const thead = document.getElementById('overviewTableHead');
      tbody.innerHTML = '';

      let rows = [];
      let emptyMsg = '';
      let emptyIcon = '';

      if (overviewNpsCat === 'detractors') {
        rows = DataService.getDetractors(allResponses);
        emptyMsg = 'No detractors found! Great job!';
        emptyIcon = '&#127881;';
        thead.innerHTML = `<tr><th>Age</th><th>NPS</th><th>Brand / Branch</th><th>Customer</th><th>Concern</th><th>Priority</th><th>Status</th><th>Actions</th></tr>`;
      } else if (overviewNpsCat === 'passives') {
        rows = allResponses.filter(r => r.q12 !== null && r.q12 >= 7 && r.q12 <= 8)
          .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));
        emptyMsg = 'No passives found.';
        emptyIcon = '&#128203;';
        thead.innerHTML = `<tr><th>Age</th><th>NPS</th><th>Brand / Branch</th><th>Customer</th><th>Feedback</th><th>Status</th><th>Actions</th></tr>`;
      } else {
        rows = allResponses.filter(r => r.q12 !== null && r.q12 >= 9)
          .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));
        emptyMsg = 'No promoters found yet.';
        emptyIcon = '&#11088;';
        thead.innerHTML = `<tr><th>Age</th><th>NPS</th><th>Brand / Branch</th><th>Customer</th><th>Feedback</th><th>Status</th><th>Actions</th></tr>`;
      }

      if (rows.length === 0) {
        const colSpan = overviewNpsCat === 'detractors' ? 8 : 7;
        tbody.innerHTML = `<tr><td colspan="${colSpan}"><div class="empty"><div class="empty-icon">${emptyIcon}</div>${emptyMsg}</div></td></tr>`;
        return;
      }

      if (overviewNpsCat === 'detractors') {
        rows.forEach(r => {
          const daysOld = Math.floor((Date.now() - new Date(r.completed_at).getTime()) / 86400000);
          const priorityClass = getPriorityClass(r.q12, daysOld);
          const priority = r.q12 <= 3 ? 'Critical' : daysOld > 7 ? 'Urgent' : daysOld > 3 ? 'High' : 'Normal';

          const tr = document.createElement('tr');
          tr.className = priorityClass;
          tr.innerHTML = `
            <td data-label="Age">${getAgingBadge(r.completed_at, r.ticket_status)}</td>
            <td data-label="NPS">${npsBadge(r.q12)}</td>
            <td data-label="Brand / Branch">${brandBadge(sanitize(r.brand))}<br><small style="color:var(--muted)">${sanitize(r.branch) || '-'}</small></td>
            <td data-label="Customer">${sanitize(r.name) || '-'}<br><small style="color:var(--muted)">${sanitize(r.email) || ''}</small></td>
            <td data-label="Concern" style="max-width:200px">${sanitize(r.q12_follow) || '-'}</td>
            <td data-label="Priority"><span class="aging-badge ${priority === 'Critical' || priority === 'Urgent' ? 'urgent' : priority === 'High' ? 'old' : 'recent'}">${priority}</span></td>
            <td data-label="Status">
              <select class="statusSel ${sanitize(r.ticket_status) || 'open'}" data-id="${sanitize(r.id)}">
                <option value="open" ${r.ticket_status === 'open' || !r.ticket_status ? 'selected' : ''}>Open</option>
                <option value="in_progress" ${r.ticket_status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                <option value="resolved" ${r.ticket_status === 'resolved' ? 'selected' : ''}>Resolved</option>
                <option value="voc" ${r.ticket_status === 'voc' ? 'selected' : ''}>VOC</option>
                <option value="inactive" ${r.ticket_status === 'inactive' ? 'selected' : ''}>Inactive</option>
              </select>
            </td>
            <td data-label="Actions"><button class="btn" data-view="${sanitize(r.id)}">View</button></td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        // Passives and Promoters table rows
        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="Age">${getAgingBadge(r.completed_at, r.ticket_status)}</td>
            <td data-label="NPS">${npsBadge(r.q12)}</td>
            <td data-label="Brand / Branch">${brandBadge(sanitize(r.brand))}<br><small style="color:var(--muted)">${sanitize(r.branch) || '-'}</small></td>
            <td data-label="Customer">${sanitize(r.name) || '-'}<br><small style="color:var(--muted)">${sanitize(r.email) || ''}</small></td>
            <td data-label="Feedback" style="max-width:200px">${sanitize(r.q12_follow) || '-'}</td>
            <td data-label="Status">
              <select class="statusSel ${sanitize(r.ticket_status) || 'open'}" data-id="${sanitize(r.id)}">
                <option value="open" ${r.ticket_status === 'open' || !r.ticket_status ? 'selected' : ''}>Open</option>
                <option value="in_progress" ${r.ticket_status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                <option value="resolved" ${r.ticket_status === 'resolved' ? 'selected' : ''}>Resolved</option>
                <option value="voc" ${r.ticket_status === 'voc' ? 'selected' : ''}>VOC</option>
                <option value="inactive" ${r.ticket_status === 'inactive' ? 'selected' : ''}>Inactive</option>
              </select>
            </td>
            <td data-label="Actions"><button class="btn" data-view="${sanitize(r.id)}">View</button></td>
          `;
          tbody.appendChild(tr);
        });
      }

      // Status change handlers
      tbody.querySelectorAll('.statusSel').forEach(sel => {
        sel.addEventListener('change', async (e) => {
          const id = e.target.dataset.id;
          const newStatus = e.target.value;
          e.target.className = `statusSel ${newStatus}`;

          const success = await DataService.updateTicketStatus(id, newStatus);
          if (success) {
            const response = allResponses.find(r => r.id === id);
            if (response) response.ticket_status = newStatus;
          }
        });
      });

      // View button handlers
      tbody.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', () => showResponseDetail(btn.dataset.view));
      });
    }

    /* ---------- Responses Tab ---------- */
    function paintResponses() {
      const tbody = document.getElementById('responsesBody');
      tbody.innerHTML = '';

      if (filteredResponses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="empty"><div class="empty-icon">üìã</div>No responses found</div></td></tr>`;
        return;
      }

      filteredResponses.forEach(r => {
        const npsCategory = getNPSCategory(r.q12);
        const tr = document.createElement('tr');
        // SECURITY: All user data is escaped to prevent XSS
        tr.innerHTML = `
          <td data-label="Date">${formatDate(r.completed_at)}</td>
          <td data-label="Customer">
            <div style="font-weight:600">${sanitize(r.name) || '-'}</div>
            <div style="font-size:11px;color:var(--muted)">${sanitize(r.email) || '-'}</div>
            ${r.phone ? `<div style="font-size:11px;color:var(--muted)">${sanitize(r.phone)}</div>` : ''}
          </td>
          <td data-label="Brand / Branch">${brandBadge(sanitize(r.brand))}<br><small style="color:var(--muted)">${sanitize(r.branch) || '-'}</small></td>
          <td data-label="Receipt" class="mono">${sanitize(r.receipt) || '-'}</td>
          <td data-label="NPS">${npsBadge(r.q12)}</td>
          <td data-label="Ticket">
            <select class="statusSel ${sanitize(r.ticket_status) || 'open'}" data-id="${sanitize(r.id)}">
              <option value="open" ${r.ticket_status === 'open' || !r.ticket_status ? 'selected' : ''}>Open</option>
              <option value="in_progress" ${r.ticket_status === 'in_progress' ? 'selected' : ''}>In Progress</option>
              <option value="resolved" ${r.ticket_status === 'resolved' ? 'selected' : ''}>Resolved</option>
              <option value="voc" ${r.ticket_status === 'voc' ? 'selected' : ''}>VOC</option>
              <option value="inactive" ${r.ticket_status === 'inactive' ? 'selected' : ''}>Inactive</option>
            </select>
          </td>
          <td data-label="Reward"><span class="status-badge ${r.reward_claimed ? 'claimed' : 'unclaimed'}">${r.reward_claimed ? 'Claimed' : 'Unclaimed'}</span></td>
          <td data-label="Actions"><button class="btn" data-view="${sanitize(r.id)}">View</button></td>
        `;
        tbody.appendChild(tr);
      });

      // Status change handlers
      tbody.querySelectorAll('.statusSel').forEach(sel => {
        sel.addEventListener('change', async (e) => {
          const id = e.target.dataset.id;
          const newStatus = e.target.value;
          e.target.className = `statusSel ${newStatus}`;

          const success = await DataService.updateTicketStatus(id, newStatus);
          if (success) {
            const response = allResponses.find(r => r.id === id);
            if (response) response.ticket_status = newStatus;
          }
        });
      });

      // View button handlers
      tbody.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', () => showResponseDetail(btn.dataset.view));
      });
    }

    // Search & Filter toggle for Responses tab
    document.getElementById('respSearchToggle')?.addEventListener('click', () => {
      const btn = document.getElementById('respSearchToggle');
      const panel = document.getElementById('respFiltersCollapsible');
      btn.classList.toggle('active');
      panel.classList.toggle('open');
    });

    // Response filters
    document.getElementById('respApplyFilters')?.addEventListener('click', () => {
      const search = document.getElementById('respFilterSearch').value.toLowerCase();
      const brand = document.getElementById('respFilterBrand').value;
      const branch = document.getElementById('respFilterBranch').value;
      const npsFilter = document.getElementById('respFilterNps').value;
      const from = document.getElementById('respFilterFrom').value;
      const to = document.getElementById('respFilterTo').value;

      filteredResponses = filterByUserAccess(allResponses).filter(r => {
        if (search) {
          const haystack = [r.name, r.email, r.receipt, r.branch].join(' ').toLowerCase();
          if (!haystack.includes(search)) return false;
        }
        if (brand && r.brand !== brand) return false;
        if (branch && r.branch !== branch) return false;
        if (npsFilter) {
          const cat = getNPSCategory(r.q12);
          if (cat !== npsFilter) return false;
        }
        if (from && r.completed_at < from) return false;
        if (to && r.completed_at > to + 'T23:59:59') return false;
        return true;
      });

      paintResponses();
    });

    document.getElementById('respClearFilters')?.addEventListener('click', () => {
      document.getElementById('respFilterSearch').value = '';
      document.getElementById('respFilterBrand').value = '';
      document.getElementById('respFilterBranch').value = '';
      document.getElementById('respFilterNps').value = '';
      document.getElementById('respFilterFrom').value = '';
      document.getElementById('respFilterTo').value = '';
      filteredResponses = filterByUserAccess([...allResponses]);
      paintResponses();
    });

    /* ---------- Validator Tab ---------- */
    let currentValidationResponse = null;

    document.getElementById('validateBtn')?.addEventListener('click', async () => {
      const query = document.getElementById('validatorInput').value.trim();
      const statusEl = document.getElementById('validatorStatus');
      const detailsEl = document.getElementById('validatorDetails');
      const actionsEl = document.getElementById('validatorActions');

      if (!query) {
        statusEl.textContent = 'Please enter a code or receipt number';
        statusEl.className = 'status invalid';
        detailsEl.style.display = 'none';
        actionsEl.style.display = 'none';
        return;
      }

      statusEl.textContent = 'Searching...';
      statusEl.className = 'status';

      const response = await DataService.findByCodeOrReceipt(query);

      if (!response) {
        statusEl.textContent = '‚ùå No matching record found';
        statusEl.className = 'status invalid';
        detailsEl.style.display = 'none';
        actionsEl.style.display = 'none';
        currentValidationResponse = null;
        return;
      }

      currentValidationResponse = response;

      // Populate details
      const avgNps = calculateAvgRating(response);
      document.getElementById('valCustomer').textContent = response.name || '-';
      document.getElementById('valNps').innerHTML = npsBadge(avgNps !== null ? avgNps : response.q12);
      document.getElementById('valReceipt').textContent = response.receipt || '-';
      document.getElementById('valCode').textContent = response.reward_code || '-';
      document.getElementById('valDate').textContent = formatDate(response.completed_at);

      if (response.reward_claimed) {
        statusEl.textContent = '‚ö†Ô∏è Reward Already Claimed';
        statusEl.className = 'status claimed';
        let claimInfo = `Claimed on ${formatDate(response.reward_claimed_at)}`;
        if (response.reward_claimed_branch) claimInfo += ` at ${sanitize(response.reward_claimed_branch)}`;
        if (response.reward_claimed_brand) claimInfo += ` (${sanitize(response.reward_claimed_brand)})`;
        if (response.reward_claimed_by) claimInfo += ` by ${sanitize(response.reward_claimed_by)}`;
        document.getElementById('valRewardStatus').innerHTML = `<span style="color:var(--warn)">${claimInfo}</span>`;
        actionsEl.style.display = 'none';
      } else {
        statusEl.textContent = '‚úÖ Valid - Reward Available';
        statusEl.className = 'status valid';
        document.getElementById('valRewardStatus').innerHTML = '<span style="color:var(--ok)">Unclaimed</span>';
        actionsEl.style.display = 'flex';
      }

      detailsEl.style.display = 'block';
    });

    document.getElementById('markRedeemedBtn')?.addEventListener('click', async () => {
      if (!currentValidationResponse) return;

      const btn = document.getElementById('markRedeemedBtn');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      const success = await DataService.markRewardClaimed(currentValidationResponse.id);

      if (success) {
        const claimedAt = new Date().toISOString();
        const statusEl = document.getElementById('validatorStatus');
        statusEl.textContent = '‚úÖ Marked as Redeemed!';
        statusEl.className = 'status valid';
        statusEl.style.animation = 'none';
        statusEl.offsetHeight; // Trigger reflow
        statusEl.style.animation = 'successPulse 0.5s ease';

        document.getElementById('valRewardStatus').innerHTML = `<span style="color:var(--ok)">Just claimed by ${sanitize(currentUser?.email)} at ${sanitize(currentUser?.branch)} (${sanitize(currentUser?.brand)})</span>`;
        document.getElementById('validatorActions').style.display = 'none';

        // Update local data
        const response = allResponses.find(r => r.id === currentValidationResponse.id);
        if (response) {
          response.reward_claimed = true;
          response.reward_claimed_at = claimedAt;
          response.reward_claimed_by = currentUser?.email;
          response.reward_claimed_branch = currentUser?.branch;
          response.reward_claimed_brand = currentUser?.brand;
        }

        // Refresh the redeemed tab data if needed
        if (activeTab === 'redeemed') paintRedeemed();
      } else {
        btn.disabled = false;
        btn.textContent = 'Mark as Redeemed';
        document.getElementById('validatorStatus').textContent = '‚ùå Failed to mark as redeemed';
        document.getElementById('validatorStatus').className = 'status invalid';
      }
    });

    // Enter key for validator
    document.getElementById('validatorInput')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('validateBtn').click();
    });

    /* ---------- Pending Rewards Tab ---------- */
    let filteredPending = [];

    function getRewardStatus(completedAt) {
      if (!completedAt) return { status: 'unknown', daysLeft: 0, class: 'recent' };
      const completedDate = new Date(completedAt);
      const now = new Date();
      const daysSinceCompletion = Math.floor((now - completedDate) / 86400000);
      const daysLeft = 30 - daysSinceCompletion;

      if (daysLeft <= 0) {
        return { status: 'expired', daysLeft: 0, class: 'urgent', label: 'Expired' };
      } else if (daysLeft <= 7) {
        return { status: 'expiring', daysLeft, class: 'old', label: `${daysLeft}d` };
      } else {
        return { status: 'valid', daysLeft, class: 'recent', label: `${daysLeft}d` };
      }
    }

    function paintPending() {
      // Get all unclaimed reward responses
      const pendingResponses = filterByUserAccess(allResponses).filter(r => r.reward_code && !r.reward_claimed);

      // Apply filters
      const search = document.getElementById('pendingFilterSearch')?.value.toLowerCase() || '';
      const brand = document.getElementById('pendingFilterBrand')?.value || '';
      const branch = document.getElementById('pendingFilterBranch')?.value || '';
      const statusFilter = document.getElementById('pendingFilterStatus')?.value || '';

      filteredPending = pendingResponses.filter(r => {
        if (search) {
          const haystack = [r.name, r.email, r.reward_code, r.receipt].join(' ').toLowerCase();
          if (!haystack.includes(search)) return false;
        }
        if (brand && r.brand !== brand) return false;
        if (branch && r.branch !== branch) return false;
        if (statusFilter) {
          const rewardStatus = getRewardStatus(r.completed_at);
          if (statusFilter === 'valid' && rewardStatus.status !== 'valid') return false;
          if (statusFilter === 'expiring' && rewardStatus.status !== 'expiring') return false;
          if (statusFilter === 'expired' && rewardStatus.status !== 'expired') return false;
        }
        return true;
      });

      // Sort by days left (expired last, then by expiration urgency)
      filteredPending.sort((a, b) => {
        const statusA = getRewardStatus(a.completed_at);
        const statusB = getRewardStatus(b.completed_at);
        if (statusA.status === 'expired' && statusB.status !== 'expired') return 1;
        if (statusB.status === 'expired' && statusA.status !== 'expired') return -1;
        return statusA.daysLeft - statusB.daysLeft; // Fewer days left first
      });

      // Update KPIs
      const valid = pendingResponses.filter(r => getRewardStatus(r.completed_at).status === 'valid');
      const expiring = pendingResponses.filter(r => getRewardStatus(r.completed_at).status === 'expiring');
      const expired = pendingResponses.filter(r => getRewardStatus(r.completed_at).status === 'expired');

      document.getElementById('kpiTotalPending').textContent = pendingResponses.length;
      document.getElementById('kpiValidPending').textContent = valid.length;
      document.getElementById('kpiExpiringSoon').textContent = expiring.length;
      document.getElementById('kpiExpired').textContent = expired.length;

      // Paint table
      const tbody = document.getElementById('pendingBody');
      tbody.innerHTML = '';

      if (filteredPending.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="empty"><div class="empty-icon">üéÅ</div>No pending rewards found</div></td></tr>`;
        return;
      }

      filteredPending.forEach(r => {
        const rewardStatus = getRewardStatus(r.completed_at);
        const tr = document.createElement('tr');
        tr.className = rewardStatus.status === 'expired' ? 'priority-critical' : rewardStatus.status === 'expiring' ? 'priority-high' : '';
        // SECURITY: All user data is escaped to prevent XSS
        tr.innerHTML = `
          <td data-label="Survey Date">${formatDate(r.completed_at)}</td>
          <td data-label="Customer">
            <div style="font-weight:600">${sanitize(r.name) || '-'}</div>
            <div style="font-size:11px;color:var(--muted)">${sanitize(r.email) || '-'}</div>
          </td>
          <td data-label="Reward Code" class="mono">${sanitize(r.reward_code) || '-'}</td>
          <td data-label="Receipt" class="mono">${sanitize(r.receipt) || '-'}</td>
          <td data-label="Brand / Branch">
            ${brandBadge(sanitize(r.brand))}<br>
            <small style="color:var(--muted)">${sanitize(r.branch) || '-'}</small>
          </td>
          <td data-label="Days Left">
            <span class="aging-badge ${rewardStatus.class}">${rewardStatus.label}</span>
          </td>
          <td data-label="Status">
            <span class="status-badge ${rewardStatus.status === 'expired' ? '' : 'unclaimed'}" style="${rewardStatus.status === 'expired' ? 'background:rgba(196,30,58,0.15);color:var(--bad)' : ''}">
              ${rewardStatus.status === 'expired' ? 'Expired' : 'Pending'}
            </span>
          </td>
          <td data-label="Actions"><button class="btn" data-view="${sanitize(r.id)}">View</button></td>
        `;
        tbody.appendChild(tr);
      });

      // View button handlers
      tbody.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', () => showResponseDetail(btn.dataset.view));
      });
    }

    // Search & Filter toggle for Pending tab
    document.getElementById('pendingSearchToggle')?.addEventListener('click', () => {
      const btn = document.getElementById('pendingSearchToggle');
      const panel = document.getElementById('pendingFiltersCollapsible');
      btn.classList.toggle('active');
      panel.classList.toggle('open');
    });

    // Pending filters
    document.getElementById('pendingApplyFilters')?.addEventListener('click', () => {
      paintPending();
    });

    document.getElementById('pendingClearFilters')?.addEventListener('click', () => {
      document.getElementById('pendingFilterSearch').value = '';
      document.getElementById('pendingFilterBrand').value = '';
      document.getElementById('pendingFilterBranch').value = '';
      document.getElementById('pendingFilterStatus').value = '';
      paintPending();
    });

    // Enter key for pending search
    document.getElementById('pendingFilterSearch')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('pendingApplyFilters').click();
    });

    /* ---------- Redeemed Tab ---------- */
    let filteredRedeemed = [];

    function paintRedeemed() {
      // Get all redeemed responses
      const redeemedResponses = filterByUserAccess(allResponses).filter(r => r.reward_claimed);

      // Apply filters
      const search = document.getElementById('redeemedFilterSearch')?.value.toLowerCase() || '';
      const brand = document.getElementById('redeemedFilterBrand')?.value || '';
      const branch = document.getElementById('redeemedFilterBranch')?.value || '';
      const from = document.getElementById('redeemedFilterFrom')?.value || '';
      const to = document.getElementById('redeemedFilterTo')?.value || '';

      filteredRedeemed = redeemedResponses.filter(r => {
        if (search) {
          const haystack = [r.name, r.email, r.reward_code, r.receipt, r.reward_claimed_by].join(' ').toLowerCase();
          if (!haystack.includes(search)) return false;
        }
        if (brand && r.brand !== brand) return false;
        if (branch && r.branch !== branch) return false;
        if (from && r.reward_claimed_at < from) return false;
        if (to && r.reward_claimed_at > to + 'T23:59:59') return false;
        return true;
      });

      // Sort by redemption date (newest first)
      filteredRedeemed.sort((a, b) => new Date(b.reward_claimed_at) - new Date(a.reward_claimed_at));

      // Update KPIs
      const today = new Date().toISOString().split('T')[0];
      const weekAgo = new Date(Date.now() - 7 * 86400000).toISOString();

      document.getElementById('kpiTotalRedeemed').textContent = redeemedResponses.length;
      document.getElementById('kpiRedeemedToday').textContent = redeemedResponses.filter(r => r.reward_claimed_at?.startsWith(today)).length;
      document.getElementById('kpiRedeemedThisWeek').textContent = redeemedResponses.filter(r => r.reward_claimed_at >= weekAgo).length;

      // Paint table
      const tbody = document.getElementById('redeemedBody');
      tbody.innerHTML = '';

      if (filteredRedeemed.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7"><div class="empty"><div class="empty-icon">üéÅ</div>No redeemed rewards found</div></td></tr>`;
        return;
      }

      filteredRedeemed.forEach(r => {
        const tr = document.createElement('tr');
        // SECURITY: All user data is escaped to prevent XSS
        tr.innerHTML = `
          <td data-label="Redeemed At">${formatDate(r.reward_claimed_at)}</td>
          <td data-label="Customer">
            <div style="font-weight:600">${sanitize(r.name) || '-'}</div>
            <div style="font-size:11px;color:var(--muted)">${sanitize(r.email) || '-'}</div>
          </td>
          <td data-label="Reward Code" class="mono">${sanitize(r.reward_code) || '-'}</td>
          <td data-label="Receipt" class="mono">${sanitize(r.receipt) || '-'}</td>
          <td data-label="Survey Brand/Branch">
            ${brandBadge(sanitize(r.brand))}<br>
            <small style="color:var(--muted)">${sanitize(r.branch) || '-'}</small>
          </td>
          <td data-label="Redeemed By">${sanitize(r.reward_claimed_by) || '-'}</td>
          <td data-label="Redeemed At (Location)">
            <div style="font-weight:600">${sanitize(r.reward_claimed_branch) || '-'}</div>
            <div style="font-size:11px;color:var(--muted)">${sanitize(r.reward_claimed_brand) || '-'}</div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Search & Filter toggle for Redeemed tab
    document.getElementById('redeemedSearchToggle')?.addEventListener('click', () => {
      const btn = document.getElementById('redeemedSearchToggle');
      const panel = document.getElementById('redeemedFiltersCollapsible');
      btn.classList.toggle('active');
      panel.classList.toggle('open');
    });

    // Redeemed filters
    document.getElementById('redeemedApplyFilters')?.addEventListener('click', () => {
      paintRedeemed();
    });

    document.getElementById('redeemedClearFilters')?.addEventListener('click', () => {
      document.getElementById('redeemedFilterSearch').value = '';
      document.getElementById('redeemedFilterBrand').value = '';
      document.getElementById('redeemedFilterBranch').value = '';
      document.getElementById('redeemedFilterFrom').value = '';
      document.getElementById('redeemedFilterTo').value = '';
      paintRedeemed();
    });

    // Enter key for redeemed search
    document.getElementById('redeemedFilterSearch')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('redeemedApplyFilters').click();
    });

    /* ---------- Analytics Tab ---------- */
    function paintAnalytics() {
      // Filter by user access then by period
      const userResponses = filterByUserAccess(allResponses);
      let periodResponses = userResponses;
      if (analyticsPeriod !== 'all') {
        const cutoff = new Date(Date.now() - analyticsPeriod * 86400000);
        periodResponses = userResponses.filter(r => new Date(r.completed_at) >= cutoff);
      }

      const npsData = DataService.calculateNPS(periodResponses);
      const brandNPS = DataService.calculateBrandNPS(periodResponses);

      // Update KPIs
      const npsEl = document.getElementById('kpiNpsScore');
      npsEl.textContent = npsData.score;
      npsEl.style.color = npsData.score > 0 ? 'var(--ok)' : npsData.score < 0 ? 'var(--bad)' : 'var(--warn)';

      document.getElementById('kpiPromoters').textContent = `${npsData.total ? Math.round((npsData.promoters / npsData.total) * 100) : 0}%`;
      document.getElementById('kpiPassives').textContent = `${npsData.total ? Math.round((npsData.passives / npsData.total) * 100) : 0}%`;
      document.getElementById('kpiDetractorsPct').textContent = `${npsData.total ? Math.round((npsData.detractors / npsData.total) * 100) : 0}%`;
      document.getElementById('kpiTotalResponses').textContent = npsData.total;

      // Destroy existing charts
      Object.values(charts).forEach(chart => chart?.destroy());

      // NPS Category Chart (Doughnut)
      const catCtx = document.getElementById('npsCategoryChart').getContext('2d');
      charts.category = new Chart(catCtx, {
        type: 'doughnut',
        data: {
          labels: ['Promoters (9-10)', 'Passives (7-8)', 'Detractors (0-6)'],
          datasets: [{
            data: [npsData.promoters, npsData.passives, npsData.detractors],
            backgroundColor: ['#0e9a5a', '#ff9d00', '#c41e3a'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // Brand NPS Comparison (Horizontal Bar)
      const brandLabels = Object.keys(brandMeta);
      const brandScores = brandLabels.map(b => brandNPS[b]?.score || 0);
      const brandColors = brandLabels.map(b => brandMeta[b].color);

      const brandCtx = document.getElementById('brandNpsChart').getContext('2d');
      charts.brand = new Chart(brandCtx, {
        type: 'bar',
        data: {
          labels: brandLabels,
          datasets: [{
            label: 'NPS Score',
            data: brandScores,
            backgroundColor: brandColors,
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { min: -100, max: 100, grid: { color: 'rgba(0,0,0,0.05)' } }
          }
        }
      });

      // NPS Trend Over Time (Line)
      const trendData = calculateTrendData(periodResponses);
      const trendCtx = document.getElementById('npsTrendChart').getContext('2d');
      charts.trend = new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: trendData.labels,
          datasets: [{
            label: 'NPS Score',
            data: trendData.scores,
            borderColor: '#85754E',
            backgroundColor: 'rgba(133,117,78,0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { min: -100, max: 100 }
          }
        }
      });

      // Responses by Brand (Bar)
      const brandCounts = brandLabels.map(b => periodResponses.filter(r => r.brand === b).length);
      const respCtx = document.getElementById('brandResponsesChart').getContext('2d');
      charts.responses = new Chart(respCtx, {
        type: 'bar',
        data: {
          labels: brandLabels,
          datasets: [{
            label: 'Responses',
            data: brandCounts,
            backgroundColor: brandColors,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });

      // Detractor comments
      paintDetractorComments(periodResponses);
    }

    function calculateTrendData(responses) {
      const days = analyticsPeriod === 'all' ? 30 : Math.min(analyticsPeriod, 30);
      const labels = [];
      const scores = [];

      for (let i = days - 1; i >= 0; i--) {
        const date = new Date(Date.now() - i * 86400000);
        const dateStr = date.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' });
        labels.push(dateStr);

        const dayStart = new Date(date.setHours(0, 0, 0, 0));
        const dayEnd = new Date(date.setHours(23, 59, 59, 999));

        const dayResponses = responses.filter(r => {
          const d = new Date(r.completed_at);
          return d >= dayStart && d <= dayEnd;
        });

        const nps = DataService.calculateNPS(dayResponses);
        scores.push(dayResponses.length > 0 ? nps.score : null);
      }

      return { labels, scores };
    }

    function paintDetractorComments(responses) {
      const container = document.getElementById('detractorComments');
      const detractors = responses.filter(r => r.q12 <= 6 && r.q12_follow).slice(0, 10);

      if (detractors.length === 0) {
        container.innerHTML = '<div class="empty">No detractor comments in this period</div>';
        return;
      }

      // SECURITY: All user data is escaped to prevent XSS
      container.innerHTML = detractors.map(r => `
        <div style="padding:12px; border:1px solid var(--line); border-radius:10px; margin-bottom:10px">
          <div style="display:flex; justify-content:space-between; margin-bottom:8px">
            ${brandBadge(sanitize(r.brand))}
            ${npsBadge(r.q12)}
          </div>
          <p style="font-size:13px; margin:0">"${sanitize(r.q12_follow)}"</p>
          <div style="font-size:11px; color:var(--muted); margin-top:8px">${formatDate(r.completed_at)}</div>
        </div>
      `).join('');
    }

    // Period selector
    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        analyticsPeriod = btn.dataset.period === 'all' ? 'all' : parseInt(btn.dataset.period);
        paintAnalytics();
      });
    });

    /* ---------- Export Tab ---------- */
    function getExportData() {
      const brand = document.getElementById('exportBrand').value;
      const npsFilter = document.getElementById('exportNps').value;
      const from = document.getElementById('exportFrom').value;
      const to = document.getElementById('exportTo').value;

      return filterByUserAccess(allResponses).filter(r => {
        if (brand && r.brand !== brand) return false;
        if (npsFilter) {
          const cat = getNPSCategory(r.q12);
          if (cat !== npsFilter) return false;
        }
        if (from && r.completed_at < from) return false;
        if (to && r.completed_at > to + 'T23:59:59') return false;
        return true;
      });
    }

    function updateExportPreview() {
      const data = getExportData();
      document.getElementById('exportPreviewCount').textContent = data.length;
    }

    // Update preview on filter change
    ['exportBrand', 'exportNps', 'exportFrom', 'exportTo'].forEach(id => {
      document.getElementById(id)?.addEventListener('change', updateExportPreview);
    });

    document.getElementById('exportExcelBtn')?.addEventListener('click', () => {
      const data = getExportData();
      if (data.length === 0) {
        alert('No data to export');
        return;
      }

      const exportRows = data.map(r => ({
        'Date': formatDate(r.completed_at),
        'Brand': r.brand,
        'Branch': r.branch,
        'Receipt': r.receipt || r.receipt || '-',
        'Customer Name': r.name || '-',
        'Customer Email': r.email || '-',
        'Data Privacy Consent': r.dpa ? 'Yes' : 'No',
        'Promo Consent': r.promo ? 'Yes' : 'No',
        'NPS Score': r.q12,
        'NPS Category': getNPSCategory(r.q12),
        'NPS Feedback': r.q12_follow || '-',
        'First Visit': r.q2 || '-',
        'Visit Frequency': r.q3 || '-',
        'Party Size': r.q4 || '-',
        'Overall Experience': r.q5 || '-',
        'Food Quality': r.q6 || '-',
        'Staff Friendliness': r.q7 || '-',
        'Orders Correct': r.q8 || '-',
        'Value for Money': r.q10 || '-',
        'Service Promptness': r.q11 || '-',
        'Ticket Status': r.ticket_status || 'open',
        'Reward Code': r.reward_code || '-',
        'Reward Claimed': r.reward_claimed ? 'Yes' : 'No',
        'Reward Claimed At': r.reward_claimed_at ? formatDate(r.reward_claimed_at) : '-'
      }));

      const ws = XLSX.utils.json_to_sheet(exportRows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Survey Responses');

      const filename = `survey_export_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, filename);
    });

    document.getElementById('exportCsvBtn')?.addEventListener('click', () => {
      const data = getExportData();
      if (data.length === 0) {
        alert('No data to export');
        return;
      }

      const exportRows = data.map(r => ({
        'Date': formatDate(r.completed_at),
        'Brand': r.brand,
        'Branch': r.branch,
        'Receipt': r.receipt || r.receipt || '-',
        'Customer Name': r.name || '-',
        'Customer Email': r.email || '-',
        'Data Privacy Consent': r.dpa ? 'Yes' : 'No',
        'Promo Consent': r.promo ? 'Yes' : 'No',
        'NPS Score': r.q12,
        'NPS Category': getNPSCategory(r.q12),
        'NPS Feedback': r.q12_follow || '-',
        'Ticket Status': r.ticket_status || 'open',
        'Reward Code': r.reward_code || '-',
        'Reward Claimed': r.reward_claimed ? 'Yes' : 'No'
      }));

      const ws = XLSX.utils.json_to_sheet(exportRows);
      const csv = XLSX.utils.sheet_to_csv(ws);

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `survey_export_${new Date().toISOString().slice(0, 10)}.csv`;
      link.click();
    });

    /* ---------- Response Detail Modal ---------- */
    function formatRating(value, max = 5) {
      if (value === null || value === undefined || value === '') return '-';
      return `${value}/${max}`;
    }

    function formatAnswer(value) {
      if (value === null || value === undefined || value === '') return '-';
      return sanitize(value);
    }

    function showResponseDetail(id) {
      const response = allResponses.find(r => r.id === id);
      if (!response) return;

      document.getElementById('detailSubtitle').textContent = `${sanitize(response.brand) || '-'} - ${sanitize(response.branch) || '-'} | ${formatDate(response.completed_at)}`;

      const content = document.getElementById('responseDetailContent');
      content.innerHTML = `
        <div style="display:grid; gap:16px">
          <!-- Customer Info -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
            <div style="padding:12px; background:rgba(0,0,0,0.03); border-radius:8px">
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px">Customer</div>
              <div style="font:700 14px var(--font)">${sanitize(response.name) || '-'}</div>
              <div style="font-size:12px; color:var(--muted)">${sanitize(response.email) || '-'}</div>
              ${response.phone ? `<div style="font-size:12px; color:var(--muted)">${sanitize(response.phone)}</div>` : ''}
            </div>
            <div style="padding:12px; background:rgba(0,0,0,0.03); border-radius:8px">
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px">NPS Score (0-10)</div>
              <div>${npsBadge(response.q12)} <span style="color:var(--muted); font-size:12px">${getNPSCategory(response.q12)}</span></div>
            </div>
          </div>

          <!-- Receipt & Reward -->
          <div style="padding:12px; border:1px solid var(--line); border-radius:8px">
            <div style="font:700 12px var(--font); margin-bottom:8px">Receipt & Reward</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px">
              <div><span style="color:var(--muted)">Receipt:</span> <span class="mono">${sanitize(response.receipt) || '-'}</span></div>
              <div><span style="color:var(--muted)">Reward Code:</span> <span class="mono">${sanitize(response.reward_code) || '-'}</span></div>
              <div><span style="color:var(--muted)">Claimed:</span> ${response.reward_claimed ? 'Yes' : 'No'}</div>
              <div><span style="color:var(--muted)">Ticket Status:</span> ${sanitize(response.ticket_status) || 'open'}</div>
            </div>
          </div>

          <!-- Consent -->
          <div style="padding:12px; border:1px solid var(--line); border-radius:8px">
            <div style="font:700 12px var(--font); margin-bottom:8px">Consent</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px">
              <div><span style="color:var(--muted)">Data Privacy Act:</span> ${response.dpa ? '<span style="color:var(--ok)">Agreed</span>' : '<span style="color:var(--bad)">-</span>'}</div>
              <div><span style="color:var(--muted)">Promo Updates:</span> ${response.promo ? '<span style="color:var(--ok)">Subscribed</span>' : '<span style="color:var(--muted)">-</span>'}</div>
            </div>
          </div>

          ${response.q12_follow ? `
          <!-- NPS Feedback -->
          <div style="padding:12px; border:1px solid var(--line); border-radius:8px; background:rgba(196,30,58,0.03)">
            <div style="font:700 12px var(--font); margin-bottom:8px">NPS Feedback</div>
            <p style="font-size:13px; margin:0">"${sanitize(response.q12_follow)}"</p>
          </div>
          ` : ''}

          <!-- Visit Information -->
          <div style="padding:12px; border:1px solid var(--line); border-radius:8px">
            <div style="font:700 12px var(--font); margin-bottom:12px">Visit Information</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px">
              <div><span style="color:var(--muted)">First Visit:</span> ${formatAnswer(response.q2)}</div>
              <div><span style="color:var(--muted)">Visit Frequency:</span> ${formatAnswer(response.q3)}</div>
              <div><span style="color:var(--muted)">Party Size:</span> ${formatAnswer(response.q4)}</div>
            </div>
          </div>

          <!-- Ratings (1-5 scale) -->
          <div style="padding:12px; border:1px solid var(--line); border-radius:8px">
            <div style="font:700 12px var(--font); margin-bottom:12px">Ratings (1-5 scale)</div>
            <div style="display:grid; gap:8px; font-size:13px">
              <div style="display:flex; justify-content:space-between"><span style="color:var(--muted)">Overall Experience</span> <strong>${formatRating(response.q5)}</strong></div>
              <div style="display:flex; justify-content:space-between"><span style="color:var(--muted)">Food Quality</span> <strong>${formatRating(response.q6)}</strong></div>
              <div style="display:flex; justify-content:space-between"><span style="color:var(--muted)">Staff Friendliness</span> <strong>${formatRating(response.q7)}</strong></div>
              <div style="display:flex; justify-content:space-between"><span style="color:var(--muted)">Orders Correct</span> <strong>${formatRating(response.q8)}</strong></div>
              <div style="display:flex; justify-content:space-between"><span style="color:var(--muted)">Value for Money</span> <strong>${formatRating(response.q10)}</strong></div>
              <div style="display:flex; justify-content:space-between"><span style="color:var(--muted)">Service Promptness</span> <strong>${formatRating(response.q11)}</strong></div>
            </div>
          </div>

          <!-- Additional Feedback -->
          ${(response.q13 || response.q14 || response.q15 || response.q16 || response.q17 || response.q18) ? `
          <div style="padding:12px; border:1px solid var(--line); border-radius:8px">
            <div style="font:700 12px var(--font); margin-bottom:12px">Additional Feedback</div>
            <div style="display:grid; gap:8px; font-size:13px">
              ${response.q13 ? `<div><span style="color:var(--muted)">Q13:</span> ${sanitize(response.q13)}</div>` : ''}
              ${response.q14 ? `<div><span style="color:var(--muted)">Q14:</span> ${sanitize(response.q14)}</div>` : ''}
              ${response.q15 ? `<div><span style="color:var(--muted)">Q15:</span> ${sanitize(response.q15)}</div>` : ''}
              ${response.q16 ? `<div><span style="color:var(--muted)">Q16:</span> ${sanitize(response.q16)}</div>` : ''}
              ${response.q17 ? `<div><span style="color:var(--muted)">Q17:</span> ${sanitize(response.q17)}</div>` : ''}
              ${response.q18 ? `<div><span style="color:var(--muted)">Q18:</span> ${sanitize(response.q18)}</div>` : ''}
            </div>
          </div>
          ` : ''}
        </div>
      `;

      document.getElementById('responseDetailModal').classList.add('visible');
    }

    document.getElementById('closeDetailBtn')?.addEventListener('click', () => {
      document.getElementById('responseDetailModal').classList.remove('visible');
    });

    document.getElementById('responseDetailModalClose')?.addEventListener('click', () => {
      document.getElementById('responseDetailModal').classList.remove('visible');
    });

    document.getElementById('responseDetailModal')?.addEventListener('click', (e) => {
      if (e.target === document.getElementById('responseDetailModal')) {
        document.getElementById('responseDetailModal').classList.remove('visible');
      }
    });

    /* ---------- Session Verification ---------- */
    async function checkExistingSession() {
      const token = localStorage.getItem('admin_token');
      const refreshToken = localStorage.getItem('admin_refresh_token');
      const storedUser = localStorage.getItem('admin_user');

      // No token or user stored - show login
      if (!token || !storedUser) {
        localStorage.removeItem('admin_token');
        localStorage.removeItem('admin_refresh_token');
        localStorage.removeItem('admin_user');
        showLogin();
        return;
      }

      try {
        // Verify the token with the server
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/verify`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({})
        });

        // Check if response is OK and parse JSON
        if (!response.ok) {
          console.log('Session verification failed with status:', response.status);
          throw new Error('Verification failed');
        }

        const data = await response.json();

        // Strictly check that valid is true and user exists
        if (data.valid === true && data.user && data.user.email) {
          currentUser = data.user;
          console.log('Session verified for user:', currentUser.email);

          // Restore the Supabase session for authenticated operations
          if (refreshToken) {
            console.log('Setting Supabase session...');
            const { error: sessionError } = await sb.auth.setSession({
              access_token: token,
              refresh_token: refreshToken
            });
            if (sessionError) {
              console.warn('Session set warning:', sessionError);
            } else {
              console.log('Supabase session set successfully');
            }
          } else {
            console.warn('No refresh token available');
          }

          showApp();
          return;
        } else {
          console.log('Session verification returned invalid:', data);
          throw new Error('Invalid session data');
        }
      } catch (err) {
        console.error('Session verification failed:', err);
        // Clear invalid session data
        localStorage.removeItem('admin_token');
        localStorage.removeItem('admin_refresh_token');
        localStorage.removeItem('admin_user');
        showLogin();
      }
    }

    /* ---------- Keyboard Shortcuts ---------- */
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.getElementById('profileModal').classList.remove('visible');
        document.getElementById('responseDetailModal').classList.remove('visible');
      }
    });

    /* ---------- Force Logout via URL ---------- */
    // Add ?logout to URL to force clear session (e.g., admin.html?logout)
    function checkForceLogout() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('logout')) {
        localStorage.removeItem('admin_token');
        localStorage.removeItem('admin_refresh_token');
        localStorage.removeItem('admin_user');
        sb.auth.signOut();
        // Remove the ?logout from URL
        window.history.replaceState({}, document.title, window.location.pathname);
        return true;
      }
      return false;
    }

    /* ---------- Boot ---------- */
    // Check if force logout requested
    if (checkForceLogout()) {
      showLogin();
    } else {
      checkExistingSession();
    }
  </script>
</body>
</html>
