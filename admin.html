<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nippon Hasha ‚Äî Admin Dashboard</title>

  <!-- Montserrat -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

  <!-- SheetJS for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <style>
    :root{
      --font:"Montserrat",system-ui,-apple-system,"Segoe UI",Roboto,sans-serif;

      --ink:#101010; --muted:#6b7280;
      --gold:#85754E; --gold-dk:#6f6242;
      --navy:#002A3A; --black:#231f20;

      --line:#e7e6e2; --bg:#faf6ef; --surface:#ffffff;
      --bad:#c41e3a; --warn:#ff9d00; --ok:#0e9a5a; --info:#1f6feb;

      --header-h:64px;
      --radius:16px;
      --sea1:.12; --sea2:.05;

      --elev-1: 0 2px 10px rgba(0,0,0,.06);
      --elev-2: 0 12px 26px rgba(0,0,0,.12);
      --dur-fast: .20s;
      --dur-med: .28s;
      --ease: cubic-bezier(.22,.61,.36,1);

      /* Brand colors */
      --brand-yushoken: #f4b400;
      --brand-mendokoro: #c41e3a;
      --brand-kazunori: #2f9e6e;
      --brand-kazucafe: #2f9e6e;
      --brand-marudori: #0e9a5a;
    }

    /* Animated seigaiha background */
    .bg{ position:fixed; inset:0; z-index:-2;
      background: radial-gradient(1200px 360px at 50% -120px, rgba(196,30,58,.09), transparent 65%), var(--bg);
    }
    .bg::before, .bg::after{
      content:""; position:absolute; inset:0; pointer-events:none;
      background-repeat:repeat; background-size:400px 200px; animation: float 34s linear infinite;
    }
    .bg::before{
      opacity:var(--sea1);
      background-image:url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMTUwIiB2aWV3Qm94PSIwIDAgMzAwIDE1MCI+PGRlZnM+PHBhdHRlcm4gaWQ9InMiIHdpZHRoPSI1MCIgaGVpZ2h0PSIyNSIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTTAgMjVhMjUgMjUgMCAwMSA1MCAwIiBmaWxsPSJub25lIiBzdHJva2U9IiNDNDFFM0EiIHN0cm9rZS13aWR0aD0iMSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNzKSIvPjwvc3ZnPg==');
    }
    .bg::after{
      opacity:var(--sea2); animation-duration:48s; animation-direction:reverse; transform:translateY(10px);
      background-image:url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIzMDAiIGhlaWdodD0iMTUwIiB2aWV3Qm94PSIwIDAgMzAwIDE1MCI+PGRlZnM+PHBhdHRlcm4gaWQ9InMiIHdpZHRoPSI1MCIgaGVpZ2h0PSIyNSIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PHBhdGggZD0iTTAgMjVhMjUgMjUgMCAwMSA1MCAwIiBmaWxsPSJub25lIiBzdHJva2U9IiMxMDEwMTAiIHN0cm9rZS13aWR0aD0iLjkiIG9wYWNpdHk9Ii4yNSIvPjxwYXRoIGQ9Ik0xMi41IDI1QTEyLjUgMTIuNSAwIDAxMzcgMjUiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzEwMTAxMCIgc3Ryb2tlLXdpZHRoPSIuNiIgb3BhY2l0eT0iLjE4Ii8+PC9wYXR0ZXJuPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI3MpIi8+PC9zdmc+');
    }
    @keyframes float{ from{ background-position:0 0 } to{ background-position:400px 0 } }

    *{ box-sizing:border-box; margin:0; padding:0 }
    html,body{ min-height:100vh }
    body{
      font-family:var(--font); color:var(--ink); background:transparent;
      line-height:1.55; overflow-x:hidden;
      opacity:0; transform:translateY(6px); animation:fadeIn .35s var(--ease) forwards;
    }
    @keyframes fadeIn{ to{ opacity:1; transform:none } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }

    /* Admin-specific header - Dark theme */
    .site-header{
      position:sticky; top:0; z-index:30;
      display:none; flex-direction:column; align-items:stretch;
      background: linear-gradient(135deg, #2d2a24 0%, #1a1815 100%);
      border-bottom: 2px solid var(--gold);
      padding:0;
      min-height:var(--header-h);
    }
    .site-header.visible { display:flex; }
    .nav{
      max-width:1200px; margin:0 auto; padding:12px 16px; width:100%;
      display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:16px;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .brand img{ height:36px; width:auto; }
    .brand .title{
      font:800 14px/1 var(--font); letter-spacing:.02em; color:#fff;
      display:flex; flex-direction:column; gap:2px;
    }
    .brand .title small { font-size:10px; color:var(--gold); font-weight:600; letter-spacing:.1em; }

    .tabs{ display:flex; gap:6px; align-items:center; justify-content:center; flex-wrap:wrap; }
    .tab{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:8px 16px; border:1px solid rgba(255,255,255,0.2); border-radius:999px;
      background:transparent; font:700 13px/1 var(--font); cursor:pointer;
      white-space:nowrap; transition:all var(--dur-fast) var(--ease);
      color:rgba(255,255,255,0.8); text-decoration:none;
    }
    .tab:hover{ background:rgba(255,255,255,0.1); color:#fff; transform:translateY(-1px); }
    .tab[aria-selected="true"]{ background:var(--gold); color:#fff; border-color:var(--gold); }

    .header-actions{ display:flex; gap:10px; align-items:center; }
    .user-badge {
      font-size:12px; color:rgba(255,255,255,0.7); max-width:160px;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap; cursor:pointer;
      padding:6px 12px; border-radius:8px; background:rgba(255,255,255,0.1);
      transition:background var(--dur-fast) var(--ease);
    }
    .user-badge:hover { background:rgba(255,255,255,0.2); }

    .icon-btn{
      height:36px; width:36px; display:grid; place-items:center; border-radius:10px;
      border:1px solid rgba(255,255,255,0.2); background:transparent; cursor:pointer;
      color:#fff; transition:all var(--dur-fast) var(--ease);
    }
    .icon-btn:hover{ background:rgba(255,255,255,0.1); transform:translateY(-1px); }

    /* Header buttons (white text) */
    .site-header .btn{
      height:36px; padding:0 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.3);
      background:transparent; color:#fff; cursor:pointer; font:700 13px var(--font);
      transition:all var(--dur-fast) var(--ease);
    }
    .site-header .btn:hover{ background:rgba(255,255,255,0.1); transform:translateY(-1px); }

    /* Content area buttons (dark text) */
    .btn{
      height:36px; padding:0 14px; border-radius:10px; border:1px solid var(--line);
      background:var(--surface); color:var(--ink); cursor:pointer; font:700 13px var(--font);
      transition:all var(--dur-fast) var(--ease); box-shadow:var(--elev-1);
    }
    .btn:hover{ background:color-mix(in oklab, var(--surface) 95%, var(--gold)); transform:translateY(-1px); }
    .btn.primary { background:var(--gold); border-color:var(--gold); color:#fff; }
    .btn.primary:hover { background:var(--gold-dk); }
    .btn.danger { background:var(--bad); border-color:var(--bad); color:#fff; }
    .btn.danger:hover { background:#a01830; }
    .btn.success { background:var(--ok); border-color:var(--ok); color:#fff; }
    .btn.success:hover { background:#0b7a48; }

    /* Content area */
    .wrap{ max-width:1200px; margin:0 auto; padding:20px 16px; display:grid; gap:16px; min-height:calc(100vh - var(--header-h)); }
    .card{ background:var(--surface); border:1px solid var(--line); border-radius:var(--radius); padding:20px; box-shadow:var(--elev-1); }
    .card h3{ font:800 18px/1.2 var(--font); margin-bottom:12px; color:var(--black); }
    .card .subtitle { color:var(--muted); font-size:13px; margin-top:-8px; margin-bottom:16px; }

    /* KPI Cards */
    .kpis{ display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:12px; margin-bottom:16px; }
    .kpi{
      border:1px solid var(--line); border-radius:14px; padding:16px;
      background:var(--surface); position:relative; overflow:hidden;
    }
    .kpi .v{ font:800 28px/1 var(--font); color:var(--black); }
    .kpi .l{ color:var(--muted); font-size:12px; margin-top:4px; font-weight:600; }
    .kpi.critical {
      border-left:4px solid var(--bad); background:rgba(196,30,58,0.05);
    }
    .kpi.critical .v { color:var(--bad); }
    .kpi.warning { border-left:4px solid var(--warn); background:rgba(255,157,0,0.05); }
    .kpi.warning .v { color:var(--warn); }
    .kpi.success { border-left:4px solid var(--ok); background:rgba(14,154,90,0.05); }
    .kpi.success .v { color:var(--ok); }
    .kpi.info { border-left:4px solid var(--info); background:rgba(31,111,235,0.05); }
    .kpi.info .v { color:var(--info); }
    .kpi .trend { font-size:11px; color:var(--muted); margin-top:6px; }
    .kpi .trend.up { color:var(--ok); }
    .kpi .trend.down { color:var(--bad); }

    /* NPS Badges */
    .nps-badge {
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius:50%; font:800 14px var(--font);
    }
    .nps-badge.promoter { background:rgba(14,154,90,0.15); color:var(--ok); }
    .nps-badge.passive { background:rgba(255,157,0,0.15); color:var(--warn); }
    .nps-badge.detractor { background:rgba(196,30,58,0.15); color:var(--bad); }

    /* Priority rows */
    .priority-critical { border-left:4px solid var(--bad); background:rgba(196,30,58,0.04); }
    .priority-high { border-left:4px solid var(--warn); background:rgba(255,157,0,0.04); }
    .priority-normal { border-left:4px solid var(--info); }

    /* Aging badges */
    .aging-badge {
      display:inline-flex; padding:4px 10px; border-radius:999px;
      font:700 11px var(--font);
    }
    .aging-badge.urgent { background:var(--bad); color:#fff; animation:pulse 2s infinite; }
    .aging-badge.old { background:var(--warn); color:#fff; }
    .aging-badge.recent { background:var(--muted); color:#fff; }

    /* Tables */
    .table{ width:100%; border-collapse:collapse; }
    .table th{
      text-align:left; padding:12px 10px; font-size:11px; font-weight:800;
      color:var(--muted); text-transform:uppercase; letter-spacing:.05em;
      border-bottom:2px solid var(--line); background:rgba(0,0,0,0.02);
    }
    .table td{ border-bottom:1px solid var(--line); padding:12px 10px; font-size:13px; vertical-align:middle; }
    .table tbody tr:hover{ background:rgba(133,117,78,0.04); }
    .table .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }

    /* Status select */
    .statusSel{
      appearance:none; padding:6px 28px 6px 10px; border-radius:999px;
      border:1px solid var(--line); font:700 11px var(--font); cursor:pointer;
      background-image:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="10" height="6" viewBox="0 0 10 6"%3E%3Cpath fill="%236b7280" d="M5 6L0 0h10z"/%3E%3C/svg%3E');
      background-repeat:no-repeat; background-position:calc(100% - 8px) center;
      transition:all var(--dur-fast) var(--ease);
    }
    .statusSel.open { background-color:rgba(255,157,0,0.15); color:var(--warn); border-color:var(--warn); }
    .statusSel.in_progress { background-color:rgba(31,111,235,0.15); color:var(--info); border-color:var(--info); }
    .statusSel.resolved { background-color:rgba(14,154,90,0.15); color:var(--ok); border-color:var(--ok); }

    /* Brand tags */
    .brandTag{
      display:inline-flex; align-items:center; gap:6px; padding:4px 10px;
      border-radius:999px; font:700 11px var(--font); background:var(--surface);
      border:1px solid var(--line);
    }
    .brandTag::before{ content:''; width:8px; height:8px; border-radius:50%; background:var(--brand-color); }

    /* Status badges */
    .status-badge {
      display:inline-flex; padding:4px 10px; border-radius:999px;
      font:700 11px var(--font);
    }
    .status-badge.claimed { background:rgba(14,154,90,0.15); color:var(--ok); }
    .status-badge.unclaimed { background:rgba(255,157,0,0.15); color:var(--warn); }

    /* Login screen */
    .login-wrap{ min-height:100dvh; display:grid; place-items:center; padding:24px 16px; background:linear-gradient(135deg, #2d2a24 0%, #1a1815 100%); }
    .login-card{
      width:min(420px,100%); background:var(--surface); border-radius:var(--radius);
      padding:32px; box-shadow:var(--elev-2);
    }
    .login-card .logo-wrap { display:flex; align-items:center; gap:12px; margin-bottom:24px; }
    .login-card .logo-wrap img { height:40px; }
    .login-card .logo-wrap .title { font:800 16px var(--font); color:var(--black); }
    .login-card .logo-wrap .title small { display:block; font-size:11px; color:var(--gold); font-weight:600; letter-spacing:.1em; margin-top:2px; }
    .login-card h1{ font:800 24px/1.2 var(--font); margin-bottom:8px; color:var(--black); }
    .login-card p{ color:var(--muted); font-size:14px; margin-bottom:20px; }
    .login-card label{ font:700 12px/1 var(--font); color:var(--muted); margin-top:16px; display:block; }
    .login-card input{
      width:100%; padding:14px 16px; border:1px solid var(--line); border-radius:10px;
      margin-top:8px; font:600 14px var(--font); transition:border-color var(--dur-fast) var(--ease);
    }
    .login-card input:focus { outline:none; border-color:var(--gold); }
    .login-error { background:rgba(196,30,58,0.1); border:1px solid var(--bad); color:var(--bad); padding:12px 14px; border-radius:10px; font-size:13px; margin-bottom:16px; }
    .password-wrap { position:relative; }
    .toggle-pw { position:absolute; right:14px; top:50%; transform:translateY(-50%); background:none; border:none; cursor:pointer; font-size:16px; opacity:0.5; }
    .toggle-pw:hover { opacity:1; }
    .login-btn {
      width:100%; height:48px; margin-top:20px; background:var(--gold); color:#fff;
      border:none; border-radius:10px; font:700 14px var(--font); cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:10px;
      transition:background var(--dur-fast) var(--ease);
    }
    .login-btn:hover { background:var(--gold-dk); }
    .login-btn:disabled { opacity:0.6; cursor:not-allowed; }
    .spinner { width:18px; height:18px; border:2px solid rgba(255,255,255,0.3); border-top-color:#fff; border-radius:50%; animation:spin 0.8s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* Modal */
    .modal-overlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100;
      display:none; place-items:center; backdrop-filter:blur(4px);
    }
    .modal-overlay.visible { display:grid; }
    .modal {
      background:var(--surface); border-radius:var(--radius); padding:24px;
      width:min(480px, 90vw); max-height:90vh; overflow-y:auto;
      box-shadow:var(--elev-2); animation:modalIn .25s var(--ease);
    }
    @keyframes modalIn { from { opacity:0; transform:translateY(-20px); } to { opacity:1; transform:none; } }
    .modal h2 { font:800 20px var(--font); margin-bottom:8px; }
    .modal .subtitle { color:var(--muted); font-size:13px; margin-bottom:20px; }
    .modal label { font:700 12px var(--font); color:var(--muted); display:block; margin-top:16px; }
    .modal input {
      width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:10px;
      margin-top:8px; font:600 14px var(--font);
    }
    .modal input:focus { outline:none; border-color:var(--gold); }
    .modal-actions { display:flex; gap:10px; margin-top:24px; justify-content:flex-end; }
    .modal .btn { height:40px; color:var(--ink); background:var(--surface); border:1px solid var(--line); }
    .modal .btn:hover { background:color-mix(in oklab, var(--surface) 95%, var(--gold)); }
    .modal .btn.primary { background:var(--gold); color:#fff; border-color:var(--gold); }
    .modal .btn.primary:hover { background:var(--gold-dk); }
    .modal .success-msg { background:rgba(14,154,90,0.1); color:var(--ok); padding:12px; border-radius:8px; font-size:13px; margin-top:16px; }
    .modal .error-msg { background:rgba(196,30,58,0.1); color:var(--bad); padding:12px; border-radius:8px; font-size:13px; margin-top:16px; }

    /* Validator panel */
    .validator-bar {
      position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:90;
      display:none; place-items:start center; padding-top:100px;
      backdrop-filter:blur(4px);
    }
    .validator-bar.visible { display:grid; }
    .validator-content {
      background:var(--surface); border-radius:var(--radius); padding:24px;
      width:min(600px, 90vw); box-shadow:var(--elev-2);
      animation:modalIn .25s var(--ease);
    }
    .validator-content h3 { font:800 18px var(--font); margin-bottom:4px; }
    .validator-content .subtitle { color:var(--muted); font-size:13px; margin-bottom:20px; }
    .validator-input-wrap { display:flex; gap:10px; margin-bottom:16px; }
    .validator-input-wrap input {
      flex:1; padding:14px 16px; border:1px solid var(--line); border-radius:10px;
      font:600 14px var(--font); font-family:monospace;
    }
    .validator-input-wrap input:focus { outline:none; border-color:var(--gold); }
    .validator-result {
      border:1px solid var(--line); border-radius:12px; padding:16px;
      background:rgba(0,0,0,0.02); min-height:120px;
    }
    .validator-result .status { font:800 16px var(--font); margin-bottom:12px; }
    .validator-result .status.valid { color:var(--ok); }
    .validator-result .status.claimed { color:var(--warn); }
    .validator-result .status.invalid { color:var(--bad); }
    .validator-result .details { display:grid; gap:8px; font-size:13px; }
    .validator-result .details dt { color:var(--muted); font-weight:600; }
    .validator-result .details dd { margin:0; font-weight:700; }
    .validator-actions { display:flex; gap:10px; margin-top:16px; }

    /* Charts container */
    .chart-container { position:relative; height:300px; margin:16px 0; }
    .chart-row { display:grid; grid-template-columns:repeat(auto-fit, minmax(300px, 1fr)); gap:16px; }
    .chart-card { background:var(--surface); border:1px solid var(--line); border-radius:var(--radius); padding:20px; }
    .chart-card h4 { font:800 14px var(--font); margin-bottom:16px; color:var(--black); }

    /* NPS Gauge */
    .nps-gauge-wrap { display:flex; align-items:center; justify-content:center; flex-direction:column; padding:20px; }
    .nps-gauge-value { font:800 48px var(--font); }
    .nps-gauge-value.positive { color:var(--ok); }
    .nps-gauge-value.neutral { color:var(--warn); }
    .nps-gauge-value.negative { color:var(--bad); }
    .nps-gauge-label { color:var(--muted); font-size:12px; margin-top:8px; }

    /* Period selector */
    .period-selector { display:flex; gap:6px; margin-bottom:16px; }
    .period-btn {
      padding:8px 16px; border:1px solid var(--line); border-radius:999px;
      background:var(--surface); font:700 12px var(--font); cursor:pointer;
      transition:all var(--dur-fast) var(--ease);
    }
    .period-btn:hover { background:rgba(0,0,0,0.04); }
    .period-btn.active { background:var(--gold); color:#fff; border-color:var(--gold); }

    /* Export section */
    .export-filters { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px; margin-bottom:20px; }
    .export-filters .field label { font:700 12px var(--font); color:var(--muted); display:block; margin-bottom:8px; }
    .export-filters .field select,
    .export-filters .field input {
      width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:10px;
      font:600 13px var(--font);
    }
    .export-actions { display:flex; gap:12px; flex-wrap:wrap; }

    /* Empty state */
    .empty{ padding:40px 20px; text-align:center; color:var(--muted); border:1px dashed var(--line); border-radius:12px; font-size:14px; }
    .empty-icon { font-size:32px; margin-bottom:12px; }

    /* Mobile select for tabs */
    .tab-select-wrap { display:none; }
    .tab-select {
      padding:10px 40px 10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,0.3);
      background:transparent; color:#fff; font:700 13px var(--font);
      appearance:none; cursor:pointer;
      background-image:url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="10" height="6" viewBox="0 0 10 6"%3E%3Cpath fill="%23fff" d="M5 6L0 0h10z"/%3E%3C/svg%3E');
      background-repeat:no-repeat; background-position:calc(100% - 14px) center;
    }

    /* Filters panel */
    .filters-panel {
      background:var(--surface); border:1px solid var(--line); border-radius:var(--radius);
      padding:20px; margin-bottom:16px;
    }
    .filters-panel h4 { font:800 14px var(--font); margin-bottom:16px; }
    .filters-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:12px; }
    .filters-grid .field label { font:700 11px var(--font); color:var(--muted); display:block; margin-bottom:6px; }
    .filters-grid .field input,
    .filters-grid .field select {
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:8px;
      font:600 13px var(--font);
    }
    .filter-actions { display:flex; gap:10px; margin-top:16px; justify-content:flex-end; }

    /* Scrollable table wrapper */
    .table-wrap { overflow-x:auto; }

    /* Mobile responsiveness */
    @media (max-width:900px){
      .kpis { grid-template-columns:repeat(2, 1fr); }
    }
    @media (max-width:720px){
      .tabs { display:none; }
      .tab-select-wrap { display:block; }
      .nav { grid-template-columns:auto 1fr; }
      .header-actions { justify-content:flex-end; }
      .brand .title { display:none; }
    }
    @media (max-width:640px){
      .kpis { grid-template-columns:1fr; }
      .chart-row { grid-template-columns:1fr; }
      .table thead { display:none; }
      .table tr { display:block; border:1px solid var(--line); border-radius:12px; padding:12px; margin-bottom:10px; }
      .table td { display:flex; justify-content:space-between; border:none; padding:8px 4px; }
      .table td::before { content:attr(data-label); font-weight:700; color:var(--muted); }
    }
  </style>
</head>
<body>
  <!-- Animated background -->
  <div class="bg" aria-hidden="true"></div>

  <!-- LOGIN -->
  <main id="loginView" class="login-wrap">
    <section class="login-card">
      <div class="logo-wrap">
        <img src="nhlogo.png" alt="Nippon Hasha">
        <div class="title">Nippon Hasha<small>ADMIN DASHBOARD</small></div>
      </div>
      <h1>Welcome back</h1>
      <p>Sign in to access the admin dashboard.</p>

      <div id="loginError" class="login-error" style="display:none"></div>

      <label for="email">Email</label>
      <input id="email" type="email" placeholder="admin@nipponhasha.ph" autocomplete="username" required />

      <label for="password">Password</label>
      <div class="password-wrap">
        <input id="password" type="password" placeholder="Enter your password" autocomplete="current-password" required />
        <button type="button" id="togglePassword" class="toggle-pw">üëÅ</button>
      </div>

      <button id="loginBtn" class="login-btn">
        <span id="loginBtnText">Sign in</span>
        <span id="loginSpinner" class="spinner" style="display:none"></span>
      </button>
    </section>
  </main>

  <!-- HEADER -->
  <header class="site-header" id="appHeader">
    <nav class="nav">
      <div class="brand">
        <img src="nhlogo.png" alt="Nippon Hasha Inc.">
        <div class="title">Nippon Hasha<small>ADMIN DASHBOARD</small></div>
      </div>

      <div class="tabs" role="tablist">
        <button class="tab" data-tab="overview" aria-selected="true">Overview</button>
        <button class="tab" data-tab="responses">Responses</button>
        <button class="tab" data-tab="validator">Validator</button>
        <button class="tab" data-tab="analytics">Analytics</button>
        <button class="tab" data-tab="export">Export</button>
      </div>

      <div class="tab-select-wrap">
        <select id="tabSelect" class="tab-select">
          <option value="overview">Overview</option>
          <option value="responses">Responses</option>
          <option value="validator">Validator</option>
          <option value="analytics">Analytics</option>
          <option value="export">Export</option>
        </select>
      </div>

      <div class="header-actions">
        <span class="user-badge" id="userBadge" title="Click to manage profile"></span>
        <button id="signOutBtn" class="btn">Sign out</button>
      </div>
    </nav>
  </header>

  <!-- MAIN CONTENT -->
  <main id="appView" class="wrap" style="display:none">

    <!-- OVERVIEW TAB - Win-Back Dashboard -->
    <section class="tabpanel" id="tab-overview">
      <div class="card">
        <h3>Win-Back Dashboard</h3>
        <p class="subtitle">Prioritize detractors and turn unhappy customers into advocates. Sorted oldest to newest.</p>

        <div class="kpis" id="overviewKpis">
          <div class="kpi critical">
            <div class="v" id="kpiCritical">-</div>
            <div class="l">Critical (NPS 0-3)</div>
          </div>
          <div class="kpi warning">
            <div class="v" id="kpiDetractors">-</div>
            <div class="l">Detractors (NPS 4-6)</div>
          </div>
          <div class="kpi info">
            <div class="v" id="kpiOpenTickets">-</div>
            <div class="l">Open Tickets</div>
          </div>
          <div class="kpi">
            <div class="v" id="kpiOldestUnresolved">-</div>
            <div class="l">Oldest Unresolved</div>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table" id="detractorsTable">
            <thead>
              <tr>
                <th>Age</th>
                <th>NPS</th>
                <th>Brand / Branch</th>
                <th>Customer</th>
                <th>Concern</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="detractorsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- RESPONSES TAB -->
    <section class="tabpanel" id="tab-responses" hidden>
      <div class="card">
        <h3>All Responses</h3>
        <p class="subtitle">View all completed survey responses from Supabase.</p>

        <div class="filters-panel">
          <h4>Filters</h4>
          <div class="filters-grid">
            <div class="field">
              <label>Search</label>
              <input type="text" id="respFilterSearch" placeholder="Name, receipt, email...">
            </div>
            <div class="field">
              <label>Brand</label>
              <select id="respFilterBrand">
                <option value="">All Brands</option>
                <option value="Yushoken">Yushoken</option>
                <option value="Mendokoro">Mendokoro</option>
                <option value="Marudori">Marudori</option>
                <option value="Kazu Cafe">Kazu Cafe</option>
                <option value="Kazunori">Kazunori</option>
              </select>
            </div>
            <div class="field">
              <label>NPS Category</label>
              <select id="respFilterNps">
                <option value="">All</option>
                <option value="detractor">Detractors (0-6)</option>
                <option value="passive">Passives (7-8)</option>
                <option value="promoter">Promoters (9-10)</option>
              </select>
            </div>
            <div class="field">
              <label>Date From</label>
              <input type="date" id="respFilterFrom">
            </div>
            <div class="field">
              <label>Date To</label>
              <input type="date" id="respFilterTo">
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn" id="respClearFilters">Clear</button>
            <button class="btn primary" id="respApplyFilters">Apply Filters</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table" id="responsesTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Customer</th>
                <th>Brand / Branch</th>
                <th>Receipt</th>
                <th>NPS</th>
                <th>Ticket</th>
                <th>Reward</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="responsesBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- VALIDATOR TAB -->
    <section class="tabpanel" id="tab-validator" hidden>
      <div class="card">
        <h3>Receipt & Code Validator</h3>
        <p class="subtitle">Validate reward codes and mark them as redeemed when customers claim their rewards.</p>

        <div class="validator-input-wrap">
          <input type="text" id="validatorInput" placeholder="Enter reward code or receipt number..." class="mono">
          <button class="btn primary" id="validateBtn">Validate</button>
        </div>

        <div class="validator-result" id="validatorResult">
          <div class="status" id="validatorStatus">Enter a code or receipt to validate</div>
          <div class="details" id="validatorDetails" style="display:none">
            <dl>
              <dt>Customer</dt>
              <dd id="valCustomer">-</dd>
              <dt>NPS Score</dt>
              <dd id="valNps">-</dd>
              <dt>Receipt</dt>
              <dd id="valReceipt">-</dd>
              <dt>Reward Code</dt>
              <dd id="valCode">-</dd>
              <dt>Status</dt>
              <dd id="valRewardStatus">-</dd>
              <dt>Survey Date</dt>
              <dd id="valDate">-</dd>
            </dl>
          </div>
        </div>

        <div class="validator-actions" id="validatorActions" style="display:none">
          <button class="btn success" id="markRedeemedBtn">Mark as Redeemed</button>
        </div>
      </div>
    </section>

    <!-- ANALYTICS TAB -->
    <section class="tabpanel" id="tab-analytics" hidden>
      <div class="card">
        <h3>Analytics Dashboard</h3>
        <p class="subtitle">Multi-brand NPS analysis and trends for executive review.</p>

        <div class="period-selector">
          <button class="period-btn active" data-period="7">Last 7 Days</button>
          <button class="period-btn" data-period="30">Last 30 Days</button>
          <button class="period-btn" data-period="90">Last 90 Days</button>
          <button class="period-btn" data-period="all">All Time</button>
        </div>

        <div class="kpis" id="analyticsKpis">
          <div class="kpi">
            <div class="v" id="kpiNpsScore">-</div>
            <div class="l">Overall NPS Score</div>
          </div>
          <div class="kpi success">
            <div class="v" id="kpiPromoters">-</div>
            <div class="l">Promoters (9-10)</div>
          </div>
          <div class="kpi warning">
            <div class="v" id="kpiPassives">-</div>
            <div class="l">Passives (7-8)</div>
          </div>
          <div class="kpi critical">
            <div class="v" id="kpiDetractorsPct">-</div>
            <div class="l">Detractors (0-6)</div>
          </div>
          <div class="kpi info">
            <div class="v" id="kpiTotalResponses">-</div>
            <div class="l">Total Responses</div>
          </div>
        </div>

        <div class="chart-row">
          <div class="chart-card">
            <h4>NPS Category Distribution</h4>
            <div class="chart-container">
              <canvas id="npsCategoryChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h4>Brand NPS Comparison</h4>
            <div class="chart-container">
              <canvas id="brandNpsChart"></canvas>
            </div>
          </div>
        </div>

        <div class="chart-row" style="margin-top:16px">
          <div class="chart-card">
            <h4>NPS Trend Over Time</h4>
            <div class="chart-container">
              <canvas id="npsTrendChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h4>Responses by Brand</h4>
            <div class="chart-container">
              <canvas id="brandResponsesChart"></canvas>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <h4 style="font:800 14px var(--font); margin-bottom:12px">Recent Detractor Comments</h4>
          <div id="detractorComments"></div>
        </div>
      </div>
    </section>

    <!-- EXPORT TAB -->
    <section class="tabpanel" id="tab-export" hidden>
      <div class="card">
        <h3>Export Data</h3>
        <p class="subtitle">Download survey responses in Excel or CSV format.</p>

        <div class="export-filters">
          <div class="field">
            <label>Brand</label>
            <select id="exportBrand">
              <option value="">All Brands</option>
              <option value="Yushoken">Yushoken</option>
              <option value="Mendokoro">Mendokoro</option>
              <option value="Marudori">Marudori</option>
              <option value="Kazu Cafe">Kazu Cafe</option>
              <option value="Kazunori">Kazunori</option>
            </select>
          </div>
          <div class="field">
            <label>NPS Category</label>
            <select id="exportNps">
              <option value="">All</option>
              <option value="detractor">Detractors Only</option>
              <option value="passive">Passives Only</option>
              <option value="promoter">Promoters Only</option>
            </select>
          </div>
          <div class="field">
            <label>Date From</label>
            <input type="date" id="exportFrom">
          </div>
          <div class="field">
            <label>Date To</label>
            <input type="date" id="exportTo">
          </div>
        </div>

        <div class="kpis" style="margin-bottom:20px">
          <div class="kpi info">
            <div class="v" id="exportPreviewCount">-</div>
            <div class="l">Records to Export</div>
          </div>
        </div>

        <div class="export-actions">
          <button class="btn primary" id="exportExcelBtn">Download Excel (.xlsx)</button>
          <button class="btn" id="exportCsvBtn">Download CSV</button>
        </div>
      </div>
    </section>
  </main>

  <!-- PROFILE MODAL -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal">
      <h2>Account Settings</h2>
      <p class="subtitle">Manage your admin account</p>

      <div style="background:rgba(0,0,0,0.03); padding:16px; border-radius:10px; margin-bottom:20px">
        <div style="font-size:13px; color:var(--muted); margin-bottom:4px">Logged in as</div>
        <div style="font:700 14px var(--font)" id="profileEmail">-</div>
        <div style="font-size:12px; color:var(--muted); margin-top:4px" id="profileRole">-</div>
      </div>

      <h4 style="font:700 14px var(--font); margin-bottom:4px">Change Password</h4>
      <p style="font-size:12px; color:var(--muted); margin-bottom:12px">You'll need to sign in again after changing your password.</p>

      <div id="passwordMsg"></div>

      <label for="currentPassword">Current Password</label>
      <input type="password" id="currentPassword" placeholder="Enter current password">

      <label for="newPassword">New Password</label>
      <input type="password" id="newPassword" placeholder="Enter new password">

      <label for="confirmPassword">Confirm New Password</label>
      <input type="password" id="confirmPassword" placeholder="Confirm new password">

      <div class="modal-actions">
        <button class="btn" id="closeProfileBtn">Cancel</button>
        <button class="btn primary" id="changePasswordBtn">Change Password</button>
      </div>
    </div>
  </div>

  <!-- RESPONSE DETAIL MODAL -->
  <div class="modal-overlay" id="responseDetailModal">
    <div class="modal" style="max-width:600px">
      <h2>Response Details</h2>
      <p class="subtitle" id="detailSubtitle">-</p>
      <div id="responseDetailContent"></div>
      <div class="modal-actions">
        <button class="btn" id="closeDetailBtn">Close</button>
      </div>
    </div>
  </div>

  <script>
    /* ---------- CONFIG ---------- */
    const SUPABASE_URL = 'https://hxkrwxwrbffjkmepqlbh.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4a3J3eHdyYmZmamttZXBxbGJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3NjQ0MzYsImV4cCI6MjA3MTM0MDQzNn0.clmhrWPkZp9lD1zcUJRDF-2BPlpmt6x2ojNkKwjJBFw';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ---------- Brand Config ---------- */
    const brandMeta = {
      'Yushoken': { color: '#f4b400', route: 'YSHK' },
      'Mendokoro': { color: '#c41e3a', route: 'MDNK' },
      'Marudori': { color: '#0e9a5a', route: 'MRDR' },
      'Kazu Cafe': { color: '#2f9e6e', route: 'KZCF' },
      'Kazunori': { color: '#2f9e6e', route: 'KZNR' }
    };

    /* ---------- State ---------- */
    let currentUser = null;
    let allResponses = [];
    let filteredResponses = [];
    let activeTab = 'overview';
    let analyticsPeriod = 7;
    let charts = {};

    /* ---------- DOM Elements ---------- */
    const loginView = document.getElementById('loginView');
    const appView = document.getElementById('appView');
    const appHeader = document.getElementById('appHeader');
    const loginBtn = document.getElementById('loginBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const userBadge = document.getElementById('userBadge');
    const tabBtns = Array.from(document.querySelectorAll('.tab[data-tab]'));
    const tabPanels = Array.from(document.querySelectorAll('.tabpanel'));
    const tabSelect = document.getElementById('tabSelect');

    /* ---------- DataService ---------- */
    const DataService = {
      async fetchResponses() {
        try {
          const { data, error } = await sb
            .from('survey_responses')
            .select('*')
            .not('completed_at', 'is', null)
            .order('completed_at', { ascending: false });

          if (error) throw error;
          return data || [];
        } catch (err) {
          console.error('Error fetching responses:', err);
          return [];
        }
      },

      async updateTicketStatus(id, status) {
        try {
          const { error } = await sb
            .from('survey_responses')
            .update({ ticket_status: status })
            .eq('id', id);

          if (error) throw error;
          return true;
        } catch (err) {
          console.error('Error updating ticket status:', err);
          return false;
        }
      },

      async markRewardClaimed(id) {
        try {
          const { error } = await sb
            .from('survey_responses')
            .update({
              reward_claimed: true,
              reward_claimed_at: new Date().toISOString(),
              reward_claimed_by: currentUser?.email || 'admin'
            })
            .eq('id', id);

          if (error) throw error;
          return true;
        } catch (err) {
          console.error('Error marking reward claimed:', err);
          return false;
        }
      },

      async findByCodeOrReceipt(query) {
        try {
          // Try to find by reward code first
          let { data, error } = await sb
            .from('survey_responses')
            .select('*')
            .eq('reward_code', query.toUpperCase())
            .single();

          if (!data) {
            // Try to find by receipt
            const result = await sb
              .from('survey_responses')
              .select('*')
              .eq('receipt', query.toUpperCase())
              .single();
            data = result.data;
            error = result.error;
          }

          if (error && error.code !== 'PGRST116') throw error;
          return data;
        } catch (err) {
          console.error('Error finding response:', err);
          return null;
        }
      },

      getDetractors(responses) {
        return responses
          .filter(r => r.q12 !== null && r.q12 <= 6)
          .sort((a, b) => new Date(a.completed_at) - new Date(b.completed_at)); // Oldest first
      },

      calculateNPS(responses) {
        const scored = responses.filter(r => r.q12 !== null);
        if (scored.length === 0) return { score: 0, promoters: 0, passives: 0, detractors: 0, total: 0 };

        const promoters = scored.filter(r => r.q12 >= 9).length;
        const passives = scored.filter(r => r.q12 >= 7 && r.q12 <= 8).length;
        const detractors = scored.filter(r => r.q12 <= 6).length;
        const total = scored.length;

        const score = Math.round(((promoters - detractors) / total) * 100);

        return { score, promoters, passives, detractors, total };
      },

      calculateBrandNPS(responses) {
        const brandData = {};
        for (const brand of Object.keys(brandMeta)) {
          const brandResponses = responses.filter(r => r.brand === brand);
          brandData[brand] = this.calculateNPS(brandResponses);
        }
        return brandData;
      }
    };

    /* ---------- Utility Functions ---------- */
    function getNPSCategory(score) {
      if (score === null || score === undefined) return 'unknown';
      if (score >= 9) return 'promoter';
      if (score >= 7) return 'passive';
      return 'detractor';
    }

    function humanAgo(dateStr) {
      if (!dateStr) return '-';
      const ms = Date.now() - new Date(dateStr).getTime();
      const days = Math.floor(ms / 86400000);
      const hours = Math.floor((ms % 86400000) / 3600000);
      if (days > 0) return `${days}d ${hours}h`;
      if (hours > 0) return `${hours}h`;
      return '<1h';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('en-PH', {
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
      });
    }

    function getPriorityClass(nps, daysOld) {
      if (nps <= 3 || daysOld > 7) return 'priority-critical';
      if (nps <= 6 || daysOld > 3) return 'priority-high';
      return 'priority-normal';
    }

    function getAgingBadge(dateStr) {
      const days = Math.floor((Date.now() - new Date(dateStr).getTime()) / 86400000);
      if (days > 7) return `<span class="aging-badge urgent">${days}d ago</span>`;
      if (days > 3) return `<span class="aging-badge old">${days}d ago</span>`;
      return `<span class="aging-badge recent">${humanAgo(dateStr)}</span>`;
    }

    function brandBadge(brand) {
      const meta = brandMeta[brand] || { color: '#6b7280' };
      return `<span class="brandTag" style="--brand-color:${meta.color}">${brand || '-'}</span>`;
    }

    function npsBadge(score) {
      if (score === null || score === undefined) return '<span class="nps-badge">-</span>';
      const cat = getNPSCategory(score);
      return `<span class="nps-badge ${cat}">${score}</span>`;
    }

    /* ---------- Login Functions ---------- */
    function showLoginError(message) {
      const errorEl = document.getElementById('loginError');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => { errorEl.style.display = 'none'; }, 5000);
    }

    function setLoginLoading(isLoading) {
      const btn = document.getElementById('loginBtn');
      const text = document.getElementById('loginBtnText');
      const spinner = document.getElementById('loginSpinner');
      btn.disabled = isLoading;
      text.textContent = isLoading ? 'Signing in...' : 'Sign in';
      spinner.style.display = isLoading ? 'inline-block' : 'none';
    }

    function showApp() {
      loginView.style.display = 'none';
      appHeader.classList.add('visible');
      appView.style.display = 'grid';

      if (currentUser) {
        userBadge.textContent = currentUser.email;
        userBadge.title = `${currentUser.brand || 'All Brands'} - ${currentUser.role || 'admin'}`;
      }

      initApp();
    }

    function showLogin() {
      loginView.style.display = 'grid';
      appHeader.classList.remove('visible');
      appView.style.display = 'none';
    }

    /* ---------- Password Toggle ---------- */
    document.getElementById('togglePassword')?.addEventListener('click', () => {
      const pw = document.getElementById('password');
      const toggle = document.getElementById('togglePassword');
      if (pw.type === 'password') {
        pw.type = 'text';
        toggle.textContent = 'üôà';
      } else {
        pw.type = 'password';
        toggle.textContent = 'üëÅ';
      }
    });

    /* ---------- Login Handler ---------- */
    loginBtn.addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (!email || !password) {
        showLoginError('Please enter email and password');
        return;
      }

      setLoginLoading(true);

      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          localStorage.setItem('admin_token', data.token);
          localStorage.setItem('admin_user', JSON.stringify(data.user));
          currentUser = data.user;
          showApp();
        } else {
          showLoginError(data.error || 'Invalid credentials');
        }
      } catch (err) {
        console.error('Login failed:', err);
        showLoginError('Connection failed. Please try again.');
      } finally {
        setLoginLoading(false);
      }
    });

    // Enter key for login
    document.getElementById('password')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') loginBtn.click();
    });

    /* ---------- Sign Out Handler ---------- */
    signOutBtn.addEventListener('click', async () => {
      const token = localStorage.getItem('admin_token');

      // Clear local storage FIRST to ensure logout even if API fails
      localStorage.removeItem('admin_token');
      localStorage.removeItem('admin_user');
      currentUser = null;
      userBadge.textContent = '';

      if (token) {
        try {
          await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/logout`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`,
              'apikey': SUPABASE_ANON_KEY
            },
            body: JSON.stringify({})
          });
        } catch (err) {
          console.error('Logout API call failed:', err);
        }
      }

      // Force page reload to clear any state
      window.location.href = window.location.pathname;
    });

    /* ---------- Tab Navigation ---------- */
    function setTab(id) {
      if (!id) return;
      activeTab = id;

      tabBtns.forEach(btn => {
        btn.setAttribute('aria-selected', String(btn.dataset.tab === id));
      });

      tabPanels.forEach(panel => {
        const isActive = panel.id === 'tab-' + id;
        panel.hidden = !isActive;
      });

      if (tabSelect) tabSelect.value = id;

      // Refresh tab content
      if (id === 'overview') paintOverview();
      if (id === 'responses') paintResponses();
      if (id === 'analytics') paintAnalytics();
      if (id === 'export') updateExportPreview();
    }

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => setTab(btn.dataset.tab));
    });

    if (tabSelect) {
      tabSelect.addEventListener('change', (e) => setTab(e.target.value));
    }

    /* ---------- Profile Modal ---------- */
    userBadge.addEventListener('click', () => {
      document.getElementById('profileModal').classList.add('visible');
      document.getElementById('profileEmail').textContent = currentUser?.email || '-';
      document.getElementById('profileRole').textContent = `${currentUser?.brand || 'All Brands'} - ${currentUser?.role || 'Admin'}`;
      document.getElementById('passwordMsg').innerHTML = '';
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    });

    document.getElementById('closeProfileBtn').addEventListener('click', () => {
      document.getElementById('profileModal').classList.remove('visible');
    });

    document.getElementById('changePasswordBtn').addEventListener('click', async () => {
      const current = document.getElementById('currentPassword').value;
      const newPw = document.getElementById('newPassword').value;
      const confirm = document.getElementById('confirmPassword').value;
      const msgEl = document.getElementById('passwordMsg');

      if (!current || !newPw || !confirm) {
        msgEl.innerHTML = '<div class="error-msg">Please fill in all fields</div>';
        return;
      }

      if (newPw !== confirm) {
        msgEl.innerHTML = '<div class="error-msg">New passwords do not match</div>';
        return;
      }

      if (newPw.length < 8) {
        msgEl.innerHTML = '<div class="error-msg">Password must be at least 8 characters</div>';
        return;
      }

      try {
        const token = localStorage.getItem('admin_token');
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/change-password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({ current_password: current, new_password: newPw })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          msgEl.innerHTML = '<div class="success-msg">Password changed successfully! Signing out...</div>';
          setTimeout(() => {
            document.getElementById('profileModal').classList.remove('visible');
            signOutBtn.click();
          }, 2000);
        } else {
          msgEl.innerHTML = `<div class="error-msg">${data.error || 'Failed to change password'}</div>`;
        }
      } catch (err) {
        console.error('Password change failed:', err);
        msgEl.innerHTML = '<div class="error-msg">Connection failed. Please try again.</div>';
      }
    });

    // Close modal on overlay click
    document.getElementById('profileModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('profileModal')) {
        document.getElementById('profileModal').classList.remove('visible');
      }
    });

    /* ---------- App Initialization ---------- */
    async function initApp() {
      // Fetch real data from Supabase
      allResponses = await DataService.fetchResponses();
      filteredResponses = [...allResponses];

      // Paint initial view
      setTab('overview');
    }

    /* ---------- Overview Tab ---------- */
    function paintOverview() {
      const detractors = DataService.getDetractors(allResponses);
      const critical = detractors.filter(r => r.q12 <= 3);
      const openTickets = allResponses.filter(r => r.ticket_status === 'open' || !r.ticket_status);

      // Calculate oldest unresolved
      let oldestUnresolved = '-';
      const unresolvedDetractors = detractors.filter(r => r.ticket_status !== 'resolved');
      if (unresolvedDetractors.length > 0) {
        const oldest = unresolvedDetractors[0]; // Already sorted oldest first
        const days = Math.floor((Date.now() - new Date(oldest.completed_at).getTime()) / 86400000);
        oldestUnresolved = `${days}d`;
      }

      // Update KPIs
      document.getElementById('kpiCritical').textContent = critical.length;
      document.getElementById('kpiDetractors').textContent = detractors.length - critical.length;
      document.getElementById('kpiOpenTickets').textContent = openTickets.length;
      document.getElementById('kpiOldestUnresolved').textContent = oldestUnresolved;

      // Paint detractors table
      const tbody = document.getElementById('detractorsBody');
      tbody.innerHTML = '';

      if (detractors.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="empty"><div class="empty-icon">üéâ</div>No detractors found! Great job!</div></td></tr>`;
        return;
      }

      detractors.forEach(r => {
        const daysOld = Math.floor((Date.now() - new Date(r.completed_at).getTime()) / 86400000);
        const priorityClass = getPriorityClass(r.q12, daysOld);
        const priority = r.q12 <= 3 ? 'Critical' : daysOld > 7 ? 'Urgent' : daysOld > 3 ? 'High' : 'Normal';

        const tr = document.createElement('tr');
        tr.className = priorityClass;
        tr.innerHTML = `
          <td data-label="Age">${getAgingBadge(r.completed_at)}</td>
          <td data-label="NPS">${npsBadge(r.q12)}</td>
          <td data-label="Brand / Branch">${brandBadge(r.brand)}<br><small style="color:var(--muted)">${r.branch || '-'}</small></td>
          <td data-label="Customer">${r.name || '-'}<br><small style="color:var(--muted)">${r.email || ''}</small></td>
          <td data-label="Concern" style="max-width:200px">${r.q12_follow || '-'}</td>
          <td data-label="Priority"><span class="aging-badge ${priority === 'Critical' ? 'urgent' : priority === 'Urgent' || priority === 'High' ? 'old' : 'recent'}">${priority}</span></td>
          <td data-label="Status">
            <select class="statusSel ${(r.ticket_status || 'open')}" data-id="${r.id}">
              <option value="open" ${r.ticket_status === 'open' || !r.ticket_status ? 'selected' : ''}>Open</option>
              <option value="in_progress" ${r.ticket_status === 'in_progress' ? 'selected' : ''}>In Progress</option>
              <option value="resolved" ${r.ticket_status === 'resolved' ? 'selected' : ''}>Resolved</option>
            </select>
          </td>
          <td data-label="Actions"><button class="btn" data-view="${r.id}">View</button></td>
        `;
        tbody.appendChild(tr);
      });

      // Status change handlers
      tbody.querySelectorAll('.statusSel').forEach(sel => {
        sel.addEventListener('change', async (e) => {
          const id = e.target.dataset.id;
          const newStatus = e.target.value;
          e.target.className = `statusSel ${newStatus}`;

          const success = await DataService.updateTicketStatus(id, newStatus);
          if (success) {
            // Update local data
            const response = allResponses.find(r => r.id === id);
            if (response) response.ticket_status = newStatus;
          }
        });
      });

      // View button handlers
      tbody.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', () => showResponseDetail(btn.dataset.view));
      });
    }

    /* ---------- Responses Tab ---------- */
    function paintResponses() {
      const tbody = document.getElementById('responsesBody');
      tbody.innerHTML = '';

      if (filteredResponses.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="empty"><div class="empty-icon">üìã</div>No responses found</div></td></tr>`;
        return;
      }

      filteredResponses.forEach(r => {
        const npsCategory = getNPSCategory(r.q12);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="Date">${formatDate(r.completed_at)}</td>
          <td data-label="Customer">
            <div style="font-weight:600">${r.name || '-'}</div>
            <div style="font-size:11px;color:var(--muted)">${r.email || '-'}</div>
            ${r.phone ? `<div style="font-size:11px;color:var(--muted)">${r.phone}</div>` : ''}
          </td>
          <td data-label="Brand / Branch">${brandBadge(r.brand)}<br><small style="color:var(--muted)">${r.branch || '-'}</small></td>
          <td data-label="Receipt" class="mono">${r.receipt || '-'}</td>
          <td data-label="NPS">${npsBadge(r.q12)}</td>
          <td data-label="Ticket">
            <select class="statusSel ${r.ticket_status || 'open'}" data-id="${r.id}">
              <option value="open" ${r.ticket_status === 'open' || !r.ticket_status ? 'selected' : ''}>Open</option>
              <option value="in_progress" ${r.ticket_status === 'in_progress' ? 'selected' : ''}>In Progress</option>
              <option value="resolved" ${r.ticket_status === 'resolved' ? 'selected' : ''}>Resolved</option>
            </select>
          </td>
          <td data-label="Reward"><span class="status-badge ${r.reward_claimed ? 'claimed' : 'unclaimed'}">${r.reward_claimed ? 'Claimed' : 'Unclaimed'}</span></td>
          <td data-label="Actions"><button class="btn" data-view="${r.id}">View</button></td>
        `;
        tbody.appendChild(tr);
      });

      // Status change handlers
      tbody.querySelectorAll('.statusSel').forEach(sel => {
        sel.addEventListener('change', async (e) => {
          const id = e.target.dataset.id;
          const newStatus = e.target.value;
          e.target.className = `statusSel ${newStatus}`;

          const success = await DataService.updateTicketStatus(id, newStatus);
          if (success) {
            const response = allResponses.find(r => r.id === id);
            if (response) response.ticket_status = newStatus;
          }
        });
      });

      // View button handlers
      tbody.querySelectorAll('[data-view]').forEach(btn => {
        btn.addEventListener('click', () => showResponseDetail(btn.dataset.view));
      });
    }

    // Response filters
    document.getElementById('respApplyFilters')?.addEventListener('click', () => {
      const search = document.getElementById('respFilterSearch').value.toLowerCase();
      const brand = document.getElementById('respFilterBrand').value;
      const npsFilter = document.getElementById('respFilterNps').value;
      const from = document.getElementById('respFilterFrom').value;
      const to = document.getElementById('respFilterTo').value;

      filteredResponses = allResponses.filter(r => {
        if (search) {
          const haystack = [r.name, r.email, r.receipt, r.branch].join(' ').toLowerCase();
          if (!haystack.includes(search)) return false;
        }
        if (brand && r.brand !== brand) return false;
        if (npsFilter) {
          const cat = getNPSCategory(r.q12);
          if (cat !== npsFilter) return false;
        }
        if (from && r.completed_at < from) return false;
        if (to && r.completed_at > to + 'T23:59:59') return false;
        return true;
      });

      paintResponses();
    });

    document.getElementById('respClearFilters')?.addEventListener('click', () => {
      document.getElementById('respFilterSearch').value = '';
      document.getElementById('respFilterBrand').value = '';
      document.getElementById('respFilterNps').value = '';
      document.getElementById('respFilterFrom').value = '';
      document.getElementById('respFilterTo').value = '';
      filteredResponses = [...allResponses];
      paintResponses();
    });

    /* ---------- Validator Tab ---------- */
    let currentValidationResponse = null;

    document.getElementById('validateBtn')?.addEventListener('click', async () => {
      const query = document.getElementById('validatorInput').value.trim();
      const statusEl = document.getElementById('validatorStatus');
      const detailsEl = document.getElementById('validatorDetails');
      const actionsEl = document.getElementById('validatorActions');

      if (!query) {
        statusEl.textContent = 'Please enter a code or receipt number';
        statusEl.className = 'status invalid';
        detailsEl.style.display = 'none';
        actionsEl.style.display = 'none';
        return;
      }

      statusEl.textContent = 'Searching...';
      statusEl.className = 'status';

      const response = await DataService.findByCodeOrReceipt(query);

      if (!response) {
        statusEl.textContent = '‚ùå No matching record found';
        statusEl.className = 'status invalid';
        detailsEl.style.display = 'none';
        actionsEl.style.display = 'none';
        currentValidationResponse = null;
        return;
      }

      currentValidationResponse = response;

      // Populate details
      document.getElementById('valCustomer').textContent = response.name || '-';
      document.getElementById('valNps').innerHTML = npsBadge(response.q12);
      document.getElementById('valReceipt').textContent = response.receipt || '-';
      document.getElementById('valCode').textContent = response.reward_code || '-';
      document.getElementById('valDate').textContent = formatDate(response.completed_at);

      if (response.reward_claimed) {
        statusEl.textContent = '‚ö†Ô∏è Reward Already Claimed';
        statusEl.className = 'status claimed';
        document.getElementById('valRewardStatus').innerHTML = `<span style="color:var(--warn)">Claimed on ${formatDate(response.reward_claimed_at)}</span>`;
        actionsEl.style.display = 'none';
      } else {
        statusEl.textContent = '‚úÖ Valid - Reward Available';
        statusEl.className = 'status valid';
        document.getElementById('valRewardStatus').innerHTML = '<span style="color:var(--ok)">Unclaimed</span>';
        actionsEl.style.display = 'flex';
      }

      detailsEl.style.display = 'block';
    });

    document.getElementById('markRedeemedBtn')?.addEventListener('click', async () => {
      if (!currentValidationResponse) return;

      const btn = document.getElementById('markRedeemedBtn');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      const success = await DataService.markRewardClaimed(currentValidationResponse.id);

      if (success) {
        document.getElementById('validatorStatus').textContent = '‚úÖ Marked as Redeemed!';
        document.getElementById('validatorStatus').className = 'status valid';
        document.getElementById('valRewardStatus').innerHTML = `<span style="color:var(--ok)">Just claimed by ${currentUser?.email}</span>`;
        document.getElementById('validatorActions').style.display = 'none';

        // Update local data
        const response = allResponses.find(r => r.id === currentValidationResponse.id);
        if (response) {
          response.reward_claimed = true;
          response.reward_claimed_at = new Date().toISOString();
          response.reward_claimed_by = currentUser?.email;
        }
      } else {
        btn.disabled = false;
        btn.textContent = 'Mark as Redeemed';
        alert('Failed to mark as redeemed. Please try again.');
      }
    });

    // Enter key for validator
    document.getElementById('validatorInput')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') document.getElementById('validateBtn').click();
    });

    /* ---------- Analytics Tab ---------- */
    function paintAnalytics() {
      // Filter by period
      let periodResponses = allResponses;
      if (analyticsPeriod !== 'all') {
        const cutoff = new Date(Date.now() - analyticsPeriod * 86400000);
        periodResponses = allResponses.filter(r => new Date(r.completed_at) >= cutoff);
      }

      const npsData = DataService.calculateNPS(periodResponses);
      const brandNPS = DataService.calculateBrandNPS(periodResponses);

      // Update KPIs
      const npsEl = document.getElementById('kpiNpsScore');
      npsEl.textContent = npsData.score;
      npsEl.style.color = npsData.score > 0 ? 'var(--ok)' : npsData.score < 0 ? 'var(--bad)' : 'var(--warn)';

      document.getElementById('kpiPromoters').textContent = `${npsData.total ? Math.round((npsData.promoters / npsData.total) * 100) : 0}%`;
      document.getElementById('kpiPassives').textContent = `${npsData.total ? Math.round((npsData.passives / npsData.total) * 100) : 0}%`;
      document.getElementById('kpiDetractorsPct').textContent = `${npsData.total ? Math.round((npsData.detractors / npsData.total) * 100) : 0}%`;
      document.getElementById('kpiTotalResponses').textContent = npsData.total;

      // Destroy existing charts
      Object.values(charts).forEach(chart => chart?.destroy());

      // NPS Category Chart (Doughnut)
      const catCtx = document.getElementById('npsCategoryChart').getContext('2d');
      charts.category = new Chart(catCtx, {
        type: 'doughnut',
        data: {
          labels: ['Promoters (9-10)', 'Passives (7-8)', 'Detractors (0-6)'],
          datasets: [{
            data: [npsData.promoters, npsData.passives, npsData.detractors],
            backgroundColor: ['#0e9a5a', '#ff9d00', '#c41e3a'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // Brand NPS Comparison (Horizontal Bar)
      const brandLabels = Object.keys(brandMeta);
      const brandScores = brandLabels.map(b => brandNPS[b]?.score || 0);
      const brandColors = brandLabels.map(b => brandMeta[b].color);

      const brandCtx = document.getElementById('brandNpsChart').getContext('2d');
      charts.brand = new Chart(brandCtx, {
        type: 'bar',
        data: {
          labels: brandLabels,
          datasets: [{
            label: 'NPS Score',
            data: brandScores,
            backgroundColor: brandColors,
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { min: -100, max: 100, grid: { color: 'rgba(0,0,0,0.05)' } }
          }
        }
      });

      // NPS Trend Over Time (Line)
      const trendData = calculateTrendData(periodResponses);
      const trendCtx = document.getElementById('npsTrendChart').getContext('2d');
      charts.trend = new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: trendData.labels,
          datasets: [{
            label: 'NPS Score',
            data: trendData.scores,
            borderColor: '#85754E',
            backgroundColor: 'rgba(133,117,78,0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { min: -100, max: 100 }
          }
        }
      });

      // Responses by Brand (Bar)
      const brandCounts = brandLabels.map(b => periodResponses.filter(r => r.brand === b).length);
      const respCtx = document.getElementById('brandResponsesChart').getContext('2d');
      charts.responses = new Chart(respCtx, {
        type: 'bar',
        data: {
          labels: brandLabels,
          datasets: [{
            label: 'Responses',
            data: brandCounts,
            backgroundColor: brandColors,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }
        }
      });

      // Detractor comments
      paintDetractorComments(periodResponses);
    }

    function calculateTrendData(responses) {
      const days = analyticsPeriod === 'all' ? 30 : Math.min(analyticsPeriod, 30);
      const labels = [];
      const scores = [];

      for (let i = days - 1; i >= 0; i--) {
        const date = new Date(Date.now() - i * 86400000);
        const dateStr = date.toLocaleDateString('en-PH', { month: 'short', day: 'numeric' });
        labels.push(dateStr);

        const dayStart = new Date(date.setHours(0, 0, 0, 0));
        const dayEnd = new Date(date.setHours(23, 59, 59, 999));

        const dayResponses = responses.filter(r => {
          const d = new Date(r.completed_at);
          return d >= dayStart && d <= dayEnd;
        });

        const nps = DataService.calculateNPS(dayResponses);
        scores.push(dayResponses.length > 0 ? nps.score : null);
      }

      return { labels, scores };
    }

    function paintDetractorComments(responses) {
      const container = document.getElementById('detractorComments');
      const detractors = responses.filter(r => r.q12 <= 6 && r.q12_follow).slice(0, 10);

      if (detractors.length === 0) {
        container.innerHTML = '<div class="empty">No detractor comments in this period</div>';
        return;
      }

      container.innerHTML = detractors.map(r => `
        <div style="padding:12px; border:1px solid var(--line); border-radius:10px; margin-bottom:10px">
          <div style="display:flex; justify-content:space-between; margin-bottom:8px">
            ${brandBadge(r.brand)}
            ${npsBadge(r.q12)}
          </div>
          <p style="font-size:13px; margin:0">"${r.q12_follow}"</p>
          <div style="font-size:11px; color:var(--muted); margin-top:8px">${formatDate(r.completed_at)}</div>
        </div>
      `).join('');
    }

    // Period selector
    document.querySelectorAll('.period-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        analyticsPeriod = btn.dataset.period === 'all' ? 'all' : parseInt(btn.dataset.period);
        paintAnalytics();
      });
    });

    /* ---------- Export Tab ---------- */
    function getExportData() {
      const brand = document.getElementById('exportBrand').value;
      const npsFilter = document.getElementById('exportNps').value;
      const from = document.getElementById('exportFrom').value;
      const to = document.getElementById('exportTo').value;

      return allResponses.filter(r => {
        if (brand && r.brand !== brand) return false;
        if (npsFilter) {
          const cat = getNPSCategory(r.q12);
          if (cat !== npsFilter) return false;
        }
        if (from && r.completed_at < from) return false;
        if (to && r.completed_at > to + 'T23:59:59') return false;
        return true;
      });
    }

    function updateExportPreview() {
      const data = getExportData();
      document.getElementById('exportPreviewCount').textContent = data.length;
    }

    // Update preview on filter change
    ['exportBrand', 'exportNps', 'exportFrom', 'exportTo'].forEach(id => {
      document.getElementById(id)?.addEventListener('change', updateExportPreview);
    });

    document.getElementById('exportExcelBtn')?.addEventListener('click', () => {
      const data = getExportData();
      if (data.length === 0) {
        alert('No data to export');
        return;
      }

      const exportRows = data.map(r => ({
        'Date': formatDate(r.completed_at),
        'Brand': r.brand,
        'Branch': r.branch,
        'Receipt': r.receipt || r.receipt || '-',
        'Customer Name': r.name || '-',
        'Customer Email': r.email || '-',
        'Data Privacy Consent': r.dpa ? 'Yes' : 'No',
        'Promo Consent': r.promo ? 'Yes' : 'No',
        'NPS Score': r.q12,
        'NPS Category': getNPSCategory(r.q12),
        'NPS Feedback': r.q12_follow || '-',
        'First Visit': r.q2 || '-',
        'Visit Frequency': r.q3 || '-',
        'Party Size': r.q4 || '-',
        'Overall Experience': r.q5 || '-',
        'Food Quality': r.q6 || '-',
        'Staff Friendliness': r.q7 || '-',
        'Orders Correct': r.q8 || '-',
        'Value for Money': r.q10 || '-',
        'Service Promptness': r.q11 || '-',
        'Ticket Status': r.ticket_status || 'open',
        'Reward Code': r.reward_code || '-',
        'Reward Claimed': r.reward_claimed ? 'Yes' : 'No',
        'Reward Claimed At': r.reward_claimed_at ? formatDate(r.reward_claimed_at) : '-'
      }));

      const ws = XLSX.utils.json_to_sheet(exportRows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Survey Responses');

      const filename = `survey_export_${new Date().toISOString().slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, filename);
    });

    document.getElementById('exportCsvBtn')?.addEventListener('click', () => {
      const data = getExportData();
      if (data.length === 0) {
        alert('No data to export');
        return;
      }

      const exportRows = data.map(r => ({
        'Date': formatDate(r.completed_at),
        'Brand': r.brand,
        'Branch': r.branch,
        'Receipt': r.receipt || r.receipt || '-',
        'Customer Name': r.name || '-',
        'Customer Email': r.email || '-',
        'Data Privacy Consent': r.dpa ? 'Yes' : 'No',
        'Promo Consent': r.promo ? 'Yes' : 'No',
        'NPS Score': r.q12,
        'NPS Category': getNPSCategory(r.q12),
        'NPS Feedback': r.q12_follow || '-',
        'Ticket Status': r.ticket_status || 'open',
        'Reward Code': r.reward_code || '-',
        'Reward Claimed': r.reward_claimed ? 'Yes' : 'No'
      }));

      const ws = XLSX.utils.json_to_sheet(exportRows);
      const csv = XLSX.utils.sheet_to_csv(ws);

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `survey_export_${new Date().toISOString().slice(0, 10)}.csv`;
      link.click();
    });

    /* ---------- Response Detail Modal ---------- */
    function formatRating(value, max = 5) {
      if (value === null || value === undefined || value === '') return '-';
      return `${value}/${max}`;
    }

    function formatAnswer(value) {
      if (value === null || value === undefined || value === '') return '-';
      return value;
    }

    function showResponseDetail(id) {
      const response = allResponses.find(r => r.id === id);
      if (!response) return;

      document.getElementById('detailSubtitle').textContent = `${response.brand || '-'} - ${response.branch || '-'} | ${formatDate(response.completed_at)}`;

      const content = document.getElementById('responseDetailContent');
      content.innerHTML = `
        <div style="display:grid; gap:16px">
          <!-- Customer Info -->
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
            <div style="padding:12px; background:rgba(0,0,0,0.03); border-radius:8px">
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px">Customer</div>
              <div style="font:700 14px var(--font)">${response.name || '-'}</div>
              <div style="font-size:12px; color:var(--muted)">${response.email || '-'}</div>
              ${response.phone ? `<div style="font-size:12px; color:var(--muted)">${response.phone}</div>` : ''}
            </div>
            <div style="padding:12px; background:rgba(0,0,0,0.03); border-radius:8px">
              <div style="font-size:11px; color:var(--muted); margin-bottom:4px">NPS Score (0-10)</div>
              <div>${npsBadge(response.q12)} <span style="color:var(--muted); font-size:12px">${getNPSCategory(response.q12)}</span></div>
            </div>
          </div>

          <!-- Receipt & Reward -->
          <div style="padding:12px; border:1px solid var(--line); border-radius:8px">
            <div style="font:700 12px var(--font); margin-bottom:8px">Receipt & Reward</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px">
              <div><span style="color:var(--muted)">Receipt:</span> <span class="mono">${response.receipt || response.receipt || '-'}</span></div>
              <div><span style="color:var(--muted)">Reward Code:</span> <span class="mono">${response.reward_code || '-'}</span></div>
              <div><span style="color:var(--muted)">Claimed:</span> ${response.reward_claimed ? 'Yes' : 'No'}</div>
              <div><span style="color:var(--muted)">Ticket Status:</span> ${response.ticket_status || 'open'}</div>
            </div>
          </div>

          <!-- Consent -->
          <div style="padding:12px; border:1px solid var(--line); border-radius:8px">
            <div style="font:700 12px var(--font); margin-bottom:8px">Consent</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px">
              <div><span style="color:var(--muted)">Data Privacy Act:</span> ${response.dpa ? '<span style="color:var(--ok)">Agreed</span>' : '<span style="color:var(--bad)">-</span>'}</div>
              <div><span style="color:var(--muted)">Promo Updates:</span> ${response.promo ? '<span style="color:var(--ok)">Subscribed</span>' : '<span style="color:var(--muted)">-</span>'}</div>
            </div>
          </div>

          ${response.q12_follow ? `
          <!-- NPS Feedback -->
          <div style="padding:12px; border:1px solid var(--line); border-radius:8px; background:rgba(196,30,58,0.03)">
            <div style="font:700 12px var(--font); margin-bottom:8px">NPS Feedback</div>
            <p style="font-size:13px; margin:0">"${response.q12_follow}"</p>
          </div>
          ` : ''}

          <!-- Visit Information -->
          <div style="padding:12px; border:1px solid var(--line); border-radius:8px">
            <div style="font:700 12px var(--font); margin-bottom:12px">Visit Information</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:13px">
              <div><span style="color:var(--muted)">First Visit:</span> ${formatAnswer(response.q2)}</div>
              <div><span style="color:var(--muted)">Visit Frequency:</span> ${formatAnswer(response.q3)}</div>
              <div><span style="color:var(--muted)">Party Size:</span> ${formatAnswer(response.q4)}</div>
            </div>
          </div>

          <!-- Ratings (1-5 scale) -->
          <div style="padding:12px; border:1px solid var(--line); border-radius:8px">
            <div style="font:700 12px var(--font); margin-bottom:12px">Ratings (1-5 scale)</div>
            <div style="display:grid; gap:8px; font-size:13px">
              <div style="display:flex; justify-content:space-between"><span style="color:var(--muted)">Overall Experience</span> <strong>${formatRating(response.q5)}</strong></div>
              <div style="display:flex; justify-content:space-between"><span style="color:var(--muted)">Food Quality</span> <strong>${formatRating(response.q6)}</strong></div>
              <div style="display:flex; justify-content:space-between"><span style="color:var(--muted)">Staff Friendliness</span> <strong>${formatRating(response.q7)}</strong></div>
              <div style="display:flex; justify-content:space-between"><span style="color:var(--muted)">Orders Correct</span> <strong>${formatRating(response.q8)}</strong></div>
              <div style="display:flex; justify-content:space-between"><span style="color:var(--muted)">Value for Money</span> <strong>${formatRating(response.q10)}</strong></div>
              <div style="display:flex; justify-content:space-between"><span style="color:var(--muted)">Service Promptness</span> <strong>${formatRating(response.q11)}</strong></div>
            </div>
          </div>

          <!-- Additional Feedback -->
          ${(response.q13 || response.q14 || response.q15 || response.q16 || response.q17 || response.q18) ? `
          <div style="padding:12px; border:1px solid var(--line); border-radius:8px">
            <div style="font:700 12px var(--font); margin-bottom:12px">Additional Feedback</div>
            <div style="display:grid; gap:8px; font-size:13px">
              ${response.q13 ? `<div><span style="color:var(--muted)">Q13:</span> ${response.q13}</div>` : ''}
              ${response.q14 ? `<div><span style="color:var(--muted)">Q14:</span> ${response.q14}</div>` : ''}
              ${response.q15 ? `<div><span style="color:var(--muted)">Q15:</span> ${response.q15}</div>` : ''}
              ${response.q16 ? `<div><span style="color:var(--muted)">Q16:</span> ${response.q16}</div>` : ''}
              ${response.q17 ? `<div><span style="color:var(--muted)">Q17:</span> ${response.q17}</div>` : ''}
              ${response.q18 ? `<div><span style="color:var(--muted)">Q18:</span> ${response.q18}</div>` : ''}
            </div>
          </div>
          ` : ''}
        </div>
      `;

      document.getElementById('responseDetailModal').classList.add('visible');
    }

    document.getElementById('closeDetailBtn')?.addEventListener('click', () => {
      document.getElementById('responseDetailModal').classList.remove('visible');
    });

    document.getElementById('responseDetailModal')?.addEventListener('click', (e) => {
      if (e.target === document.getElementById('responseDetailModal')) {
        document.getElementById('responseDetailModal').classList.remove('visible');
      }
    });

    /* ---------- Session Verification ---------- */
    async function checkExistingSession() {
      const token = localStorage.getItem('admin_token');
      const storedUser = localStorage.getItem('admin_user');

      // No token or user stored - show login
      if (!token || !storedUser) {
        localStorage.removeItem('admin_token');
        localStorage.removeItem('admin_user');
        showLogin();
        return;
      }

      try {
        // Verify the token with the server
        const response = await fetch(`${SUPABASE_URL}/functions/v1/admin-auth/verify`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'apikey': SUPABASE_ANON_KEY
          },
          body: JSON.stringify({})
        });

        // Check if response is OK and parse JSON
        if (!response.ok) {
          console.log('Session verification failed with status:', response.status);
          throw new Error('Verification failed');
        }

        const data = await response.json();

        // Strictly check that valid is true and user exists
        if (data.valid === true && data.user && data.user.email) {
          currentUser = data.user;
          showApp();
          return;
        } else {
          console.log('Session verification returned invalid:', data);
          throw new Error('Invalid session data');
        }
      } catch (err) {
        console.error('Session verification failed:', err);
        // Clear invalid session data
        localStorage.removeItem('admin_token');
        localStorage.removeItem('admin_user');
        showLogin();
      }
    }

    /* ---------- Keyboard Shortcuts ---------- */
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.getElementById('profileModal').classList.remove('visible');
        document.getElementById('responseDetailModal').classList.remove('visible');
      }
    });

    /* ---------- Force Logout via URL ---------- */
    // Add ?logout to URL to force clear session (e.g., admin.html?logout)
    function checkForceLogout() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('logout')) {
        localStorage.removeItem('admin_token');
        localStorage.removeItem('admin_user');
        // Remove the ?logout from URL
        window.history.replaceState({}, document.title, window.location.pathname);
        return true;
      }
      return false;
    }

    /* ---------- Boot ---------- */
    // Check if force logout requested
    if (checkForceLogout()) {
      showLogin();
    } else {
      checkExistingSession();
    }
  </script>
</body>
</html>
